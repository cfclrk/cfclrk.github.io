<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Multiple GitHub Accounts</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/static/main.css" />
</head>
<body>
<div id="preamble" class="status">
<nav id="navbar" class="cf">
  <ul class="cf">
    <li class="fl">
      <a href="/">cfclrk</a>
    </li>
    <li class="fr">
      <a href="/articles/home.html">Articles</a>
    </li>
    <li class="fr">
      <a href="/notes/home.html">Notes</a>
    </li>
	<li class="fr">
      <a href="/cloudformation/home.html">CloudFormation</a>
    </li>
  </ul>
</nav>
</div>
<div id="content">
<header>
<h1 class="title">Multiple GitHub Accounts</h1>
</header><nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org5561ff3">The git config</a>
<ul>
<li><a href="#orgd0a2f03">Background: Git URL rewriting</a></li>
<li><a href="#org4b8a1bb">Background: Git config loading</a></li>
</ul>
</li>
<li><a href="#the-ssh-config">The SSH Config</a></li>
<li><a href="#orge6b0caf">SSH passphrases and ssh-agent</a></li>
<li><a href="#signed-commits">Signed Commits</a></li>
<li><a href="#orgad4d6e9">Emacs: Configuring Forge</a></li>
<li><a href="#org0576f25">Resources</a></li>
</ul>
</div>
</nav>
<p>
<b><i>The Problem</i></b>: You have multiple GitHub accounts, and you want to git to
automatically use a particular account depending on what directory a project is
in.
</p>

<p>
In this article I'll use two GitHub accounts as an example: <b>work</b> and <b>home</b>
(but the idea supports any number of accounts). You'd like to use your <i>home</i>
account for personal projects and your <i>work</i> account for work. Here we set
things up so that:
</p>

<ul class="org-ul">
<li>Projects in <code>~/work/...</code> use the <b>work</b> GitHub account</li>
<li>Projects located anywhere else use the <b>home</b> GitHub account</li>
</ul>

<p>
This is all just git and ssh configuration; no editor-specific configuration
should be required (since editors should be shelling out to git anyway).
</p>

<div id="outline-container-org5561ff3" class="outline-2">
<h2 id="org5561ff3"><a href="#org5561ff3">The git config</a></h2>
<div class="outline-text-2" id="text-org5561ff3">
<p>
The git configuration must do two things:
</p>

<ol class="org-ol">
<li>Tell git to use a different configuration depending on the directory a
project is in. Git supports this with the <a href="https://git-scm.com/docs/git-config#_conditional_includes">includeIf</a> directive.</li>
<li>Perform git URL-rewriting with <a href="https://git-scm.com/docs/git-config#Documentation/git-config.txt-urlltbasegtinsteadOf">insteadOf</a>, which allows SSH to make a
distinction between the two accounts.</li>
</ol>

<p>
First, tell git to use a particular configuration depending on the directory a
project is in.
</p>

<p>
File: <code>~/.config/git/config</code>
</p>

<div class="org-src-container">
<pre class="src src-gitconfig">[<span style="color: #ECBE7B;">user</span>]
    <span style="color: #dcaeea;">name</span> = Chris Clark
[<span style="color: #ECBE7B;">includeIf</span> <span style="color: #c678dd;">"gitdir:~/work/"</span>]
    <span style="color: #dcaeea;">path</span> = work.gitconfig
[<span style="color: #ECBE7B;">includeIf</span> <span style="color: #c678dd;">"gitdir:/"</span>]
    <span style="color: #dcaeea;">path</span> = home.gitconfig
</pre>
</div>

<p>
Then, we create a new git config file for each GitHub account. In each file,
specify your email address, GitHub username, and a url-rewriting <a href="https://git-scm.com/docs/git-config#Documentation/git-config.txt-urlltbasegtinsteadOf">insteadOf</a>
line which modifies the base URL that git and SSH see.
</p>

<p>
File: <code>~/.config/git/work.gitconfig</code>
</p>

<div class="org-src-container">
<pre class="src src-gitconfig">[<span style="color: #ECBE7B;">user</span>]
    <span style="color: #dcaeea;">email</span> = cfclrk@work.com
[<span style="color: #ECBE7B;">github</span>]
    <span style="color: #dcaeea;">user</span> = cfclrk-work
[<span style="color: #ECBE7B;">url</span> <span style="color: #c678dd;">"git@github-work"</span>]
    <span style="color: #dcaeea;">insteadOf</span> = git@github.com
[<span style="color: #ECBE7B;">url</span> <span style="color: #c678dd;">"git@gist-work"</span>]
    <span style="color: #dcaeea;">insteadOf</span> = git@gist.github.com
</pre>
</div>

<p>
File: <code>~/.config/git/config-home</code>
</p>

<div class="org-src-container">
<pre class="src src-gitconfig">[<span style="color: #ECBE7B;">user</span>]
    <span style="color: #dcaeea;">email</span> = cfclrk@gmail.com
[<span style="color: #ECBE7B;">github</span>]
    <span style="color: #dcaeea;">user</span> = cfclrk
[<span style="color: #ECBE7B;">url</span> <span style="color: #c678dd;">"git@github-home"</span>]
    <span style="color: #dcaeea;">insteadOf</span> = git@github.com
[<span style="color: #ECBE7B;">url</span> <span style="color: #c678dd;">"git@gist-home"</span>]
    <span style="color: #dcaeea;">insteadOf</span> = git@gist.github.com
</pre>
</div>

<p>
That's it for the git config! The rest of this section elaborates on this
config, if you are interested.
</p>
</div>

<div id="outline-container-orgd0a2f03" class="outline-3">
<h3 id="orgd0a2f03"><a href="#orgd0a2f03">Background: Git URL rewriting</a></h3>
<div class="outline-text-3" id="text-orgd0a2f03">
<p>
To take a closer look at what this part of <i>home.gitconfig</i> means:
</p>

<div class="org-src-container">
<pre class="src src-gitconfig">[<span style="color: #ECBE7B;">url</span> <span style="color: #c678dd;">"git@github-home"</span>]
    <span style="color: #dcaeea;">insteadOf</span> = git@github.com
</pre>
</div>

<p>
Here I've said: "Mr. Git, any time you see a URL that starts with
<code>git@github.com</code>, please just pretend like the URL actually starts with
<code>git@github-home</code>".
</p>

<p>
For example, let's see what git thinks about the repository where I'm writing
<a href="https://github.com/cfclrk/articles">this article</a>. If I just <code>cat</code> the git config file in my local <i>articles</i>
repo, I see the real remote URL:
</p>

<div class="org-src-container">
<pre class="src src-bash">cat .git/config | grep <span style="color: #98be65;">"\[remote"</span> -A 2
</pre>
</div>

<pre class="example">
[remote "origin"]
	url = git@github.com:cfclrk/articles.git
	fetch = +refs/heads/*:refs/remotes/origin/*
</pre>


<p>
But when I use the <code>git remote</code> command line to view that value, I see this:
</p>

<div class="org-src-container">
<pre class="src src-bash">git remote -v
</pre>
</div>

<pre class="example">
origin	git@github-home:cfclrk/articles.git (fetch)
origin	git@github-home:cfclrk/articles.git (push)
</pre>


<p>
We can see that <code>git remote</code> shows the rewritten URL. Git performs the
url-rewriting at a really low level, so all git commands see the rewritten
form.
</p>

<p>
The value I chose &#x2013; in this case "github-home" &#x2013; could have been anything
(well, anything without spaces, etc). It doesn't matter so much <i>what</i> the
value is, it just matters that you use the <i>same</i> value in your git config
and in your SSH config (as explained in the section <a href="#the-ssh-config">The SSH Config</a>).
</p>
</div>
</div>

<div id="outline-container-org4b8a1bb" class="outline-3">
<h3 id="org4b8a1bb"><a href="#org4b8a1bb">Background: Git config loading</a></h3>
<div class="outline-text-3" id="text-org4b8a1bb">
<p>
Git loads <i>all</i> applicable config files, and greedily uses the first value it
finds for each option.
</p>

<p>
For example: say you have the git config specified above, and you are
currently in a git repository located at <code>~/work/projectA/</code>. Git first loads
the <code>~/.config/git/config</code> file and expands all of the <code>[includeIf]</code>
statements.
</p>

<ul class="org-ul">
<li>Does <code>[includeIf "gitdir:~/work/"]</code> apply?
<ul class="org-ul">
<li>Yes, so load <code>work.gitconfig</code></li>
</ul></li>
<li>Does <code>[includeIf "gitdir:/"]</code> apply?
<ul class="org-ul">
<li>Yes, so load <code>home.gitconfig</code></li>
</ul></li>
</ul>

<p>
Notice that <b>both</b> the <code>work.gitconfig</code> and <code>home.gitconfig</code> are loaded, but
obviously <code>user.email</code> can only be set to one value. In this case, the email
address will be set to <code>cfclrk@work.com</code> since that was the <i>first</i> value
loaded for the <code>user.email</code> option.
</p>

<p>
When you load multiple extra git config files using the <code>includeIf</code> directive,
you must specify the files in order from <i>most specific</i> to <i>least specific</i>.
</p>

<p>
A fun little aside: That email address that you specify as the value of
<code>user.email</code> is the only piece of information GitHub uses when determining who
authored a commit(!) You can set that email address to anything! Set it to
<code>torvalds@linux-foundation.org</code>, and GitHub will happily put Linus Torvalds'
picture next to your git commits. And to be sure, <a href="https://news.ycombinator.com/item?id=10005577">that happens</a>. In the section
on <a href="#signed-commits">Signed Commits</a> I show how to mitigate this problem a little bit.
</p>
</div>
</div>
</div>

<div id="outline-container-the-ssh-config" class="outline-2">
<h2 id="the-ssh-config"><a href="#the-ssh-config">The SSH Config</a></h2>
<div class="outline-text-2" id="text-the-ssh-config">
<p>
Assuming you use the <code>git</code> protocol (which uses SSH under the covers) and not
<code>https</code> like some kind of animal, you have two SSH keys for GitHub &#x2013; one for
each GitHub account (GitHub will not allow you to use the same SSH key for both
accounts, I've tried). Assuming you've <a href="https://docs.github.com/en/github/authenticating-to-github/connecting-to-github-with-ssh">created</a> those, your <code>~/.ssh</code> directory
looks something like:
</p>

<pre class="example" id="org03c370c">
$ tree ~/.ssh/
/Users/cfclrk/.ssh/
├── config
├── github-home
├── github-home.pub
├── github-work
└── github-work.pub
</pre>

<p>
The <code>~/.ssh/config</code> allows you to specify which SSH key should be used for
particular DNS domains. And <i>this</i> is where the URL-rewriting stuff comes in
to play! We can tell SSH to use one key for <code>github-home</code>, and another key for
<code>github-work</code>.
</p>

<p>
File: <code>~/.ssh/config</code>
</p>

<div class="org-src-container">
<pre class="src src-conf">Host github-home
    HostName       github.com
    User           git
    IdentityFile   ~/.ssh/github-home
    IdentitiesOnly yes

Host github-work
    HostName       github.com
    User           git
    IdentityFile   ~/.ssh/github-work
    IdentitiesOnly yes

Host gist-home
    HostName       gist.github.com
    User           git
    IdentityFile   ~/.ssh/github-home
    IdentitiesOnly yes

Host gist-work
    HostName       gist.github.com
    User           git
    IdentityFile   ~/.ssh/github-work
    IdentitiesOnly yes
</pre>
</div>
</div>
</div>

<div id="outline-container-orge6b0caf" class="outline-2">
<h2 id="orge6b0caf"><a href="#orge6b0caf">SSH passphrases and ssh-agent</a></h2>
</div>

<div id="outline-container-signed-commits" class="outline-2">
<h2 id="signed-commits"><a href="#signed-commits">Signed Commits</a></h2>
<div class="outline-text-2" id="text-signed-commits">
<p>
In the section on git configuration, I mentioned how trivial it is to make git
commits associated with someone else's GitHub account. To somewhat address
this, GitHub now allows you to upload a PGP key to your GitHub account, and
GitHub displays a "Verified" badge on commits that are signed with a PGP key
that matches the email address associated with the commit.
</p>

<p>
Setting up PGP key signing with one GitHub account isn't too bad, but I didn't
see an obvious way sign commits with different keys depending on what the git
configuration of a project is.
</p>

<p>
It would be super next-level if you find a simple way to automatically sign
commits with the right PGP key when using multiple GitHub accounts. If you've
got a cool setup that does that, let me know!
</p>
</div>
</div>

<div id="outline-container-orgad4d6e9" class="outline-2">
<h2 id="orgad4d6e9"><a href="#orgad4d6e9">Emacs: Configuring Forge</a></h2>
<div class="outline-text-2" id="text-orgad4d6e9">
<p>
Need to update <code>forge-alist</code>
</p>
</div>
</div>

<div id="outline-container-org0576f25" class="outline-2">
<h2 id="org0576f25"><a href="#org0576f25">Resources</a></h2>
<div class="outline-text-2" id="text-org0576f25">
<p>
<a href="https://yayimorphology.org/ssh-identities-made-easy.html">https://yayimorphology.org/ssh-identities-made-easy.html</a>
</p>
</div>
</div>
</div>
</body>
</html>
