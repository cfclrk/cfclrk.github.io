<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bash</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/static/main.css" />
</head>
<body>
<div id="preamble" class="status">
<nav id="navbar" class="cf">
  <ul class="cf">
    <li class="fl">
      <a href="/">cfclrk</a>
    </li>
    <li class="fr">
      <a href="/articles/home.html">Articles</a>
    </li>
    <li class="fr">
      <a href="/notes/home.html">Notes</a>
    </li>
	<li class="fr">
      <a href="/cloudformation/home.html">CloudFormation</a>
    </li>
  </ul>
</nav>
</div>
<div id="content" class="content">
<header>
<h1 class="title">Bash</h1>
</header><nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org9c1e935">Style</a></li>
<li><a href="#orge24f72c">Function Parameters</a>
<ul>
<li><a href="#org9f64100">test</a></li>
<li><a href="#org97abf0e">new-test</a></li>
<li><a href="#orgf4e1813">if-else</a></li>
</ul>
</li>
<li><a href="#orge17fcc5">Script Arguments</a></li>
<li><a href="#orgd9b2701">Script Options</a>
<ul>
<li><a href="#org235734d">getopts</a></li>
</ul>
</li>
<li><a href="#orgf2f92d1">Heredocs</a>
<ul>
<li><a href="#org14ccab3">Interpolation</a>
<ul>
<li><a href="#org8d68b45">with interpolation</a></li>
<li><a href="#org1ba94c0">without interpolation</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org08404e5">Verify environment variables</a></li>
<li><a href="#org80c962f">Parameter Expansion</a>
<ul>
<li><a href="#org56e98a3">Resources</a></li>
<li><a href="#org3c26f21">Example</a></li>
</ul>
</li>
<li><a href="#org36e6ea8">Range</a></li>
<li><a href="#org604713f">Arrays</a>
<ul>
<li><a href="#org7732e67">Basic</a></li>
<li><a href="#org5a8ad2c">Length</a></li>
<li><a href="#orgb105997">Pipe Array to <code>xargs</code></a></li>
</ul>
</li>
</ul>
</div>
</nav>

<div id="outline-container-org9c1e935" class="outline-2">
<h2 id="org9c1e935"><a href="#org9c1e935">Style</a></h2>
<div class="outline-text-2" id="text-org9c1e935">
<p>
See the <a href="https://github.com/azet/community_bash_style_guide">Bash style guide</a>.
</p>
</div>
</div>

<div id="outline-container-orge24f72c" class="outline-2">
<h2 id="orge24f72c"><a href="#orge24f72c">Function Parameters</a></h2>
<div class="outline-text-2" id="text-orge24f72c">
<p>
For more info, see <a href="http://mywiki.wooledge.org/BashFAQ/031">FAQ</a>: "What is the difference between test, [ and [[ ?"
</p>

<p>
If there is an error, the function should return a non-zero code. Only functions
can return; if outside of a function, use "exit 1". See:
<a href="https://stackoverflow.com/questions/4419952/difference-between-return-and-exit-in-bash-functions">https://stackoverflow.com/questions/4419952/difference-between-return-and-exit-in-bash-functions</a>
</p>
</div>

<div id="outline-container-org9f64100" class="outline-3">
<h3 id="org9f64100"><a href="#org9f64100">test</a></h3>
<div class="outline-text-3" id="text-org9f64100">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #c678dd;">foo</span>() {
    <span style="color: #dcaeea;">a</span>=${<span style="color: #dcaeea;">1</span>-}
    <span style="color: #c678dd;">test</span> -n <span style="color: #98be65;">"$a"</span> || {
        <span style="color: #c678dd;">echo</span> <span style="color: #98be65;">"Error: a is required"</span>
        <span style="color: #51afef;">return</span> 1
    }
}
</pre>
</div>

<p>
Note that <code>[</code> <code>]</code> is an alias for <code>test</code>, so the same thing can be written
as:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #c678dd;">foo</span>() {
    [ -n <span style="color: #98be65;">"$1"</span> ] || {
        <span style="color: #c678dd;">echo</span> <span style="color: #98be65;">"Error: param 1 is zero-length"</span>
        <span style="color: #51afef;">return</span> 1
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org97abf0e" class="outline-3">
<h3 id="org97abf0e"><a href="#org97abf0e">new-test</a></h3>
<div class="outline-text-3" id="text-org97abf0e">
<p>
The double-bracket <code>[[</code> syntax is called "new-test" and can also be used.
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #c678dd;">foo</span>() {
    [[ -n <span style="color: #98be65;">"$1"</span> ]] || {
        <span style="color: #c678dd;">echo</span> <span style="color: #98be65;">"Error: param 1 is zero-length"</span>
        <span style="color: #51afef;">return</span> 1
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf4e1813" class="outline-3">
<h3 id="orgf4e1813"><a href="#orgf4e1813">if-else</a></h3>
<div class="outline-text-3" id="text-orgf4e1813">
<p>
Can do same thing as for script arguments, but
</p>

<ul class="org-ul">
<li>Use a <code>return</code> instead of an <code>exit</code></li>
<li>Make the variable local</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #c678dd;">func</span>() {
    <span style="color: #51afef;">if</span> [ -z ${<span style="color: #dcaeea;">1</span>+x} ]; <span style="color: #51afef;">then</span>
        <span style="color: #c678dd;">echo</span> <span style="color: #98be65;">"arg 1 (a) is required"</span>
        <span style="color: #51afef;">return</span> 1
    <span style="color: #51afef;">else</span>
        local <span style="color: #dcaeea;">a</span>=$<span style="color: #dcaeea;">1</span>
    <span style="color: #51afef;">fi</span>
    <span style="color: #c678dd;">echo</span> <span style="color: #98be65;">"a is '$a'"</span>
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orge17fcc5" class="outline-2">
<h2 id="orge17fcc5"><a href="#orge17fcc5">Script Arguments</a></h2>
<div class="outline-text-2" id="text-orge17fcc5">
<p>
Same patterns as function parameters can be used.
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #51afef;">if</span> [ -z ${<span style="color: #dcaeea;">1</span>+x} ]; <span style="color: #51afef;">then</span>
    <span style="color: #c678dd;">echo</span> <span style="color: #98be65;">"arg 1 (foo) is required"</span>
    <span style="color: #51afef;">exit</span> 1
<span style="color: #51afef;">fi</span>
<span style="color: #dcaeea;">foo</span>=$<span style="color: #dcaeea;">1</span>
<span style="color: #c678dd;">echo</span> <span style="color: #98be65;">"foo is: '$foo'"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd9b2701" class="outline-2">
<h2 id="orgd9b2701"><a href="#orgd9b2701">Script Options</a></h2>
<div class="outline-text-2" id="text-orgd9b2701">
</div>
<div id="outline-container-org235734d" class="outline-3">
<h3 id="org235734d"><a href="#org235734d">getopts</a></h3>
<div class="outline-text-3" id="text-org235734d">
<p>
See home/bin/ssm script for a good example.
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #c678dd;">showHelp</span>() {
    cat &lt;&lt;END
<span style="color: #98be65;">Usage: $(basename "$0") [-p profile]</span>
<span style="color: #98be65;">END</span>
}

<span style="color: #51afef;">while </span><span style="color: #c678dd;">getopts</span> :hp: arg; <span style="color: #51afef;">do</span>
    <span style="color: #51afef;">case</span> ${<span style="color: #dcaeea;">arg</span>} <span style="color: #51afef;">in</span>
        h)
            showHelp
            <span style="color: #51afef;">exit</span> 0
            ;;
        p)
            <span style="color: #dcaeea;">profile</span>=<span style="color: #98be65;">"$OPTARG"</span>
            ;;
        <span style="color: #98be65;">\?</span>)
            <span style="color: #c678dd;">echo</span> <span style="color: #98be65;">"Invalid option: -$OPTARG"</span> &gt;&amp;2
            <span style="color: #51afef;">exit</span> 1
            ;;
        :)
            <span style="color: #c678dd;">echo</span> <span style="color: #98be65;">"Option -$OPTARG requires an argument"</span> &gt;&amp;2
            <span style="color: #51afef;">exit</span> 1
            ;;
    <span style="color: #51afef;">esac</span>
<span style="color: #51afef;">done</span>
<span style="color: #c678dd;">shift</span> $((OPTIND -1))

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Define default option values</span>
<span style="color: #dcaeea;">profile</span>=${<span style="color: #dcaeea;">profile</span>:=<span style="color: #98be65;">"chrisc"</span>}

<span style="color: #dcaeea;">aws</span>=<span style="color: #98be65;">"aws --profile $profile --region us-east-1"</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf2f92d1" class="outline-2">
<h2 id="orgf2f92d1"><a href="#orgf2f92d1">Heredocs</a></h2>
<div class="outline-text-2" id="text-orgf2f92d1">
</div>
<div id="outline-container-org14ccab3" class="outline-3">
<h3 id="org14ccab3"><a href="#org14ccab3">Interpolation</a></h3>
<div class="outline-text-3" id="text-org14ccab3">
<p>
A heredoc can interpolate variable names to values, or the whole heredoc can
be taken completely literally without any interpolation. The difference is
whether the limit string has single quotes around it.
</p>
</div>

<div id="outline-container-org8d68b45" class="outline-4">
<h4 id="org8d68b45"><a href="#org8d68b45">with interpolation</a></h4>
<div class="outline-text-4" id="text-org8d68b45">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #dcaeea;">foo</span>=<span style="color: #98be65;">"bar"</span>
<span style="color: #dcaeea;">a</span>=$(cat &lt;&lt;EOF
<span style="color: #98be65;">hello</span>
<span style="color: #98be65;">$foo</span>
<span style="color: #98be65;">EOF</span>
)
<span style="color: #c678dd;">echo</span> <span style="color: #98be65;">"$a"</span>
</pre>
</div>

<pre class="example">
hello
bar
</pre>
</div>
</div>

<div id="outline-container-org1ba94c0" class="outline-4">
<h4 id="org1ba94c0"><a href="#org1ba94c0">without interpolation</a></h4>
<div class="outline-text-4" id="text-org1ba94c0">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #dcaeea;">foo</span>=<span style="color: #98be65;">"bar"</span>
<span style="color: #dcaeea;">a</span>=$(cat &lt;&lt;<span style="color: #98be65;">'EOF'</span>
<span style="color: #98be65;">hello</span>
<span style="color: #98be65;">$foo</span>
<span style="color: #98be65;">EOF</span>
)
<span style="color: #c678dd;">echo</span> <span style="color: #98be65;">"$a"</span>
</pre>
</div>

<pre class="example">
hello
$foo
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org08404e5" class="outline-2">
<h2 id="org08404e5"><a href="#org08404e5">Verify environment variables</a></h2>
<div class="outline-text-2" id="text-org08404e5">
<p>
Verify some environment variables exist.
</p>

<div class="org-src-container">
<pre class="src src-sh">: <span style="color: #98be65;">"${ARTIFACTORY_USER:?ARTIFACTORY_USER is not set}"</span>
: <span style="color: #98be65;">"${ARTIFACTORY_PASSWORD:?ARTIFACTORY_PASSWORD is not set}"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org80c962f" class="outline-2">
<h2 id="org80c962f"><a href="#org80c962f">Parameter Expansion</a></h2>
<div class="outline-text-2" id="text-org80c962f">
</div>
<div id="outline-container-org56e98a3" class="outline-3">
<h3 id="org56e98a3"><a href="#org56e98a3">Resources</a></h3>
<div class="outline-text-3" id="text-org56e98a3">
<ul class="org-ul">
<li>GNU <a href="https://www.gnu.org/savannah-checkouts/gnu/bash/manual/">Bash docs</a> section on <a href="https://www.gnu.org/software/bash/manual/bashref.html#Shell-Parameter-Expansion">paremeter expansion</a></li>
<li><i>The Open Group</i> has some excellent <a href="https://pubs.opengroup.org/onlinepubs/9699919799">POSIX documentation</a> with a section on
<a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/V3_chap02.html#tag_18_06_02">parameter expansion</a></li>
</ul>
</div>
</div>

<div id="outline-container-org3c26f21" class="outline-3">
<h3 id="org3c26f21"><a href="#org3c26f21">Example</a></h3>
<div class="outline-text-3" id="text-org3c26f21">
<p>
Just digging into this example: <a href="https://stackoverflow.com/a/13864829/340613">https://stackoverflow.com/a/13864829/340613</a>
</p>

<p>
<a href="https://pubs.opengroup.org/onlinepubs/9699919799/utilities/V3_chap02.html#tag_18_06_02">Docs</a> for the <code>+</code> parameter expansion:
</p>

<p>
<code>${parameter:+[word]}</code>
</p>

<blockquote>
<p>
If <i>parameter</i> is unset or null, null shall be substituted; otherwise, the
expansion of <i>word</i> (or an empty string if <i>word</i> is omitted) shall be
substituted.
</p>
</blockquote>

<p>
<code>-z</code> is a <a href="https://tldp.org/LDP/abs/html/comparison-ops.html">comparison operator</a> that tests if the argument is null or empty.
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #dcaeea;">var</span>=<span style="color: #98be65;">""</span>
<span style="color: #51afef;">if</span> [ -z ${<span style="color: #dcaeea;">var</span>+x} ]; <span style="color: #51afef;">then</span>
    <span style="color: #c678dd;">echo</span> <span style="color: #98be65;">"var is unset"</span>
<span style="color: #51afef;">else</span>
    <span style="color: #c678dd;">echo</span> <span style="color: #98be65;">"var is set to '$var'"</span>
<span style="color: #51afef;">fi</span>
</pre>
</div>

<pre class="example">
var is set to ''
</pre>


<p>
In this case, var is the empty string, which is not "unset or null".
Therefore the <code>+</code> parameter expansion expands this to <code>x</code> (which passes the
<code>-z</code> check).
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #51afef;">if</span> [ -z ${<span style="color: #dcaeea;">var</span>+x} ]; <span style="color: #51afef;">then</span>
    <span style="color: #c678dd;">echo</span> <span style="color: #98be65;">"var is unset"</span>
<span style="color: #51afef;">else</span>
    <span style="color: #c678dd;">echo</span> <span style="color: #98be65;">"var is set to '$var'"</span>
<span style="color: #51afef;">fi</span>
</pre>
</div>

<pre class="example">
var is unset
</pre>


<p>
In this case, <code>var</code> has not been declared, so it is "unset or null". The <code>+</code>
parameter expansion expands it to <code>null</code>.
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #dcaeea;">var</span>=<span style="color: #98be65;">""</span>
<span style="color: #51afef;">if</span> [ -z ${<span style="color: #dcaeea;">var</span>+} ]; <span style="color: #51afef;">then</span>
    <span style="color: #c678dd;">echo</span> <span style="color: #98be65;">"var is unset"</span>
<span style="color: #51afef;">else</span>
    <span style="color: #c678dd;">echo</span> <span style="color: #98be65;">"var is set to '$var'"</span>
<span style="color: #51afef;">fi</span>
</pre>
</div>

<pre class="example">
var is unset
</pre>


<p>
In this case we leave the <code>word</code> spot empty in the parameter expansion, so if
<code>var</code> is empty, it is subsituted by an empty string. Now the <code>-z</code> test sees an
empty argument, and this prints out <code>var is unset</code>.
</p>
</div>
</div>
</div>

<div id="outline-container-org36e6ea8" class="outline-2">
<h2 id="org36e6ea8"><a href="#org36e6ea8">Range</a></h2>
<div class="outline-text-2" id="text-org36e6ea8">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #51afef;">for</span> i<span style="color: #51afef;"> in</span> {1..5}; <span style="color: #51afef;">do</span>
    <span style="color: #c678dd;">echo</span> $<span style="color: #dcaeea;">i</span>
<span style="color: #51afef;">done</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org604713f" class="outline-2">
<h2 id="org604713f"><a href="#org604713f">Arrays</a></h2>
<div class="outline-text-2" id="text-org604713f">
</div>
<div id="outline-container-org7732e67" class="outline-3">
<h3 id="org7732e67"><a href="#org7732e67">Basic</a></h3>
<div class="outline-text-3" id="text-org7732e67">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #dcaeea;">arr</span>=(<span style="color: #98be65;">"foo"</span> <span style="color: #98be65;">"bar"</span> <span style="color: #98be65;">"baz"</span>)
<span style="color: #c678dd;">echo</span> ${<span style="color: #dcaeea;">arr</span>[*]}
</pre>
</div>

<pre class="example">
foo bar baz
</pre>
</div>
</div>

<div id="outline-container-org5a8ad2c" class="outline-3">
<h3 id="org5a8ad2c"><a href="#org5a8ad2c">Length</a></h3>
<div class="outline-text-3" id="text-org5a8ad2c">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #dcaeea;">arr</span>=(<span style="color: #98be65;">"foo"</span> <span style="color: #98be65;">"bar"</span> <span style="color: #98be65;">"baz"</span>)
<span style="color: #c678dd;">echo</span> ${#<span style="color: #dcaeea;">arr</span>[*]}
</pre>
</div>

<pre class="example">
3
</pre>
</div>
</div>

<div id="outline-container-orgb105997" class="outline-3">
<h3 id="orgb105997"><a href="#orgb105997">Pipe Array to <code>xargs</code></a></h3>
<div class="outline-text-3" id="text-orgb105997">
<p>
Start a subprocess per element in an array, where each subprocess runs <code>$script</code>.
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #dcaeea;">script</span>=$(cat &lt;&lt;<span style="color: #98be65;">"EOF"</span>
<span style="color: #98be65;">echo {}</span>
<span style="color: #98be65;">EOF</span>
)
<span style="color: #dcaeea;">arr</span>=(<span style="color: #98be65;">"foo"</span> <span style="color: #98be65;">"bar"</span> <span style="color: #98be65;">"baz"</span>)
<span style="color: #c678dd;">echo</span> ${<span style="color: #dcaeea;">arr</span>[*]} | xargs -n 1 -P ${#<span style="color: #dcaeea;">arr</span>[*]} -I {} bash -c <span style="color: #98be65;">"$script"</span>
</pre>
</div>

<pre class="example">
foo
bar
baz
</pre>
</div>
</div>
</div>
</div>
</body>
</html>
