<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Docker</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/static/main.css" />
</head>
<body>
<div id="preamble" class="status">
<nav id="navbar" class="cf">
  <ul class="cf">
    <li class="fl">
      <a href="/">cfclrk</a>
    </li>
    <li class="fr">
      <a href="/articles/home.html">Articles</a>
    </li>
    <li class="fr">
      <a href="/notes/home.html">Notes</a>
    </li>
	<li class="fr">
      <a href="/cloudformation/home.html">CloudFormation</a>
    </li>
  </ul>
</nav>
</div>
<div id="content" class="content">
<header>
<h1 class="title">Docker</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org6fecf3e">Clean Up</a>
<ul>
<li><a href="#org3734e3e">Remove Unused Images</a></li>
<li><a href="#orgcc611fd">Remove All Images</a></li>
</ul>
</li>
<li><a href="#org5e7cde1">Start docker with SSH</a>
<ul>
<li><a href="#org02a514b">Run Docker with .ssh</a></li>
<li><a href="#org94b0873">In container, start ssh-agent</a></li>
<li><a href="#orga3e96e5">Add your keys</a></li>
</ul>
</li>
<li><a href="#org515727c">Run Simple Images</a>
<ul>
<li><a href="#org9cadac1">Python</a></li>
<li><a href="#orgf9e8d3f">Golang</a></li>
</ul>
</li>
<li><a href="#org42d2734">Rate Limiting</a></li>
</ul>
</div>
</nav>

<div id="outline-container-org6fecf3e" class="outline-2">
<h2 id="org6fecf3e"><a href="#org6fecf3e">Clean Up</a></h2>
<div class="outline-text-2" id="text-org6fecf3e">
</div>
<div id="outline-container-org3734e3e" class="outline-3">
<h3 id="org3734e3e"><a href="#org3734e3e">Remove Unused Images</a></h3>
<div class="outline-text-3" id="text-org3734e3e">
<div class="org-src-container">
<pre class="src src-sh">docker system prune
</pre>
</div>

<p>
This removes:
</p>

<ul class="org-ul">
<li>all stopped containers</li>
<li>all networks not used by at least one container</li>
<li>all dangling images</li>
<li>all dangling build cache</li>
</ul>
</div>
</div>

<div id="outline-container-orgcc611fd" class="outline-3">
<h3 id="orgcc611fd"><a href="#orgcc611fd">Remove All Images</a></h3>
<div class="outline-text-3" id="text-orgcc611fd">
<div class="org-src-container">
<pre class="src src-sh">docker image rm -f $(docker images -a -q)
</pre>
</div>

<p>
or
</p>

<div class="org-src-container">
<pre class="src src-sh">docker system prune --all
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org5e7cde1" class="outline-2">
<h2 id="org5e7cde1"><a href="#org5e7cde1">Start docker with SSH</a></h2>
<div class="outline-text-2" id="text-org5e7cde1">
<p>
On linux it should be possible to actually use SSH agent forwarding. See:
<a href="https://gist.github.com/d11wtq/8699521">https://gist.github.com/d11wtq/8699521</a>
</p>

<p>
However, this doesn't work on MacOS. See:
<a href="https://github.com/docker/for-mac/issues/410">https://github.com/docker/for-mac/issues/410</a>
<a href="https://github.com/docker/for-mac/issues/483">https://github.com/docker/for-mac/issues/483</a>
</p>

<p>
But, you can of course just share your .ssh folder and start ssh-agent in the
container.
</p>
</div>

<div id="outline-container-org02a514b" class="outline-3">
<h3 id="org02a514b"><a href="#org02a514b">Run Docker with .ssh</a></h3>
<div class="outline-text-3" id="text-org02a514b">
<p>
This uses a bind mount, which shares the files. Should probably use a volume
to copy the files.
</p>

<div class="org-src-container">
<pre class="src src-sh">docker run --rm -it <span style="color: #98be65;">\</span>
       --name sshtest <span style="color: #98be65;">\</span>
       --mount <span style="color: #dcaeea;">type</span>=bind,<span style="color: #dcaeea;">source</span>=/Users/chrisc/.ssh,<span style="color: #dcaeea;">target</span>=/root/.ssh <span style="color: #98be65;">\</span>
       $<span style="color: #dcaeea;">ImageName</span> <span style="color: #98be65;">\</span>
       /bin/bash
</pre>
</div>
</div>
</div>

<div id="outline-container-org94b0873" class="outline-3">
<h3 id="org94b0873"><a href="#org94b0873">In container, start ssh-agent</a></h3>
<div class="outline-text-3" id="text-org94b0873">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #c678dd;">eval</span> $(ssh-agent -s)
</pre>
</div>
</div>
</div>

<div id="outline-container-orga3e96e5" class="outline-3">
<h3 id="orga3e96e5"><a href="#orga3e96e5">Add your keys</a></h3>
<div class="outline-text-3" id="text-orga3e96e5">
<div class="org-src-container">
<pre class="src src-sh">ssh-add ~/.ssh/id_rsa
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org515727c" class="outline-2">
<h2 id="org515727c"><a href="#org515727c">Run Simple Images</a></h2>
<div class="outline-text-2" id="text-org515727c">
<p>
Images I sometimes run for debugging etc.
</p>
</div>

<div id="outline-container-org9cadac1" class="outline-3">
<h3 id="org9cadac1"><a href="#org9cadac1">Python</a></h3>
<div class="outline-text-3" id="text-org9cadac1">
<p>
Run and mount current dir.
</p>

<div class="org-src-container">
<pre class="src src-sh">docker run -it --rm <span style="color: #98be65;">\</span>
       --name ${<span style="color: #dcaeea;">PROJECT_NAME</span>} <span style="color: #98be65;">\</span>
       --mount <span style="color: #dcaeea;">type</span>=bind,<span style="color: #dcaeea;">source</span>=(<span style="color: #c678dd;">pwd</span>),<span style="color: #dcaeea;">target</span>=/${<span style="color: #dcaeea;">PROJECT_NAME</span>} <span style="color: #98be65;">\</span>
       python:3.6.5-slim-stretch /bin/bash
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf9e8d3f" class="outline-3">
<h3 id="orgf9e8d3f"><a href="#orgf9e8d3f">Golang</a></h3>
<div class="outline-text-3" id="text-orgf9e8d3f">
<p>
Run golang container for interactive use
</p>

<div class="org-src-container">
<pre class="src src-sh">docker run -it --rm golang:1.14
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org42d2734" class="outline-2">
<h2 id="org42d2734"><a href="#org42d2734">Rate Limiting</a></h2>
<div class="outline-text-2" id="text-org42d2734">
<div class="org-src-container">
<pre class="src src-sh" id="orga1baef9">curl <span style="color: #98be65;">"https://auth.docker.io/token?service=registry.docker.io&amp;scope=repository:ratelimitpreview/test:pull"</span> <span style="color: #98be65;">\</span>
    | jq -r .token
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">curl --head <span style="color: #98be65;">\</span>
     -H <span style="color: #98be65;">"Authorization: Bearer $TOKEN"</span> <span style="color: #98be65;">\</span>
     https://registry-1.docker.io/v2/ratelimitpreview/test/manifests/latest
</pre>
</div>

<pre class="example" id="org4f9b2b3">
HTTP/1.1 200 OK
Content-Length: 2782
Content-Type: application/vnd.docker.distribution.manifest.v1+prettyjws
Docker-Content-Digest: sha256:767a3815c34823b355bed31760d5fa3daca0aec2ce15b217c9cd83229e0e2020
Docker-Distribution-Api-Version: registry/2.0
Etag: "sha256:767a3815c34823b355bed31760d5fa3daca0aec2ce15b217c9cd83229e0e2020"
Date: Mon, 07 Dec 2020 21:19:08 GMT
Strict-Transport-Security: max-age=31536000
RateLimit-Limit: 100;w=21600
RateLimit-Remaining: 100;w=21600

</pre>
</div>
</div>
</div>
</body>
</html>
