<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Keys and Certificates</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/static/main.css" />
</head>
<body>
<div id="preamble" class="status">
<nav id="navbar" class="cf">
  <ul class="cf">
    <li class="fl">
      <a href="/">cfclrk</a>
    </li>
    <li class="fr">
      <a href="/articles/home.html">Articles</a>
    </li>
    <li class="fr">
      <a href="/notes/home.html">Notes</a>
    </li>
	<li class="fr">
      <a href="/cloudformation/home.html">CloudFormation</a>
    </li>
  </ul>
</nav>
</div>
<div id="content" class="content">
<header>
<h1 class="title">Keys and Certificates</h1>
</header><nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orge31f694">Discover Public Certificates</a></li>
<li><a href="#org55a89c1">Create an SSH Key</a>
<ul>
<li><a href="#org7c0fd65">No Passphrase</a></li>
</ul>
</li>
<li><a href="#org979edcc">Conversions</a></li>
<li><a href="#orgdac7e6d">Eliptic Curve Keys and Certs</a>
<ul>
<li><a href="#org4219711">List Curves</a></li>
</ul>
</li>
<li><a href="#orgca85071">Creating Certificates</a>
<ul>
<li><a href="#org8ed5967">Create Keypair</a></li>
<li><a href="#orgdbd3d62">CA Certificates</a>
<ul>
<li><a href="#org4e28bbc">Cross-Certificate</a></li>
<li><a href="#org4546b00">Self-Issued Certificates</a></li>
<li><a href="#orge5c9c16">Self-Signed Certificates</a></li>
</ul>
</li>
<li><a href="#org6a36595">Entity Certificates</a></li>
</ul>
</li>
<li><a href="#orgca97bf4">cfssl</a></li>
<li><a href="#org93160ee">Fingerprint</a></li>
<li><a href="#orgd8c7f59">Checking and Viewing Certs</a>
<ul>
<li><a href="#orgb7fbd8a">Check if a Private Key Matches a Public Key</a></li>
<li><a href="#orge234d82">Certificate Details</a></li>
<li><a href="#org251da9c">CSR</a></li>
<li><a href="#orgfb82592">Verify Cert with CA</a></li>
</ul>
</li>
</ul>
</div>
</nav>

<div id="outline-container-orge31f694" class="outline-2">
<h2 id="orge31f694"><a href="#orge31f694">Discover Public Certificates</a></h2>
<div class="outline-text-2" id="text-orge31f694">
<p>
Use <a href="https://cert.sh">cert.sh</a>. For example, to see all certs issued for <code>cats.com</code>:
<a href="https://crt.sh/?q=%25.cats.com">https://crt.sh/?q=%25.cats.com</a>
</p>

<p>
Advanced search page: <a href="https://crt.sh/?a=1">https://crt.sh/?a=1</a>
</p>

<p>
The data is stored in a relational DB. Optionally show the SQL query a page
makes using <code>&amp;showSQL=Y</code>, or by selecting "Show SQL?" on the advanced search
page.
</p>
</div>
</div>

<div id="outline-container-org55a89c1" class="outline-2">
<h2 id="org55a89c1"><a href="#org55a89c1">Create an SSH Key</a></h2>
<div class="outline-text-2" id="text-org55a89c1">
</div>
<div id="outline-container-org7c0fd65" class="outline-3">
<h3 id="org7c0fd65"><a href="#org7c0fd65">No Passphrase</a></h3>
<div class="outline-text-3" id="text-org7c0fd65">
<div class="org-src-container">
<pre class="src src-sh">ssh-keygen -t rsa -b 4096 -f ~/.ssh/$<span style="color: #dcaeea;">keyname</span> -N <span style="color: #98be65;">""</span> -C <span style="color: #98be65;">"$email"</span>
</pre>
</div>

<p>
The email address is optional:
</p>

<div class="org-src-container">
<pre class="src src-sh">ssh-keygen -t rsa -b 4096 -f ./$<span style="color: #dcaeea;">keyname</span> -N <span style="color: #98be65;">""</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org979edcc" class="outline-2">
<h2 id="org979edcc"><a href="#org979edcc">Conversions</a></h2>
<div class="outline-text-2" id="text-org979edcc">
<p>
Generate a public key from a private key:
</p>

<div class="org-src-container">
<pre class="src src-sh">ssh-keygen -y -f ~/.ssh/${<span style="color: #dcaeea;">keyname</span>}.pem $<span style="color: #dcaeea;">HOME</span>/.ssh/${<span style="color: #dcaeea;">keyname</span>}.pub
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdac7e6d" class="outline-2">
<h2 id="orgdac7e6d"><a href="#orgdac7e6d">Eliptic Curve Keys and Certs</a></h2>
<div class="outline-text-2" id="text-orgdac7e6d">
</div>
<div id="outline-container-org4219711" class="outline-3">
<h3 id="org4219711"><a href="#org4219711">List Curves</a></h3>
<div class="outline-text-3" id="text-org4219711">
<p>
<code>prime256v1</code> is suitable for JWT signing (<a href="https://www.scottbrady91.com/OpenSSL/Creating-Elliptical-Curve-Keys-using-OpenSSL">ref</a>).
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl ecparam -list_curves
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgca85071" class="outline-2">
<h2 id="orgca85071"><a href="#orgca85071">Creating Certificates</a></h2>
<div class="outline-text-2" id="text-orgca85071">
</div>
<div id="outline-container-org8ed5967" class="outline-3">
<h3 id="org8ed5967"><a href="#org8ed5967">Create Keypair</a></h3>
<div class="outline-text-3" id="text-org8ed5967">
<p>
The <code>openssl genrsa</code> command creates a private key that includes a public
key.
</p>

<div class="org-src-container">
<pre class="src src-sh" id="orge93731a">openssl genrsa 1024
</pre>
</div>

<p>
Extract the public key from the private key:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #c678dd;">echo</span> <span style="color: #98be65;">"$keypair"</span> | openssl rsa -outform PEM -pubout
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdbd3d62" class="outline-3">
<h3 id="orgdbd3d62"><a href="#orgdbd3d62">CA Certificates</a></h3>
<div class="outline-text-3" id="text-orgdbd3d62">
<p>
From <a href="https://datatracker.ietf.org/doc/html/rfc5280#section-3.2">RFC 5280</a>:
</p>

<blockquote>
<p>
CA certificates may be further divided into three classes:
cross-certificates, self-issued certificates, and self-signed certificates.
</p>
</blockquote>

<p>
Every root CA certificate is a self-signed certificate. Intermediate CA
certificates are not self-signed; they are signed by their parent CA.
</p>

<p>
The following command creates a <code>ca.key</code> and a <code>ca.crt</code> file. Remember that
the <code>ca.key</code> actually contains both the public and private key. The
certificate has the public key and some metadata.
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl genrsa -out ca.key 2048
openssl req -x509 -new -nodes <span style="color: #98be65;">\</span>
        -key ca.key <span style="color: #98be65;">\</span>
        -subj <span style="color: #98be65;">"/CN=${CommonName}"</span> <span style="color: #98be65;">\</span>
        -days 3650 <span style="color: #98be65;">\</span>
        -out ca.crt
</pre>
</div>
</div>

<div id="outline-container-org4e28bbc" class="outline-4">
<h4 id="org4e28bbc"><a href="#org4e28bbc">Cross-Certificate</a></h4>
<div class="outline-text-4" id="text-org4e28bbc">
<blockquote>
<p>
Cross-certificates are CA certificates in which the issuer and subject are
different entities. Cross-certificates describe a trust relationship between
the two CAs.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org4546b00" class="outline-4">
<h4 id="org4546b00"><a href="#org4546b00">Self-Issued Certificates</a></h4>
<div class="outline-text-4" id="text-org4546b00">
<blockquote>
<p>
Self-issued certificates are CA certificates in which the issuer and subject
are the same entity. Self-issued certificates are generated to support
changes in policy or operations.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-orge5c9c16" class="outline-4">
<h4 id="orge5c9c16"><a href="#orge5c9c16">Self-Signed Certificates</a></h4>
<div class="outline-text-4" id="text-orge5c9c16">
<blockquote>
<p>
Self-signed certificates are self-issued certificates where the digital
signature may be verified by the public key bound into the certificate.
Self-signed certificates are used to convey a public key for use to begin
certification paths.
</p>
</blockquote>

<p>
That is, self-signed certificates are either:
</p>

<ol class="org-ol">
<li>Root CA certifaces</li>
<li>You've gone rogue; you are a wild renegade signing certs like a villian</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org6a36595" class="outline-3">
<h3 id="org6a36595"><a href="#org6a36595">Entity Certificates</a></h3>
<div class="outline-text-3" id="text-org6a36595">
<blockquote>
<p>
End entity certificates are issued to subjects that are not authorized to
issue certificates.
</p>
</blockquote>

<p>
Create a new keypair. This creates two file: <code>client.key</code> (which actually has
both the public and private key in it).
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl genrsa -out client.key 2048
</pre>
</div>

<p>
Create a Certificate Signing Request (CSR), which is a document that
associates some metadata with the key. This creates one file: <code>client.csr</code>.
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl req -new <span style="color: #98be65;">\</span>
        -key client.key <span style="color: #98be65;">\</span>
        -subj <span style="color: #98be65;">"/CN=${CommonName}"</span> <span style="color: #98be65;">\</span>
        -out client.csr
</pre>
</div>

<p>
Create a client certificate by signing the CSR with the CA's private key. I
suppose the CA might first verify that the information in the CSR is
consistent (does the requester actually own the Common Name?), but in
practice I'm not sure of any examples where that actually happens.
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl x509 -req <span style="color: #98be65;">\</span>
        -in client.csr <span style="color: #98be65;">\</span>
        -CA ca.crt <span style="color: #98be65;">\</span>
        -CAkey ca.key <span style="color: #98be65;">\</span>
        -CAcreateserial <span style="color: #98be65;">\</span>
        -out client.crt <span style="color: #98be65;">\</span>
        -days 3650 <span style="color: #98be65;">\</span>
        -sha256
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgca97bf4" class="outline-2">
<h2 id="orgca97bf4"><a href="#orgca97bf4">cfssl</a></h2>
<div class="outline-text-2" id="text-orgca97bf4">
<div class="org-src-container">
<pre class="src src-sh">cfssl selfsign www.example.net acm-test.json <span style="color: #98be65;">\</span>
    | cfssljson -bare acm-test
</pre>
</div>
</div>
</div>

<div id="outline-container-org93160ee" class="outline-2">
<h2 id="org93160ee"><a href="#org93160ee">Fingerprint</a></h2>
<div class="outline-text-2" id="text-org93160ee">
<div class="org-src-container">
<pre class="src src-sh">openssl x509 -noout -fingerprint -sha256 -inform pem -in $<span style="color: #dcaeea;">file</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">ssh-keygen -lf $<span style="color: #dcaeea;">file</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">ssh-keygen -l -E md5 -f $<span style="color: #dcaeea;">file</span>
</pre>
</div>

<p>
AWS EC2 KeyPairs created by AWS are pretty specific. This command is from the
docs <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html#verify-key-pair-fingerprints">here</a> about how to check the fingerprint.
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl pkcs8 -in $<span style="color: #dcaeea;">file</span> -inform PEM -outform DER -topk8 -nocrypt | openssl sha1 -c
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd8c7f59" class="outline-2">
<h2 id="orgd8c7f59"><a href="#orgd8c7f59">Checking and Viewing Certs</a></h2>
<div class="outline-text-2" id="text-orgd8c7f59">
</div>
<div id="outline-container-orgb7fbd8a" class="outline-3">
<h3 id="orgb7fbd8a"><a href="#orgb7fbd8a">Check if a Private Key Matches a Public Key</a></h3>
<div class="outline-text-3" id="text-orgb7fbd8a">
<p>
On the private key:
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl rsa -modulus -noout -in &lt;path/to/private/key.pem&gt;
</pre>
</div>

<p>
On the public key:
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl x509 -modulus -noout -in &lt;path/to/cert.pem&gt;
</pre>
</div>

<p>
If the output of those two match, then the keys go together. An easy way to
compare them is to pipe them both to <code>openssl md5</code>.
</p>
</div>
</div>

<div id="outline-container-orge234d82" class="outline-3">
<h3 id="orge234d82"><a href="#orge234d82">Certificate Details</a></h3>
<div class="outline-text-3" id="text-orge234d82">
<p>
Show cert info for a local certificate file.
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl x509 -in $<span style="color: #dcaeea;">cert</span> -text -noout
</pre>
</div>

<p>
Show cert info for a website.
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl s_client -connect google.com:443 -showcerts
</pre>
</div>
</div>
</div>

<div id="outline-container-org251da9c" class="outline-3">
<h3 id="org251da9c"><a href="#org251da9c">CSR</a></h3>
<div class="outline-text-3" id="text-org251da9c">
<div class="org-src-container">
<pre class="src src-sh">openssl req -text -noout -verify -in $<span style="color: #dcaeea;">file</span>.csr
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfb82592" class="outline-3">
<h3 id="orgfb82592"><a href="#orgfb82592">Verify Cert with CA</a></h3>
<div class="outline-text-3" id="text-orgfb82592">
<div class="org-src-container">
<pre class="src src-sh">openssl verify -CAfile ca.crt entity.crt
</pre>
</div>
</div>
</div>
</div>
</div>
</body>
</html>
