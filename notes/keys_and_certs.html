<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Keys and Certificates</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/static/main.css" />
</head>
<body>
<div id="preamble" class="status">
<nav id="navbar" class="cf">
  <ul class="cf">
    <li class="fl">
      <a href="/">cfclrk</a>
    </li>
    <li class="fr">
      <a href="/articles/home.html">Articles</a>
    </li>
    <li class="fr">
      <a href="/notes/home.html">Notes</a>
    </li>
	<li class="fr">
      <a href="/cloudformation/home.html">CloudFormation</a>
    </li>
  </ul>
</nav>
</div>
<div id="content">
<header>
<h1 class="title">Keys and Certificates</h1>
</header><nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orge31f694">Discover Public Certificates</a></li>
<li><a href="#org55a89c1">Create an SSH Key</a>
<ul>
<li><a href="#org7c0fd65">No Passphrase</a></li>
</ul>
</li>
<li><a href="#orgca85071">Creating Certificates</a>
<ul>
<li><a href="#org83febe8">Create keypair</a></li>
<li><a href="#org8862a90">Create root CA</a></li>
<li><a href="#org13c7820">Create certificate signed by CA</a></li>
</ul>
</li>
<li><a href="#orgca97bf4">cfssl</a></li>
<li><a href="#org7049e4d">Create a fingerprint</a></li>
<li><a href="#org6d5e246">Check if a private key matches a public key</a></li>
<li><a href="#orgab3fee9">Checking/viewing certs</a>
<ul>
<li><a href="#orgfb706eb">cert (public key)</a></li>
<li><a href="#org251da9c">CSR</a></li>
<li><a href="#org15cfeba">Cert against CA</a></li>
</ul>
</li>
</ul>
</div>
</nav>

<div id="outline-container-orge31f694" class="outline-2">
<h2 id="orge31f694"><a href="#orge31f694">Discover Public Certificates</a></h2>
<div class="outline-text-2" id="text-orge31f694">
<p>
Use <a href="https://cert.sh">cert.sh</a>. For example, to see all certs issued for <code>cats.com</code>:
<a href="https://crt.sh/?q=%25.cats.com">https://crt.sh/?q=%25.cats.com</a>
</p>

<p>
Advanced search page: <a href="https://crt.sh/?a=1">https://crt.sh/?a=1</a>
</p>

<p>
The data is stored in a relational DB. Optionally show the SQL query a page
makes using <code>&amp;showSQL=Y</code>, or by selecting "Show SQL?" on the advanced search
page.
</p>
</div>
</div>

<div id="outline-container-org55a89c1" class="outline-2">
<h2 id="org55a89c1"><a href="#org55a89c1">Create an SSH Key</a></h2>
<div class="outline-text-2" id="text-org55a89c1">
</div>
<div id="outline-container-org7c0fd65" class="outline-3">
<h3 id="org7c0fd65"><a href="#org7c0fd65">No Passphrase</a></h3>
<div class="outline-text-3" id="text-org7c0fd65">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #dcaeea;">keyname</span>=<span style="color: #98be65;">"github-home"</span>
<span style="color: #dcaeea;">email</span>=<span style="color: #98be65;">"cfclrk@gmail.com"</span>
ssh-keygen -t rsa -b 4096 -f ./$<span style="color: #dcaeea;">keyname</span> -N <span style="color: #98be65;">""</span> -C <span style="color: #98be65;">"$email"</span>
</pre>
</div>

<p>
The email address is optional:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #dcaeea;">keyname</span>=<span style="color: #98be65;">"foo"</span>
ssh-keygen -t rsa -b 4096 -f ./$<span style="color: #dcaeea;">keyname</span> -N <span style="color: #98be65;">""</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgca85071" class="outline-2">
<h2 id="orgca85071"><a href="#orgca85071">Creating Certificates</a></h2>
<div class="outline-text-2" id="text-orgca85071">
</div>
<div id="outline-container-org83febe8" class="outline-3">
<h3 id="org83febe8"><a href="#org83febe8">Create keypair</a></h3>
<div class="outline-text-3" id="text-org83febe8">
<p>
The <code>openssl genrsa</code> command creates a private key that includes a public
key.
</p>

<div class="org-src-container">
<pre class="src src-sh" id="orge93731a">openssl genrsa 1024
</pre>
</div>

<p>
Extract the public key from the private key:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #c678dd;">echo</span> <span style="color: #98be65;">"$keypair"</span> | openssl rsa -outform PEM -pubout
</pre>
</div>
</div>
</div>

<div id="outline-container-org8862a90" class="outline-3">
<h3 id="org8862a90"><a href="#org8862a90">Create root CA</a></h3>
<div class="outline-text-3" id="text-org8862a90">
<p>
Every root CA certificate is a self-signed certificate. Intermediate CA
certificates are not self-signed; they are signed by their parent CA.
</p>

<p>
This creates a <code>ca.key</code> and a <code>ca.crt</code> file. Remember that the <code>ca.key</code> file
actually contains both the public and private key. The certificate has the
public key and some metadata.
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl genrsa -out ca.key 2048
openssl req -x509 -new -nodes <span style="color: #98be65;">\</span>
        -key ca.key <span style="color: #98be65;">\</span>
        -subj <span style="color: #98be65;">"/CN=${CommonName}"</span> <span style="color: #98be65;">\</span>
        -days 3650 <span style="color: #98be65;">\</span>
        -out ca.crt
</pre>
</div>
</div>
</div>

<div id="outline-container-org13c7820" class="outline-3">
<h3 id="org13c7820"><a href="#org13c7820">Create certificate signed by CA</a></h3>
<div class="outline-text-3" id="text-org13c7820">
<p>
Create a new keypair. This creates two file: <code>client.key</code> (which actually has
both the public and private key in it).
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl genrsa -out client.key 2048
</pre>
</div>

<p>
Create a Certificate Signing Request (CSR), which is a document that
associates some metadata with the key. This creates one file: <code>client.csr</code>.
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl req -new <span style="color: #98be65;">\</span>
        -key client.key <span style="color: #98be65;">\</span>
        -subj <span style="color: #98be65;">"/CN=${CommonName}"</span> <span style="color: #98be65;">\</span>
        -out client.csr
</pre>
</div>

<p>
Create a client certificate by signing the CSR with the CA's private key. I
suppose the CA might first verify that the information in the CSR is
consistent (does the requester actually own the Common Name?), but in
practice I'm not sure of any examples where that actually happens.
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl x509 -req <span style="color: #98be65;">\</span>
        -in client.csr <span style="color: #98be65;">\</span>
        -CA ca.crt <span style="color: #98be65;">\</span>
        -CAkey ca.key <span style="color: #98be65;">\</span>
        -CAcreateserial <span style="color: #98be65;">\</span>
        -out client.crt <span style="color: #98be65;">\</span>
        -days 3650 <span style="color: #98be65;">\</span>
        -sha256
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgca97bf4" class="outline-2">
<h2 id="orgca97bf4"><a href="#orgca97bf4">cfssl</a></h2>
<div class="outline-text-2" id="text-orgca97bf4">
<div class="org-src-container">
<pre class="src src-sh">cfssl selfsign www.example.net acm-test.json <span style="color: #98be65;">\</span>
    | cfssljson -bare acm-test
</pre>
</div>
</div>
</div>

<div id="outline-container-org7049e4d" class="outline-2">
<h2 id="org7049e4d"><a href="#org7049e4d">Create a fingerprint</a></h2>
<div class="outline-text-2" id="text-org7049e4d">
<div class="org-src-container">
<pre class="src src-sh">openssl x509 -noout -fingerprint -sha256 -inform pem -in &lt;file path&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org6d5e246" class="outline-2">
<h2 id="org6d5e246"><a href="#org6d5e246">Check if a private key matches a public key</a></h2>
<div class="outline-text-2" id="text-org6d5e246">
<p>
On the private key:
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl rsa -modulus -noout -in &lt;path/to/private/key.pem&gt;
</pre>
</div>

<p>
On the public key:
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl x509 -modulus -noout -in &lt;path/to/cert.pem&gt;
</pre>
</div>

<p>
If the output of those two match, then the keys go together. An easy way to
check is to pipe them both to <code>openssl md5</code>.
</p>
</div>
</div>

<div id="outline-container-orgab3fee9" class="outline-2">
<h2 id="orgab3fee9"><a href="#orgab3fee9">Checking/viewing certs</a></h2>
<div class="outline-text-2" id="text-orgab3fee9">
</div>
<div id="outline-container-orgfb706eb" class="outline-3">
<h3 id="orgfb706eb"><a href="#orgfb706eb">cert (public key)</a></h3>
<div class="outline-text-3" id="text-orgfb706eb">
<pre class="example">
/Users/chris.clark/Projects/codenotes/aws/cert.pem
</pre>


<pre class="example">
/Users/chris.clark/IronNet/bp-cli/cert.pem
</pre>


<div class="org-src-container">
<pre class="src src-sh" id="orgfbc70bd">openssl x509 -in $<span style="color: #dcaeea;">cert</span> -text -noout
</pre>
</div>
</div>
</div>

<div id="outline-container-org251da9c" class="outline-3">
<h3 id="org251da9c"><a href="#org251da9c">CSR</a></h3>
<div class="outline-text-3" id="text-org251da9c">
<div class="org-src-container">
<pre class="src src-sh">openssl req -text -noout -verify -in $<span style="color: #dcaeea;">FILE</span>.csr
</pre>
</div>
</div>
</div>

<div id="outline-container-org15cfeba" class="outline-3">
<h3 id="org15cfeba"><a href="#org15cfeba">Cert against CA</a></h3>
<div class="outline-text-3" id="text-org15cfeba">
<div class="org-src-container">
<pre class="src src-sh">openssl verify -CAfile ca.crt kafka.crt
</pre>
</div>
</div>
</div>
</div>
</div>
</body>
</html>
