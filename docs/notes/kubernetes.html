<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kubernetes</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/static/main.css" />
</head>
<body>
<div id="preamble" class="status">
<nav id="navbar" class="cf">
  <ul class="cf">
    <li class="fl">
      <a href="/">cfclrk</a>
    </li>
    <li class="fr">
      <a href="/articles/home.html">Articles</a>
    </li>
    <li class="fr">
      <a href="/notes/home.html">Notes</a>
    </li>
	<li class="fr">
      <a href="/cloudformation/home.html">CloudFormation</a>
    </li>
  </ul>
</nav>
</div>
<div id="content" class="content">
<header>
<h1 class="title">Kubernetes</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org27ac499">What is Kubernetes?</a></li>
<li><a href="#orgebed4e5">Operators</a></li>
<li><a href="#org4af5042">Describing a Cluster</a>
<ul>
<li><a href="#org0bf4b72">Version</a></li>
<li><a href="#org35b61ce">Master node address</a></li>
<li><a href="#orgb171ac5">View all available resources</a></li>
</ul>
</li>
<li><a href="#orgbb0b051">Completely Delete a Cluster</a></li>
<li><a href="#org5b9933c">Kubeconfig, Context and Namespace</a></li>
<li><a href="#org160d60e">Cluster ID</a></li>
<li><a href="#orge732955">Affinity, Taints, and Tolerations</a>
<ul>
<li><a href="#org5fedd9f">Affinity</a></li>
<li><a href="#org524cb8f">Taints</a></li>
<li><a href="#org7aca736">Tolerations</a></li>
</ul>
</li>
<li><a href="#orgcb2ddf6">ConfigMaps</a></li>
<li><a href="#org3723e24">Deployments</a>
<ul>
<li><a href="#orgbc73bd4">Scaling a deployment</a></li>
</ul>
</li>
<li><a href="#orgdd48688">Nodes</a>
<ul>
<li><a href="#orgd515ff3">Master Node IP</a></li>
<li><a href="#orgedb6123">Worker Nodes</a></li>
<li><a href="#orgbe4ca62">Worker Node IPs</a>
<ul>
<li><a href="#org97dc6fa">Private IP</a></li>
<li><a href="#org168518a">Public IPs</a></li>
</ul>
</li>
<li><a href="#orgfc397d4">All Pods on a Node</a></li>
<li><a href="#org6a69325">SSH to a Pod's Node</a></li>
</ul>
</li>
<li><a href="#org9ad62fb">Pods</a>
<ul>
<li><a href="#orgb9bf892">List Containers in a Pod</a></li>
<li><a href="#orgbb91d47">What Node is this Pod on?</a></li>
</ul>
</li>
<li><a href="#orgaba1171">Secrets</a>
<ul>
<li><a href="#org6e91b01">Create Docker Registry Secret</a></li>
<li><a href="#orgd7b8897">Decode Docker Registry Secret</a></li>
<li><a href="#orgae003de">Update a Secret</a></li>
</ul>
</li>
<li><a href="#org406ba03">Services</a>
<ul>
<li><a href="#org987f840">Get Services of Type</a></li>
</ul>
</li>
<li><a href="#org8cfa95f">Service Accounts</a></li>
<li><a href="#orgc519080">StorageClass</a></li>
<li><a href="#org724d4fc">Running Commands in Cluster</a>
<ul>
<li><a href="#org116e482">Create a temporary pod</a></li>
<li><a href="#org11df49e">Exec in an existing pod</a></li>
<li><a href="#orge31dfa9">Port forwarding with kubectl</a></li>
</ul>
</li>
<li><a href="#orge74035d">Using the API directily</a></li>
<li><a href="#orgce6c22a">Debugging</a>
<ul>
<li><a href="#orgc3d316e">Startig a busybox pod</a></li>
</ul>
</li>
<li><a href="#org85069bd">etcd</a></li>
<li><a href="#orgbc8d4a8">Autoscaling</a>
<ul>
<li><a href="#org8268299">Scaling Pods</a>
<ul>
<li><a href="#org1650b82">Horizontal Pod Autoscaler</a></li>
</ul>
</li>
<li><a href="#orgec38b65">Scaling Nodes</a></li>
</ul>
</li>
</ul>
</div>
</nav>

<div id="outline-container-org27ac499" class="outline-2">
<h2 id="org27ac499"><a href="#org27ac499">What is Kubernetes?</a></h2>
<div class="outline-text-2" id="text-org27ac499">
<p>
According to kubernetes.com, Kubernetes is&#x2026;
</p>

<blockquote>
<p>
an open-source system for automating deployment, scaling, and management of
containerized applications.
</p>
</blockquote>

<p>
I think of it more like: Kubernetes is a program for creating and managing a
<i>computer cluster</i>.
</p>

<p>
A cluster is a distributed system in which multiple computers work together to
behave somewhat like one, bigger computer. While a distributed system is
fundamentally different from a single computer, cluster management software
(e.g. Kubernetes) bring these two closer together.
</p>

<p>
Running a process on a cluster is different from a running program on a single
computer. Kubernetes provides heavy abstractions for dealing with clusters.
People started trying to create "clusters" a long time ago (see: <a href="https://en.wikipedia.org/wiki/Beowulf_cluster">beowulf
clusters</a>). Some of the problems that need to be addressed are:
</p>

<ul class="org-ul">
<li>Networking
<ul class="org-ul">
<li>What does it mean for a machine to be "in" the cluster vs "out" of the
cluster?</li>
<li>How should inter-process communication work when processes might be on
different machines?</li>
<li>What happens when a machine is no longer responsive?</li>
</ul></li>

<li>Process Scheduling
<ul class="org-ul">
<li>When you run a process on the cluster, which specific machine should the
process actually run on?</li>
<li>What if certain processes can only run on certain machines?</li>
</ul></li>

<li>Data
<ul class="org-ul">
<li>How can processes share data (on disk) when they might running on
different machines?</li>
<li>Should every process have access to the whole host's filesystem? (Probably
not.) How can we make process-local disk space?</li>
</ul></li>

<li>Security
<ul class="org-ul">
<li>Should the cluster have some kind of RBAC (authn/authz) separate from that
of each individual machine?</li>
</ul></li>
</ul>

<p>
At first, I thought Kubernetes was mostly about process scheduling, but that
is actually a very small part of Kubernetes. The most crucial part of
Kubernetes is probably the networking constructs it provides: how an internal
network is set up and how communication can happen between processes,
regardless of the nodes on which they run.
</p>
</div>
</div>

<div id="outline-container-orgebed4e5" class="outline-2">
<h2 id="orgebed4e5"><a href="#orgebed4e5">Operators</a></h2>
<div class="outline-text-2" id="text-orgebed4e5">
<p>
An operator is just a controller that monitors a CRD instead of a resource
defined by Kubernetes.
</p>

<p>
A controller monitors a set of resources (resources are just entries in the
etcd database, representing some kind of "desired state"), and reconciles the
database contents with the "actual state" of the system. Whenever the
controller sees differences between the desired and actual states, it takes
steps to reduce that difference.
</p>
</div>
</div>

<div id="outline-container-org4af5042" class="outline-2">
<h2 id="org4af5042"><a href="#org4af5042">Describing a Cluster</a></h2>
<div class="outline-text-2" id="text-org4af5042">
</div>
<div id="outline-container-org0bf4b72" class="outline-3">
<h3 id="org0bf4b72"><a href="#org0bf4b72">Version</a></h3>
<div class="outline-text-3" id="text-org0bf4b72">
<div class="org-src-container">
<pre class="src src-sh">kubectl version --short
</pre>
</div>
</div>
</div>

<div id="outline-container-org35b61ce" class="outline-3">
<h3 id="org35b61ce"><a href="#org35b61ce">Master node address</a></h3>
<div class="outline-text-3" id="text-org35b61ce">
<p>
Display address of master node
</p>

<div class="org-src-container">
<pre class="src src-sh">kubectl cluster-info
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb171ac5" class="outline-3">
<h3 id="orgb171ac5"><a href="#orgb171ac5">View all available resources</a></h3>
<div class="outline-text-3" id="text-orgb171ac5">
<div class="org-src-container">
<pre class="src src-sh">kubectl api-resources
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgbb0b051" class="outline-2">
<h2 id="orgbb0b051"><a href="#orgbb0b051">Completely Delete a Cluster</a></h2>
<div class="outline-text-2" id="text-orgbb0b051">
<div class="org-src-container">
<pre class="src src-sh">kubectl delete --all all
kubectl delete secret --all
kubectl delete serviceaccount --all
kubectl delete pvc --all
kubectl delete ingress --all
kubectl delete crds --all
</pre>
</div>
</div>
</div>

<div id="outline-container-org5b9933c" class="outline-2">
<h2 id="org5b9933c"><a href="#org5b9933c">Kubeconfig, Context and Namespace</a></h2>
<div class="outline-text-2" id="text-org5b9933c">
<p>
Set namespace for the current context
</p>

<div class="org-src-container">
<pre class="src src-sh">kubectl config set-context <span style="color: #98be65;">\</span>
        $(kubectl config current-context) <span style="color: #98be65;">\</span>
        --namespace default
</pre>
</div>
</div>
</div>

<div id="outline-container-org160d60e" class="outline-2">
<h2 id="org160d60e"><a href="#org160d60e">Cluster ID</a></h2>
<div class="outline-text-2" id="text-org160d60e">
<p>
Clusters don't really have an identifier. Best idea I have seen is to use the
kube-system namespace UID. For a discussion, see: <a href="https://groups.google.com/forum/#!msg/kubernetes-sig-architecture/mVGobfD4TpY/nkdbkX1iBwAJ">Cluster ID API</a>.
</p>

<div class="org-src-container">
<pre class="src src-sh">kubectl get ns kube-system <span style="color: #98be65;">\</span>
        -o <span style="color: #dcaeea;">jsonpath</span>=<span style="color: #98be65;">'{.metadata.uid}'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge732955" class="outline-2">
<h2 id="orge732955"><a href="#orge732955">Affinity, Taints, and Tolerations</a></h2>
<div class="outline-text-2" id="text-orge732955">
<p>
Kubernetes supports a way to indicate that specific nodes have a certain
quality. Pods must opt-in to using those nodes.
</p>

<p>
That is, some nodes can say "hey, I'm a little bit different", and then some
pods can say "I tolerate that difference".
</p>

<p>
An example is Azure's serverless pods. You can have physical nodes and virtual
(i.e. serverless) nodes. By default, your pods will get scheduled to your
physical nodes, but you could mark some pods as "tolerating" the Azure
serverless nodes.
</p>
</div>

<div id="outline-container-org5fedd9f" class="outline-3">
<h3 id="org5fedd9f"><a href="#org5fedd9f">Affinity</a></h3>
<div class="outline-text-3" id="text-org5fedd9f">
<p>
A Pod can specify an affinity for certain nodes. Can either be a preference or a
requirement.
</p>
</div>
</div>

<div id="outline-container-org524cb8f" class="outline-3">
<h3 id="org524cb8f"><a href="#org524cb8f">Taints</a></h3>
<div class="outline-text-3" id="text-org524cb8f">
<p>
A Node can have a taint that will not allow Pods to be scheduled to it unless
the Pod can tolerate the taint.
</p>
</div>
</div>

<div id="outline-container-org7aca736" class="outline-3">
<h3 id="org7aca736"><a href="#org7aca736">Tolerations</a></h3>
<div class="outline-text-3" id="text-org7aca736">
<p>
A Pod can specify a toleration which allows it (but does not require it) to be
scheduled to nodes with a matching taint.
</p>
</div>
</div>
</div>

<div id="outline-container-orgcb2ddf6" class="outline-2">
<h2 id="orgcb2ddf6"><a href="#orgcb2ddf6">ConfigMaps</a></h2>
<div class="outline-text-2" id="text-orgcb2ddf6">
<div class="org-src-container">
<pre class="src src-sh">kubectl get cm aws-auth <span style="color: #98be65;">\</span>
        -n kube-system <span style="color: #98be65;">\</span>
        --output=json <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.data'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3723e24" class="outline-2">
<h2 id="org3723e24"><a href="#org3723e24">Deployments</a></h2>
<div class="outline-text-2" id="text-org3723e24">
</div>
<div id="outline-container-orgbc73bd4" class="outline-3">
<h3 id="orgbc73bd4"><a href="#orgbc73bd4">Scaling a deployment</a></h3>
<div class="outline-text-3" id="text-orgbc73bd4">
<div class="org-src-container">
<pre class="src src-sh">kubectl scale deployment &lt;deployment-name&gt; --replicas=1
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgdd48688" class="outline-2">
<h2 id="orgdd48688"><a href="#orgdd48688">Nodes</a></h2>
<div class="outline-text-2" id="text-orgdd48688">
</div>
<div id="outline-container-orgd515ff3" class="outline-3">
<h3 id="orgd515ff3"><a href="#orgd515ff3">Master Node IP</a></h3>
<div class="outline-text-3" id="text-orgd515ff3">
<p>
Note you can also get the master node ip with <code>kubectl cluster-info</code>.
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org7bbd2aa">kubectl get node -lnode-role.kubernetes.io/master <span style="color: #98be65;">\</span>
        -o <span style="color: #dcaeea;">jsonpath</span>=<span style="color: #98be65;">'{ $.items[*].status.addresses[?(@.type=="ExternalIP")].address }'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgedb6123" class="outline-3">
<h3 id="orgedb6123"><a href="#orgedb6123">Worker Nodes</a></h3>
<div class="outline-text-3" id="text-orgedb6123">
<div class="org-src-container">
<pre class="src src-sh">kubectl get nodes <span style="color: #98be65;">\</span>
        -l <span style="color: #98be65;">"kubernetes.io/role = node"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbe4ca62" class="outline-3">
<h3 id="orgbe4ca62"><a href="#orgbe4ca62">Worker Node IPs</a></h3>
<div class="outline-text-3" id="text-orgbe4ca62">
</div>
<div id="outline-container-org97dc6fa" class="outline-4">
<h4 id="org97dc6fa"><a href="#org97dc6fa">Private IP</a></h4>
<div class="outline-text-4" id="text-org97dc6fa">
<p>
Without jq:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org199886f">kubectl get nodes -l <span style="color: #98be65;">"kubernetes.io/role = node"</span> <span style="color: #98be65;">\</span>
        -o <span style="color: #dcaeea;">jsonpath</span>=<span style="color: #98be65;">'{range .items[*]}{.metadata.annotations.flannel\.alpha\.coreos\.com/public-ip}</span>
<span style="color: #98be65;">{end}'</span>
</pre>
</div>

<p>
With jq:
</p>

<div class="org-src-container">
<pre class="src src-sh">kubectl get nodes <span style="color: #98be65;">\</span>
        -l <span style="color: #98be65;">"kubernetes.io/role = node"</span> <span style="color: #98be65;">\</span>
        -o json <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.items[]</span>
<span style="color: #98be65;">             .metadata</span>
<span style="color: #98be65;">             .annotations["flannel.alpha.coreos.com/public-ip"]'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org168518a" class="outline-4">
<h4 id="org168518a"><a href="#org168518a">Public IPs</a></h4>
<div class="outline-text-4" id="text-org168518a">
<div class="org-src-container">
<pre class="src src-sh">kubectl get nodes -o json <span style="color: #98be65;">\</span>
        -l <span style="color: #98be65;">"kubernetes.io/role = node"</span> <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.items[].status.addresses[]</span>
<span style="color: #98be65;">             | select(.type == "ExternalIP")</span>
<span style="color: #98be65;">             | .address'</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgfc397d4" class="outline-3">
<h3 id="orgfc397d4"><a href="#orgfc397d4">All Pods on a Node</a></h3>
<div class="outline-text-3" id="text-orgfc397d4">
<div class="org-src-container">
<pre class="src src-sh">kubectl describe node $<span style="color: #dcaeea;">NodeName</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">kubectl get pods --all-namespaces <span style="color: #98be65;">\</span>
        --field-selector spec.nodeName=$<span style="color: #dcaeea;">NodeName</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6a69325" class="outline-3">
<h3 id="org6a69325"><a href="#org6a69325">SSH to a Pod's Node</a></h3>
<div class="outline-text-3" id="text-org6a69325">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #dcaeea;">node</span>=$(kubectl get pod <span style="color: #98be65;">\</span>
               -o=custom-columns=NODE:.spec.nodeName $<span style="color: #dcaeea;">applianceConfigPod</span> <span style="color: #98be65;">\</span>
           | sed -n 2p)
<span style="color: #dcaeea;">ip</span>=$(kubectl get node $<span style="color: #dcaeea;">node</span> <span style="color: #98be65;">\</span>
             -o <span style="color: #dcaeea;">jsonpath</span>=<span style="color: #98be65;">'{ $.status.addresses[?(@.type=="ExternalIP")].address }'</span>)
</pre>
</div>

<p>
Now, <code>ssh user@nodeIp</code>
</p>
</div>
</div>
</div>

<div id="outline-container-org9ad62fb" class="outline-2">
<h2 id="org9ad62fb"><a href="#org9ad62fb">Pods</a></h2>
<div class="outline-text-2" id="text-org9ad62fb">
</div>
<div id="outline-container-orgb9bf892" class="outline-3">
<h3 id="orgb9bf892"><a href="#orgb9bf892">List Containers in a Pod</a></h3>
<div class="outline-text-3" id="text-orgb9bf892">
<div class="org-src-container">
<pre class="src src-sh">kubectl get pod $<span style="color: #dcaeea;">pod</span> -o json | jq -r <span style="color: #98be65;">'.spec.containers[].name'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbb91d47" class="outline-3">
<h3 id="orgbb91d47"><a href="#orgbb91d47">What Node is this Pod on?</a></h3>
<div class="outline-text-3" id="text-orgbb91d47">
<div class="org-src-container">
<pre class="src src-sh">kubectl get pod <span style="color: #98be65;">\</span>
        -o custom-columns=NODE:.spec.nodeName <span style="color: #98be65;">\</span>
        $<span style="color: #dcaeea;">pod</span> <span style="color: #98be65;">\</span>
    | sed -n 2p
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgaba1171" class="outline-2">
<h2 id="orgaba1171"><a href="#orgaba1171">Secrets</a></h2>
<div class="outline-text-2" id="text-orgaba1171">
</div>
<div id="outline-container-org6e91b01" class="outline-3">
<h3 id="org6e91b01"><a href="#org6e91b01">Create Docker Registry Secret</a></h3>
<div class="outline-text-3" id="text-org6e91b01">
<div class="org-src-container">
<pre class="src src-sh">kubectl create secret docker-registry $<span style="color: #dcaeea;">SecretName</span> <span style="color: #98be65;">\</span>
        --docker-server=$<span style="color: #dcaeea;">Server</span> <span style="color: #98be65;">\</span>
        --docker-username=$<span style="color: #dcaeea;">User</span> <span style="color: #98be65;">\</span>
        --docker-password=$<span style="color: #dcaeea;">Password</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd7b8897" class="outline-3">
<h3 id="orgd7b8897"><a href="#orgd7b8897">Decode Docker Registry Secret</a></h3>
<div class="outline-text-3" id="text-orgd7b8897">
<p>
TODO: also decode <code>=.auths["registry.ironnet.cloud"].auth</code>
</p>

<div class="org-src-container">
<pre class="src src-sh">kubectl get secret $<span style="color: #dcaeea;">SecretName</span> -o json <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.data[".dockerconfigjson"]'</span> <span style="color: #98be65;">\</span>
    | base64 --decode | jq
</pre>
</div>
</div>
</div>

<div id="outline-container-orgae003de" class="outline-3">
<h3 id="orgae003de"><a href="#orgae003de">Update a Secret</a></h3>
<div class="outline-text-3" id="text-orgae003de">
<div class="org-src-container">
<pre class="src src-sh">kubectl create secret docker-registry $<span style="color: #dcaeea;">SecretName</span> <span style="color: #98be65;">\</span>
        --docker-server=$<span style="color: #dcaeea;">Server</span> <span style="color: #98be65;">\</span>
        --docker-username=$<span style="color: #dcaeea;">User</span> <span style="color: #98be65;">\</span>
        --docker-password=$<span style="color: #dcaeea;">Password</span> <span style="color: #98be65;">\</span>
        --dry-run=client -o yaml | kubectl apply -f -
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org406ba03" class="outline-2">
<h2 id="org406ba03"><a href="#org406ba03">Services</a></h2>
<div class="outline-text-2" id="text-org406ba03">
</div>
<div id="outline-container-org987f840" class="outline-3">
<h3 id="org987f840"><a href="#org987f840">Get Services of Type</a></h3>
<div class="outline-text-3" id="text-org987f840">
<p>
Get all services of type NodePort/LoadBalancer/ClusterIP:
</p>

<div class="org-src-container">
<pre class="src src-sh">kubectl get services --all-namespaces -o json <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.items[]</span>
<span style="color: #98be65;">          | select(.spec.type == "LoadBalancer")</span>
<span style="color: #98be65;">          | .metadata.name'</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org8cfa95f" class="outline-2">
<h2 id="org8cfa95f"><a href="#org8cfa95f">Service Accounts</a></h2>
<div class="outline-text-2" id="text-org8cfa95f">
<p>
Get the default service account:
</p>

<div class="org-src-container">
<pre class="src src-sh">kubectl get secret -o json <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.items[]</span>
<span style="color: #98be65;">          | select(.metadata.annotations["kubernetes.io/service-account.name"] == "default")'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc519080" class="outline-2">
<h2 id="orgc519080"><a href="#orgc519080">StorageClass</a></h2>
<div class="outline-text-2" id="text-orgc519080">
<p>
Get the default StorageClass:
</p>

<div class="org-src-container">
<pre class="src src-sh">kubectl get sc <span style="color: #98be65;">\</span>
        -o json <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.items[].metadata</span>
<span style="color: #98be65;">          | select(.annotations."storageclass.kubernetes.io/is-default-class" == "true")</span>
<span style="color: #98be65;">          | .name'</span>
</pre>
</div>

<div class="results">#+RESULTS:</div><pre class="example">
kops-ssd-1-17
</pre>


<div class="org-src-container">
<pre class="src src-sh">kubectl get sc <span style="color: #98be65;">\</span>
        -o json <span style="color: #98be65;">\</span>
    | jq -c <span style="color: #98be65;">'.items[].metadata</span>
<span style="color: #98be65;">             | { "name": .name,</span>
<span style="color: #98be65;">                 "default?": .annotations."storageclass.kubernetes.io/is-default-class" }'</span>
</pre>
</div>

<div class="results">#+RESULTS:</div><pre class="example">
{"name":"default","default?":null}
{"name":"gp2","default?":"false"}
{"name":"gp3-250","default?":null}
{"name":"kops-ssd-1-17","default?":"true"}
{"name":"local","default?":"false"}
{"name":"st1","default?":"false"}
</pre>
</div>
</div>

<div id="outline-container-org724d4fc" class="outline-2">
<h2 id="org724d4fc"><a href="#org724d4fc">Running Commands in Cluster</a></h2>
<div class="outline-text-2" id="text-org724d4fc">
</div>
<div id="outline-container-org116e482" class="outline-3">
<h3 id="org116e482"><a href="#org116e482">Create a temporary pod</a></h3>
<div class="outline-text-3" id="text-org116e482">
<p>
Start a shell in a temporary pod in the namespace you want to test:
</p>

<div class="org-src-container">
<pre class="src src-sh">kubectl run -it --rm --restart=Never alpine --image=alpine sh
apk add curl
</pre>
</div>
</div>
</div>

<div id="outline-container-org11df49e" class="outline-3">
<h3 id="org11df49e"><a href="#org11df49e">Exec in an existing pod</a></h3>
<div class="outline-text-3" id="text-org11df49e">
<p>
If the pod has multiple containers, use <code>-c $containerName</code> as well.
</p>

<div class="org-src-container">
<pre class="src src-sh">kubectl exec $<span style="color: #dcaeea;">podName</span> -- &lt;COMMAND&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-orge31dfa9" class="outline-3">
<h3 id="orge31dfa9"><a href="#orge31dfa9">Port forwarding with kubectl</a></h3>
<div class="outline-text-3" id="text-orge31dfa9">
<div class="org-src-container">
<pre class="src src-sh">kubectl port-forward $<span style="color: #dcaeea;">podName</span> 8000:8000 -n $<span style="color: #dcaeea;">namespace</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orge74035d" class="outline-2">
<h2 id="orge74035d"><a href="#orge74035d">Using the API directily</a></h2>
<div class="outline-text-2" id="text-orge74035d">
<p>
<a href="https://kubernetes.io/docs/tasks/administer-cluster/access-cluster-api/#without-kubectl-proxy">https://kubernetes.io/docs/tasks/administer-cluster/access-cluster-api/#without-kubectl-proxy</a>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #dcaeea;">APISERVER</span>=$(kubectl config view <span style="color: #98be65;">\</span>
                    --minify <span style="color: #98be65;">\</span>
                    -o <span style="color: #dcaeea;">jsonpath</span>=<span style="color: #98be65;">'{.clusters[0].cluster.server}'</span>)

<span style="color: #dcaeea;">SA</span>=$(kubectl get serviceaccount default -o <span style="color: #dcaeea;">jsonpath</span>=<span style="color: #98be65;">'{.secrets[0].name}'</span>)
<span style="color: #dcaeea;">TOKEN</span>=$(kubectl get secret $<span style="color: #dcaeea;">SA</span> -o <span style="color: #dcaeea;">jsonpath</span>=<span style="color: #98be65;">'{.data.token}'</span> | base64 --decode )
curl $<span style="color: #dcaeea;">APISERVER</span>/api --header <span style="color: #98be65;">"Authorization: Bearer $TOKEN"</span> --insecure
</pre>
</div>
</div>
</div>

<div id="outline-container-orgce6c22a" class="outline-2">
<h2 id="orgce6c22a"><a href="#orgce6c22a">Debugging</a></h2>
<div class="outline-text-2" id="text-orgce6c22a">
</div>
<div id="outline-container-orgc3d316e" class="outline-3">
<h3 id="orgc3d316e"><a href="#orgc3d316e">Startig a busybox pod</a></h3>
<div class="outline-text-3" id="text-orgc3d316e">
<div class="org-src-container">
<pre class="src src-sh">kubectl run -i -t busybox --image=busybox --restart=Never
</pre>
</div>

<p>
Get a shell on that pod
</p>

<div class="org-src-container">
<pre class="src src-sh">kubectl exec -it &lt;name-of-pod&gt; -n my-ns sh
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org85069bd" class="outline-2">
<h2 id="org85069bd"><a href="#org85069bd">etcd</a></h2>
<div class="outline-text-2" id="text-org85069bd">
<p>
Pod to help with connecting
</p>

<div class="org-src-container">
<pre class="src src-sh">curl -LO git.io/etcdclient.yaml
</pre>
</div>

<p>
Which gets:
<a href="https://gist.githubusercontent.com/mauilion/2bab4b00eb7a0ab4fca7023ae251e8ee/raw/etcdclient.yaml">https://gist.githubusercontent.com/mauilion/2bab4b00eb7a0ab4fca7023ae251e8ee/raw/etcdclient.yaml</a>
</p>

<p>
Or, just ssh to the master, and download etcdctl on the master node.
</p>

<p>
Try looking at a secret at /registry/secrets/default/mysecret
</p>
</div>
</div>

<div id="outline-container-orgbc8d4a8" class="outline-2">
<h2 id="orgbc8d4a8"><a href="#orgbc8d4a8">Autoscaling</a></h2>
<div class="outline-text-2" id="text-orgbc8d4a8">
<p>
There are two kinds of autoscaling in Kubernetes:
</p>

<ol class="org-ol">
<li>Scaling the number of Pods in Deployments/StatefulSets</li>
<li>Scaling the number of Nodes in the Cluster</li>
</ol>
</div>

<div id="outline-container-org8268299" class="outline-3">
<h3 id="org8268299"><a href="#org8268299">Scaling Pods</a></h3>
<div class="outline-text-3" id="text-org8268299">
</div>
<div id="outline-container-org1650b82" class="outline-4">
<h4 id="org1650b82"><a href="#org1650b82">Horizontal Pod Autoscaler</a></h4>
<div class="outline-text-4" id="text-org1650b82">
<p>
Kubernetes has a built-in autoscaling mechanism called the Horizontal Pod
Autoscaler. An HPA can be created and configured using standard Kubernetes
objects:
</p>

<div class="org-src-container">
<pre class="src src-sh">kubectl get hpa
</pre>
</div>

<p>
Also, HPAs can be created with the special <code>kubectl autoscale</code> command:
</p>

<div class="org-src-container">
<pre class="src src-sh">kubectl autoscale rs foo --min=2 --max=5 --cpu-percent=80
</pre>
</div>

<p>
The HPA supports scaling based on metrics exposed through the Kubernetes
Metrics API (i.e. what <code>kubectl top</code> uses). I think this means you need a
metrics-server pod running in your cluster.
</p>
</div>
</div>
</div>

<div id="outline-container-orgec38b65" class="outline-3">
<h3 id="orgec38b65"><a href="#orgec38b65">Scaling Nodes</a></h3>
</div>
</div>
</div>
</body>
</html>
