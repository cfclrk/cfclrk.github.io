<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Python</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/static/main.css" />
</head>
<body>
<div id="preamble" class="status">
<nav id="navbar" class="cf">
  <ul class="cf">
    <li class="fl">
      <a href="/">cfclrk</a>
    </li>
    <li class="fr">
      <a href="/articles/home.html">Articles</a>
    </li>
    <li class="fr">
      <a href="/notes/home.html">Notes</a>
    </li>
	<li class="fr">
      <a href="/cloudformation/home.html">CloudFormation</a>
    </li>
  </ul>
</nav>
</div>
<div id="content" class="content">
<header>
<h1 class="title">Python</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org71605a4">Pyenv</a>
<ul>
<li><a href="#org5974d4f">Latest Version</a></li>
</ul>
</li>
<li><a href="#org8a626e9">Using a src directory</a></li>
<li><a href="#orgf4fbf12">Packaging</a>
<ul>
<li><a href="#org01a5b8e">Kinds of Packages</a>
<ul>
<li><a href="#orgb2c5e70">wheel (.whl)</a></li>
<li><a href="#org43fffbc">Source Tree (git)</a></li>
<li><a href="#orge0582ad">Source Distribution (sdist)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org99e12e1">Package summary info</a>
<ul>
<li><a href="#orgbf7218f">sys.path</a></li>
<li><a href="#org9af9156">site</a></li>
</ul>
</li>
<li><a href="#org8a4f8c5">Class attributes</a></li>
<li><a href="#org6a01032">Require zip of github repo</a></li>
<li><a href="#orgef29f09">Strings</a>
<ul>
<li><a href="#org662ad81">Unicode</a></li>
<li><a href="#org56be7ea">Decode: convert bytes to UTF-8 string</a></li>
<li><a href="#org69e41b4">Encode: convert UTF-8 string to bytes</a></li>
</ul>
</li>
<li><a href="#org419be53">Random String</a></li>
<li><a href="#org895c053">How I Set Up Python</a></li>
</ul>
</div>
</nav>

<div id="outline-container-org71605a4" class="outline-2">
<h2 id="org71605a4"><a href="#org71605a4">Pyenv</a></h2>
<div class="outline-text-2" id="text-org71605a4">
</div>
<div id="outline-container-org5974d4f" class="outline-3">
<h3 id="org5974d4f"><a href="#org5974d4f">Latest Version</a></h3>
<div class="outline-text-3" id="text-org5974d4f">
<p>
In fish, you don't need the <code>\</code> in <code>dev\|rc</code>.
</p>

<div class="org-src-container">
<pre class="src src-sh" id="orgd6124d9">python-build --definitions <span style="color: #98be65;">\</span>
    | grep <span style="color: #98be65;">"^3"</span> <span style="color: #98be65;">\</span>
    | grep -v <span style="color: #98be65;">"dev\|rc"</span> <span style="color: #98be65;">\</span>
    | tail -n 1
</pre>
</div>

<div class="results">#+RESULTS:</div><pre class="example">
3.11.0a2
</pre>
</div>
</div>
</div>

<div id="outline-container-org8a626e9" class="outline-2">
<h2 id="org8a626e9"><a href="#org8a626e9">Using a src directory</a></h2>
<div class="outline-text-2" id="text-org8a626e9">
<ul class="org-ul">
<li><a href="https://blog.ionelmc.ro/2014/05/25/python-packaging/">Packaging a python library</a> (Ionel Cristian Mărieș)</li>
<li><a href="https://hynek.me/articles/testing-packaging/">Testing &amp; Packaging</a> (Hynek Schlawack)</li>
</ul>

<p>
I am currently a fan of the <code>src</code> directory. The main reasons for this are:
</p>

<ul class="org-ul">
<li>Ionel's first point about <i>import parity</i>; it is important that all your
top-level repo cruft isn't on your <code>sys.path</code> during local development.</li>
<li>A directory named <code>src</code> is explicit and says what it is.</li>
<li>Different python projects can have a more similar top-level directory layout
and a more similar <code>setup.cfg</code>.</li>
</ul>
</div>
</div>

<div id="outline-container-orgf4fbf12" class="outline-2">
<h2 id="orgf4fbf12"><a href="#orgf4fbf12">Packaging</a></h2>
<div class="outline-text-2" id="text-orgf4fbf12">
</div>
<div id="outline-container-org01a5b8e" class="outline-3">
<h3 id="org01a5b8e"><a href="#org01a5b8e">Kinds of Packages</a></h3>
<div class="outline-text-3" id="text-org01a5b8e">
<p>
From: <a href="https://bernat.tech/posts/pep-517-and-python-packaging/">https://bernat.tech/posts/pep-517-and-python-packaging/</a>
</p>
</div>

<div id="outline-container-orgb2c5e70" class="outline-4">
<h4 id="orgb2c5e70"><a href="#orgb2c5e70">wheel (.whl)</a></h4>
<div class="outline-text-4" id="text-orgb2c5e70">
<p>
The project is built and then zipped up. Building usually means executing
setuptools, which in turn may call build scripts in the project.
</p>

<p>
If the package includes native extensions, they are complied. This means a
separate wheel must be created and published for each computer architecture.
</p>

<p>
The zip includes the source code, the <code>.dist_info</code> directory, and potentiall
compiled native extensions. During a <code>pip install</code>, pip only needs to
extract the zip in the right location.
</p>
</div>
</div>

<div id="outline-container-org43fffbc" class="outline-4">
<h4 id="org43fffbc"><a href="#org43fffbc">Source Tree (git)</a></h4>
<div class="outline-text-4" id="text-org43fffbc">
<p>
Every file in the project's VC repository.
</p>
</div>
</div>

<div id="outline-container-orge0582ad" class="outline-4">
<h4 id="orge0582ad"><a href="#orge0582ad">Source Distribution (sdist)</a></h4>
<div class="outline-text-4" id="text-orge0582ad">
<p>
A zip of the project source code. It may not include <i>all</i> files in the
repository, like the <code>.git/</code>, <code>.github/</code>, <code>Jenkinsfile</code>, and tests (but I
think it can, right?). It must <i>at least</i> include the Python source code and
files required to build the project (<code>setup.cfg</code>, etc).
</p>

<p>
Does not include a <code>.dist_info/</code> or compiled extensions. During a <code>pip
    install</code>, pip needs to build the package, which usually means executing
<code>setuptools</code>, which in turn may call build scripts.
</p>

<p>
The installing user must:
</p>

<ul class="org-ul">
<li>Have an appropriate version of <code>setuptools</code></li>
<li>Have the tools required by the project build scripts</li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-org99e12e1" class="outline-2">
<h2 id="org99e12e1"><a href="#org99e12e1">Package summary info</a></h2>
<div class="outline-text-2" id="text-org99e12e1">
</div>
<div id="outline-container-orgbf7218f" class="outline-3">
<h3 id="orgbf7218f"><a href="#orgbf7218f">sys.path</a></h3>
<div class="outline-text-3" id="text-orgbf7218f">
<p>
As explained in the <a href="https://docs.python.org/3/library/sys.html#sys.path">docs</a>, the first element of <code>sys.path</code> is often the empty
string.
</p>

<blockquote>
<p>
&#x2026; the first item of this list, <code>path[0]</code>, is the directory containing the
script that was used to invoke the Python interpreter. If the script
directory is not available (e.g. if the interpreter is invoked interactively
or if the script is read from standard input), path[0] is the empty string,
which directs Python to search modules in the current directory first.
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #51afef;">import</span> sys; <span style="color: #51afef;">return</span> sys.path
</pre>
</div>
</div>
</div>

<div id="outline-container-org9af9156" class="outline-3">
<h3 id="org9af9156"><a href="#org9af9156">site</a></h3>
<div class="outline-text-3" id="text-org9af9156">
<p>
Print a summary including <code>sys.path</code> and some other stuff.
</p>

<div class="org-src-container">
<pre class="src src-sh">python -m site
</pre>
</div>

<p>
Interactively, in a python interpreter, <code>site_script()</code> prints some nice
stuff, but it causes the interpreter to exit! Ok for org-mode, not great for
an interactive python session.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #51afef;">import</span> site
site._script()
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org8a4f8c5" class="outline-2">
<h2 id="org8a4f8c5"><a href="#org8a4f8c5">Class attributes</a></h2>
<div class="outline-text-2" id="text-org8a4f8c5">
<p>
Define a class:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">Pizza</span>(<span style="color: #c678dd;">object</span>):
    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">__init__</span>(<span style="color: #51afef;">self</span>, size):
        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">size</span> = size
    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">get_size</span>(<span style="color: #51afef;">self</span>):
        <span style="color: #51afef;">return</span> <span style="color: #51afef;">self</span>.size
</pre>
</div>

<p>
Create an instance:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #dcaeea;">p</span> = Pizza(8)
</pre>
</div>

<p>
From: <a href="https://blog.ionelmc.ro/2015/02/09/understanding-python-metaclasses/#object-attribute-lookup">https://blog.ionelmc.ro/2015/02/09/understanding-python-metaclasses/#object-attribute-lookup</a>
</p>

<p>
Now, calling <code>p.get_size()</code> or <code>p.size</code> roughly equates to:
</p>

<ol class="org-ol">
<li>Call the type slot for <code>Class.__getattribute__(attribute)</code>. The default
does this:

<ul class="org-ul">
<li>Does <code>Pizza.__dict__</code> have a <code>size</code> (or <code>get_size</code>) that has a <code>__get__</code>
method and is a data descriptor? (size: no, get<sub>size</sub>: no). Note:
functions are not data descriptors. A data descriptor must have at least
a <code>__set__</code> OR a <code>__delete__</code> attribute.</li>

<li>Else, does <code>p.__dict__</code> have a <code>size</code> (or <code>get_size</code>) item in it? (size:
yes, get<sub>size</sub>: no)</li>

<li>Else, does <code>Pizza.__dict__</code> have a <code>size</code> (or <code>get_size</code>) item that is
<b>not</b> a data descriptor?</li>
</ul></li>
</ol>

<div class="org-src-container">
<pre class="src src-python">Pizza.<span style="color: #c678dd;">__dict__</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python">Pizza.<span style="color: #c678dd;">__dict__</span>[<span style="color: #98be65;">"get_size"</span>].__get__(p, Pizza)()
</pre>
</div>
</div>
</div>

<div id="outline-container-org6a01032" class="outline-2">
<h2 id="org6a01032"><a href="#org6a01032">Require zip of github repo</a></h2>
<div class="outline-text-2" id="text-org6a01032">
<p>
You can get a tarball or zipball of a repo as documented here:
<a href="https://developer.github.com/v3/repos/contents/#get-archive-link">https://developer.github.com/v3/repos/contents/#get-archive-link</a>
</p>

<p>
In requirements.txt, you can do something like
<a href="https://github.com/cfclrk/python-demo/zipball/master#egg=botocore">https://github.com/cfclrk/python-demo/zipball/master#egg=botocore</a>
</p>

<p>
e.g. see:
<a href="https://github.com/aws/aws-cli/blob/1973ca9709d41121b45c1a0d764ef6788028c708/requirements.txt#L6">https://github.com/aws/aws-cli/blob/1973ca9709d41121b45c1a0d764ef6788028c708/requirements.txt#L6</a>
</p>
</div>
</div>

<div id="outline-container-orgef29f09" class="outline-2">
<h2 id="orgef29f09"><a href="#orgef29f09">Strings</a></h2>
<div class="outline-text-2" id="text-orgef29f09">
</div>
<div id="outline-container-org662ad81" class="outline-3">
<h3 id="org662ad81"><a href="#org662ad81">Unicode</a></h3>
<div class="outline-text-3" id="text-org662ad81">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #51afef;">return</span> <span style="color: #c678dd;">len</span>(<span style="color: #98be65;">"&#128514;"</span>)
</pre>
</div>

<div class="results">#+RESULTS:</div><pre class="example">
1
</pre>


<p>
From: <a href="https://hsivonen.fi/string-length/">https://hsivonen.fi/string-length/</a>
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #51afef;">return</span> <span style="color: #c678dd;">len</span>(<span style="color: #98be65;">"&#129318;&#127996;&#8205;&#9794;&#65039;"</span>)
</pre>
</div>

<div class="results">#+RESULTS:</div><pre class="example">
5
</pre>
</div>
</div>

<div id="outline-container-org56be7ea" class="outline-3">
<h3 id="org56be7ea"><a href="#org56be7ea">Decode: convert bytes to UTF-8 string</a></h3>
<div class="outline-text-3" id="text-org56be7ea">
<p>
A "byte string" is a byte literal, which is an immutable sequence of bytes
(integers). A byte literal can be defined using ASCII characters up
through 127. Byte values 128-256 can be specified using an escape sequence or
hex codes (see: <a href="https://docs.python.org/3/library/stdtypes.html#bytes-objects">Bytes Objects</a>).
</p>

<p>
For example, this works:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #dcaeea;">foo</span>=b<span style="color: #98be65;">"foo"</span>
</pre>
</div>

<p>
But this does not:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #dcaeea;">bar</span>=b<span style="color: #98be65;">"&#1054;&#1060;&#1048;&#1057;"</span>
</pre>
</div>

<pre class="example" id="org2374812">
  File "&lt;stdin&gt;", line 1
SyntaxError: bytes can only contain ASCII literal characters.
</pre>

<p>
To get a Python 3 string from bytes, you must know what text encoding was
used to create the bytes. Usually, it's ASCII:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #dcaeea;">foo</span> = b<span style="color: #98be65;">"foo"</span>
<span style="color: #51afef;">return</span> foo.decode(<span style="color: #98be65;">"ascii"</span>)
</pre>
</div>

<div class="results">#+RESULTS:</div><pre class="example">
foo
</pre>


<p>
What's going on is:
</p>

<ul class="org-ul">
<li><code>foo</code> is a byte literal (array of integers)</li>
<li>For each array item, decode it using the ASCII codec, then encode it with UTF-8</li>
<li>The result is a UTF-8 encoded string</li>
</ul>
</div>
</div>

<div id="outline-container-org69e41b4" class="outline-3">
<h3 id="org69e41b4"><a href="#org69e41b4">Encode: convert UTF-8 string to bytes</a></h3>
<div class="outline-text-3" id="text-org69e41b4">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #51afef;">return</span> <span style="color: #98be65;">"foo"</span>.encode(<span style="color: #98be65;">"ascii"</span>)
</pre>
</div>

<div class="results">#+RESULTS:</div><pre class="example">
b'foo'
</pre>


<div class="org-src-container">
<pre class="src src-python"><span style="color: #dcaeea;">bar</span>=<span style="color: #98be65;">"&#1054;&#1060;&#1048;&#1057;"</span>
<span style="color: #51afef;">return</span> bar.encode(<span style="color: #98be65;">"utf-8"</span>)
</pre>
</div>

<div class="results">#+RESULTS:</div><pre class="example">
b'\xd0\x9e\xd0\xa4\xd0\x98\xd0\xa1'
</pre>


<div class="org-src-container">
<pre class="src src-python"><span style="color: #51afef;">return</span>  <span style="color: #98be65;">"&#128514;"</span>.encode(<span style="color: #98be65;">"ascii"</span>)
</pre>
</div>

<p>
Prints:
</p>

<pre class="example" id="org2f20d96">
&gt;&gt;&gt; "😂".encode("ascii")
Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
UnicodeEncodeError: 'ascii' codec can't encode
character '\U0001f602' in position 0: ordinal not
in range(128)
</pre>
</div>
</div>
</div>

<div id="outline-container-org419be53" class="outline-2">
<h2 id="org419be53"><a href="#org419be53">Random String</a></h2>
<div class="outline-text-2" id="text-org419be53">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #51afef;">import</span> random
<span style="color: #51afef;">import</span> string
<span style="color: #51afef;">return</span> <span style="color: #98be65;">""</span>.join(random.choice(string.ascii_letters) <span style="color: #51afef;">for</span> _ <span style="color: #51afef;">in</span> <span style="color: #c678dd;">range</span>(8))
</pre>
</div>

<div class="results">#+RESULTS:</div><pre class="example">
knMyinMG
</pre>
</div>
</div>

<div id="outline-container-org895c053" class="outline-2">
<h2 id="org895c053"><a href="#org895c053">How I Set Up Python</a></h2>
<div class="outline-text-2" id="text-org895c053">
<p>
Use <code>pyenv</code> to install python versions, and <code>pyenv-virtualenv</code> to create
virtual environments per project.
</p>

<p>
First, install a couple versions of python.
</p>

<div class="org-src-container">
<pre class="src src-bash">pyenv install $<span style="color: #dcaeea;">LatestPython</span>
pyenv install 3.6.8
</pre>
</div>

<p>
I set <code>pyenv global</code> to the latest python I have installed. This is so that
one-off python commands on the CLI use a tolerable version of python
regardless of what directory the CLI is in.
</p>

<p>
I actually set <code>pyenv global</code> to a virtual environment based on the latest
python I have installed. This way, whenever the global python environment gets
too cluttered with pip packages, I just blow it away and recreate it.
</p>

<p>
Global virtual environment name:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org667a792"><span style="color: #c678dd;">echo</span> $<span style="color: #dcaeea;">LatestPython</span> | sed s/<span style="color: #98be65;">\\</span>.//g
</pre>
</div>

<div class="results">#+RESULTS:</div><pre class="example">
397
</pre>


<p>
Create a virtual environment for the global python, and set <code>pyenv global</code> to
it.
</p>

<div class="org-src-container">
<pre class="src src-bash">pyenv virtualenv $<span style="color: #dcaeea;">LatestPython</span> $<span style="color: #dcaeea;">GlobalVenv</span>
pyenv global $<span style="color: #dcaeea;">GlobalVenv</span>
</pre>
</div>
</div>
</div>
</div>
</body>
</html>
