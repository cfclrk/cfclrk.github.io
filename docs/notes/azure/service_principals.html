<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Service Principals</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/static/main.css" />
</head>
<body>
<div id="preamble" class="status">
<nav id="navbar" class="cf">
  <ul class="cf">
    <li class="fl">
      <a href="/">cfclrk</a>
    </li>
    <li class="fr">
      <a href="/articles/home.html">Articles</a>
    </li>
    <li class="fr">
      <a href="/notes/home.html">Notes</a>
    </li>
	<li class="fr">
      <a href="/cloudformation/home.html">CloudFormation</a>
    </li>
  </ul>
</nav>
</div>
<div id="content" class="content">
<header>
<h1 class="title">Service Principals</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org7d0bb0a">Read</a></li>
<li><a href="#orgfd38f37">CLI Login with a Service Principal</a></li>
<li><a href="#org7fae70b">Create</a>
<ul>
<li><a href="#org33a224f">Contributer Role (default?)</a></li>
<li><a href="#org739b2d9">Owner Role</a></li>
<li><a href="#org641c5ed">Grant more perms</a></li>
</ul>
</li>
<li><a href="#org4ed9f0a">List</a></li>
<li><a href="#orga396001">Describe</a>
<ul>
<li><a href="#org238c689">Using service principal name</a></li>
<li><a href="#orgb6be225">Using service principal client id</a></li>
</ul>
</li>
<li><a href="#org947f5b5">Delete</a></li>
<li><a href="#org80ea1f5">View Role Assignments</a>
<ul>
<li><a href="#orgacff6f7">Role Assignments Scoped to this Subscription</a></li>
<li><a href="#orge22903c">Role Assignments Scoped to Another Subscription</a></li>
</ul>
</li>
<li><a href="#orge9c492c">Grant Access to Another Subscription</a>
<ul>
<li><a href="#orgec8bd63">Create Role Assignment</a></li>
<li><a href="#orge663646">View the new role assignment</a></li>
</ul>
</li>
</ul>
</div>
</nav>

<div id="outline-container-org7d0bb0a" class="outline-2">
<h2 id="org7d0bb0a"><a href="#org7d0bb0a">Read</a></h2>
<div class="outline-text-2" id="text-org7d0bb0a">
<p>
<a href="https://serverfault.com/questions/889976/how-to-give-azure-service-principal-the-same-rights-as-my-own-user?rq=1">https://serverfault.com/questions/889976/how-to-give-azure-service-principal-the-same-rights-as-my-own-user?rq=1</a>
<a href="https://github.com/Azure/azure-sdk-for-node/issues/2363#issuecomment-354897064">https://github.com/Azure/azure-sdk-for-node/issues/2363#issuecomment-354897064</a>
</p>
</div>
</div>

<div id="outline-container-orgfd38f37" class="outline-2">
<h2 id="orgfd38f37"><a href="#orgfd38f37">CLI Login with a Service Principal</a></h2>
<div class="outline-text-2" id="text-orgfd38f37">
<p>
The <code>appId</code> is the <code>AZURE_CLIENT_ID</code> and the <code>password</code> is the
<code>AZURE_CLIENT_SECRET</code>.
</p>

<div class="org-src-container">
<pre class="src src-sh">az login --service-principal <span style="color: #98be65;">\</span>
   --username $<span style="color: #dcaeea;">AZURE_CLIENT_ID</span> <span style="color: #98be65;">\</span>
   --password $<span style="color: #dcaeea;">AZURE_CLIENT_SECRET</span> <span style="color: #98be65;">\</span>
   --tenant $<span style="color: #dcaeea;">AZURE_TENANT_ID</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7fae70b" class="outline-2">
<h2 id="org7fae70b"><a href="#org7fae70b">Create</a></h2>
<div class="outline-text-2" id="text-org7fae70b">
<p>
Create a service principal called "foo" (the name will actually be
<code>http://foo</code>). Service principals are global to an Azure Tenant (not, as one
might think, to a Subscription). The subscriptions or resources that a Service
Principal can see are controlled by the Role Assignments attached to the
Service Principal.
</p>
</div>

<div id="outline-container-org33a224f" class="outline-3">
<h3 id="org33a224f"><a href="#org33a224f">Contributer Role (default?)</a></h3>
<div class="outline-text-3" id="text-org33a224f">
<p>
By default, the service principal will have the "owner" role (is this true
anymore?).
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org6b0d29f">az ad sp create-for-rbac -n foo
</pre>
</div>
</div>
</div>

<div id="outline-container-org739b2d9" class="outline-3">
<h3 id="org739b2d9"><a href="#org739b2d9">Owner Role</a></h3>
<div class="outline-text-3" id="text-org739b2d9">
<p>
Just pass a <code>--role owner</code>.
</p>
</div>
</div>

<div id="outline-container-org641c5ed" class="outline-3">
<h3 id="org641c5ed"><a href="#org641c5ed">Grant more perms</a></h3>
<div class="outline-text-3" id="text-org641c5ed">
<p>
By default, a service principal can't do as much as a User, even if the
service principal has the Owner role. This is because Azure is stupid.
</p>

<p>
To allow an Azure service principal to create new service principals:
</p>

<ol class="org-ol">
<li>Click on your service principal in Azure Active Directory -&gt; App
registrations.</li>
<li>Go to Settings -&gt; Required permissions.</li>
<li>Add four permissions for Windows Azure Active Directory:
<ul class="org-ul">
<li>Read and write all applications</li>
<li>Manage apps that this app creates or owns</li>
<li>Read and write directory data</li>
<li>Read directory data</li>
</ul></li>
<li>Save.</li>
<li>Click “Grant permissions” and confirm. This step can only be performed by
a Global AD Admin, which you are now in both public and government
tenants.</li>
</ol>

<p>
More info: <a href="https://github.com/Azure/azure-sdk-for-node/issues/2363#issuecomment-354897064">https://github.com/Azure/azure-sdk-for-node/issues/2363#issuecomment-354897064</a>
</p>
</div>
</div>
</div>

<div id="outline-container-org4ed9f0a" class="outline-2">
<h2 id="org4ed9f0a"><a href="#org4ed9f0a">List</a></h2>
<div class="outline-text-2" id="text-org4ed9f0a">
<div class="org-src-container">
<pre class="src src-sh">az ad sp list <span style="color: #98be65;">\</span>
   --query <span style="color: #98be65;">"[?appOwnerTenantId=='$AZURE_TENANT_ID'].displayName"</span> <span style="color: #98be65;">\</span>
   --all
</pre>
</div>

<p>
Or, by a more readable publisher name:
</p>

<div class="org-src-container">
<pre class="src src-sh">az ad sp list --all --query <span style="color: #98be65;">"[?publisherName=="</span>Fugue<span style="color: #98be65;">"].displayName"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga396001" class="outline-2">
<h2 id="orga396001"><a href="#orga396001">Describe</a></h2>
<div class="outline-text-2" id="text-orga396001">
</div>
<div id="outline-container-org238c689" class="outline-3">
<h3 id="org238c689"><a href="#org238c689">Using service principal name</a></h3>
<div class="outline-text-3" id="text-org238c689">
<div class="org-src-container">
<pre class="src src-sh">az ad sp show --id <span style="color: #98be65;">"http://chrisc-owner"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb6be225" class="outline-3">
<h3 id="orgb6be225"><a href="#orgb6be225">Using service principal client id</a></h3>
<div class="outline-text-3" id="text-orgb6be225">
<div class="org-src-container">
<pre class="src src-sh">az ad sp show --id $<span style="color: #dcaeea;">AZURE_CLIENT_ID</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org947f5b5" class="outline-2">
<h2 id="org947f5b5"><a href="#org947f5b5">Delete</a></h2>
<div class="outline-text-2" id="text-org947f5b5">
<div class="org-src-container">
<pre class="src src-sh">az ad sp delete --id http://foo
</pre>
</div>
</div>
</div>

<div id="outline-container-org80ea1f5" class="outline-2">
<h2 id="org80ea1f5"><a href="#org80ea1f5">View Role Assignments</a></h2>
<div class="outline-text-2" id="text-org80ea1f5">
<p>
Every service principal has 0 or more <b>role assignments</b> which, taken
together, define what the service principal is allowed to do.
</p>

<p>
A Role Assignment assigns a <i>ROLE</i> to an <i>ASSIGNEE</i> for a given <i>SCOPE</i>. A
<i>ROLE</i> is a set of permissions. Examples of some pre-defined named roles are
"Owner", "Contributor", and "KeyVault Reader". The <i>ASSIGNEE</i> is, in this
case, the Service Principal. The <i>SCOPE</i> limits permissions to a certain set
of cloud resources. Examples of scopes are a subsccription, a resource group,
or a particular cloud resource.
</p>

<p>
Apparently role assignments can only be viewed one subscription at a time?
</p>
</div>

<div id="outline-container-orgacff6f7" class="outline-3">
<h3 id="orgacff6f7"><a href="#orgacff6f7">Role Assignments Scoped to this Subscription</a></h3>
<div class="outline-text-3" id="text-orgacff6f7">
<p>
View a service principal's role assignments that are scoped to the currently
active subscription.
</p>

<div class="org-src-container">
<pre class="src src-sh">az role assignment list <span style="color: #98be65;">\</span>
   --all <span style="color: #98be65;">\</span>
   --assignee $(az ad signed-in-user show | jq -r <span style="color: #98be65;">'.objectId'</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">az role assignment list <span style="color: #98be65;">\</span>
   --assignee <span style="color: #98be65;">"http://chrisc-owner"</span> <span style="color: #98be65;">\</span>
   --all <span style="color: #98be65;">\</span>
   --include-inherited <span style="color: #98be65;">\</span>
   --include-groups
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">az ad user list --query <span style="color: #98be65;">"[?mailNickname=='chris.clark'].objectId"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge22903c" class="outline-3">
<h3 id="orge22903c"><a href="#orge22903c">Role Assignments Scoped to Another Subscription</a></h3>
<div class="outline-text-3" id="text-orge22903c">
<div class="org-src-container">
<pre class="src src-sh">az role assignment list <span style="color: #98be65;">\</span>
   --assignee <span style="color: #98be65;">"http://chrisc-owner"</span> <span style="color: #98be65;">\</span>
   --all <span style="color: #98be65;">\</span>
   --include-inherited <span style="color: #98be65;">\</span>
   --include-groups <span style="color: #98be65;">\</span>
   --subscription $<span style="color: #dcaeea;">SubscriptionId</span>
</pre>
</div>

<p>
<b>QUESTION</b>: Is there a way to see <b>all</b> role assignments for a service
principal at one time, accross all subsrcriptions? For example, what if I
want to see what subscriptions a service principal has "Contributor" access
to?
</p>
</div>
</div>
</div>

<div id="outline-container-orge9c492c" class="outline-2">
<h2 id="orge9c492c"><a href="#orge9c492c">Grant Access to Another Subscription</a></h2>
<div class="outline-text-2" id="text-orge9c492c">
<p>
To do this we create another role assignment for the service principal that
gives the service principal access to a particular subscription.
</p>
</div>

<div id="outline-container-orgec8bd63" class="outline-3">
<h3 id="orgec8bd63"><a href="#orgec8bd63">Create Role Assignment</a></h3>
<div class="outline-text-3" id="text-orgec8bd63">
<p>
In this case we will assign "Contributor" access (the <i>ROLE</i>) to the service
principal <code>http://chrisc-owner</code> (the <i>ASSIGNEE</i>) for subscription
<code>$SubscriptionId</code> (the <i>SCOPE</i>).
</p>

<div class="org-src-container">
<pre class="src src-sh">az role assignment create <span style="color: #98be65;">\</span>
   --role <span style="color: #98be65;">"Contributor"</span> <span style="color: #98be65;">\</span>
   --assignee <span style="color: #98be65;">"http://chrisc-owner"</span> <span style="color: #98be65;">\</span>
   --scope <span style="color: #98be65;">"/subscriptions/a083ee74-78e4-4afc-9848-1336af393d20"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge663646" class="outline-3">
<h3 id="orge663646"><a href="#orge663646">View the new role assignment</a></h3>
<div class="outline-text-3" id="text-orge663646">
<p>
Now you should see one role assignment for the other subscription.
</p>

<div class="org-src-container">
<pre class="src src-sh">az role assignment list <span style="color: #98be65;">\</span>
   --assignee <span style="color: #98be65;">"http://chrisc-owner"</span> <span style="color: #98be65;">\</span>
   --all <span style="color: #98be65;">\</span>
   --include-inherited <span style="color: #98be65;">\</span>
   --include-groups <span style="color: #98be65;">\</span>
   --subscription $<span style="color: #dcaeea;">SubscriptionId</span>
</pre>
</div>
</div>
</div>
</div>
</div>
</body>
</html>
