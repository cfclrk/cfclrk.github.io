<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AWS Commands</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/static/main.css" />
</head>
<body>
<div id="preamble" class="status">
<nav id="navbar" class="cf">
  <ul class="cf">
    <li class="fl">
      <a href="/">cfclrk</a>
    </li>
    <li class="fr">
      <a href="/articles/home.html">Articles</a>
    </li>
    <li class="fr">
      <a href="/notes/home.html">Notes</a>
    </li>
	<li class="fr">
      <a href="/cloudformation/home.html">CloudFormation</a>
    </li>
  </ul>
</nav>
</div>
<div id="content" class="content">
<header>
<h1 class="title">AWS Commands</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org794f761">Account</a></li>
<li><a href="#org1f7c126">IP Address Ranges</a>
<ul>
<li><a href="#org71c9ae4">Get Region of IP</a></li>
</ul>
</li>
<li><a href="#orga2c80b6">Regions</a>
<ul>
<li><a href="#org3b1ae44">All regions in partition</a></li>
<li><a href="#org87aae0d">All regions in all partitions</a></li>
<li><a href="#org6f38c66">Run a command in all regions</a>
<ul>
<li><a href="#org35f50d8">Linear</a></li>
<li><a href="#org10954f5">Parallel</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org015ee64">ACM</a>
<ul>
<li><a href="#orgaf56ddf">list-certificates</a></li>
<li><a href="#orge582349">describe-certificate</a></li>
<li><a href="#org7046c76">get-certificate</a></li>
<li><a href="#orgdb1877e">Get certificate PEM File</a></li>
</ul>
</li>
<li><a href="#orgc0dd0e1">API Gateway V2</a>
<ul>
<li><a href="#orgeb6899e">get-apis</a></li>
</ul>
</li>
<li><a href="#org01b27bf">CloudFormation</a>
<ul>
<li><a href="#org0f3b956">View Stack Log</a></li>
<li><a href="#org1e70677">List Stacks</a></li>
<li><a href="#org8d668ce">Stack Outputs</a></li>
<li><a href="#org05b8482">Get Stack Parameters</a></li>
<li><a href="#orgc5aaa62">Exports</a></li>
<li><a href="#org464bf6a">Spec Files</a></li>
</ul>
</li>
<li><a href="#org099dc4f">CloudWatch</a>
<ul>
<li><a href="#org798084f">Delete All Alarms</a></li>
<li><a href="#orgdab1a9f">Create Alarm Targeting ASG policy</a></li>
</ul>
</li>
<li><a href="#orgac55fec">CodeDeploy</a>
<ul>
<li><a href="#org10d58a9">list-deployments</a></li>
<li><a href="#org5e6a1ee">list-tags-for-resource</a></li>
</ul>
</li>
<li><a href="#orgd109f23">DynamoDB</a>
<ul>
<li><a href="#orgcd484b0">List Tables</a></li>
<li><a href="#orgf86641d">Delete Tables Like a Maniac</a></li>
</ul>
</li>
<li><a href="#org4428828">EC2 AMIs</a>
<ul>
<li><a href="#org2b53905">List AMIs</a></li>
<li><a href="#orgc7ef82e">Get Latest Image</a></li>
<li><a href="#orgc9b362b">Delete AMIs and EBS Snapshots</a></li>
<li><a href="#org69e431f">List Accounts That Can Access AMI</a></li>
</ul>
</li>
<li><a href="#org004791f">EC2 AZs</a>
<ul>
<li><a href="#orgd972451">The Actual AZ</a></li>
</ul>
</li>
<li><a href="#orge786173">EC2 KeyPairs</a>
<ul>
<li><a href="#org86b1c6a">Create</a></li>
<li><a href="#org7584c80">Describe</a></li>
<li><a href="#org82dbef7">Delete</a></li>
</ul>
</li>
<li><a href="#org802dfa8">EC2 Instances</a>
<ul>
<li><a href="#org7cca485">Get Running Instances</a></li>
<li><a href="#orgba14233">Get All Instance Tags</a></li>
<li><a href="#org3fcddfb">Get Instances with Tag Key</a></li>
<li><a href="#org880fa44">Get Instances with Tag Key/Value</a></li>
</ul>
</li>
<li><a href="#orgeb57041">EC2 Transit Gateway</a>
<ul>
<li><a href="#orgdaf548c">List Routes in a TG Route Table</a></li>
</ul>
</li>
<li><a href="#orge5506b4">EC2 VPCs</a>
<ul>
<li><a href="#org85e3a67">VPCs</a></li>
<li><a href="#org2bbb314">Subnets</a></li>
<li><a href="#org094bba0">SecurityGroups</a></li>
<li><a href="#org4bfe151">Private ALB IPs</a></li>
<li><a href="#org6b60942">Managed Prefix Lists</a></li>
</ul>
</li>
<li><a href="#orgb09cc04">EC2 Volumes</a>
<ul>
<li><a href="#org809994b">List Volumes</a></li>
<li><a href="#orgd0a9318">List Unattached Volumes</a></li>
<li><a href="#orge29a71c">Delete Volumes</a></li>
</ul>
</li>
<li><a href="#orgbb03ebe">ECR</a>
<ul>
<li><a href="#orgd6f2beb">Log in</a></li>
<li><a href="#org5b407f7">Create Repository</a></li>
<li><a href="#org1122884">Add Image</a></li>
<li><a href="#org9cd81d3">describe-registry</a></li>
<li><a href="#orgadca32b">describe-repositories</a></li>
<li><a href="#orgb71ddde">list-tags-for-resource</a></li>
</ul>
</li>
<li><a href="#org8d3d512">ECS</a>
<ul>
<li><a href="#orgdcc4f98">list-clusters</a></li>
<li><a href="#orgc613706">describe-clusters</a></li>
<li><a href="#org3c4b26c">describe-services</a></li>
<li><a href="#org39188b3">describe-task-definition</a></li>
<li><a href="#orgb5f9388">descibe-task-sets</a></li>
</ul>
</li>
<li><a href="#org7c0a659">EKS</a>
<ul>
<li><a href="#org902ce68">List Clusters</a></li>
<li><a href="#org07ccf37">Get Kube Config</a></li>
</ul>
</li>
<li><a href="#orga2776ff">Elasticache</a>
<ul>
<li><a href="#org0f79de6">List CacheClusters</a></li>
<li><a href="#org178032d">List ReplicationGroups</a></li>
</ul>
</li>
<li><a href="#orgf2eab5b">ElasticBeanstalk</a>
<ul>
<li><a href="#org3545be4">Config Options for Nampespace</a></li>
</ul>
</li>
<li><a href="#org4f6c1e4">ElasticLoadBalancingV2</a>
<ul>
<li><a href="#orgfe93821">Describe ALBs</a></li>
<li><a href="#org8c78c4c">Get DNS Name</a></li>
</ul>
</li>
<li><a href="#org15cef0e">GlobalAccelerator</a>
<ul>
<li><a href="#orgdcbeffd">List Accelerators</a></li>
<li><a href="#org5318dce">List Listeners</a></li>
<li><a href="#orgf87b5c0">IPs</a></li>
</ul>
</li>
<li><a href="#orgce07388">IAM</a>
<ul>
<li><a href="#org92d8b3d">Create Policy</a></li>
<li><a href="#org29b87dc">Describe Policy</a></li>
<li><a href="#org44188e0">Assume Role</a></li>
<li><a href="#org2ec8d74">List Instance Profiles</a></li>
<li><a href="#org17db863">Delete Instance Profile</a></li>
</ul>
</li>
<li><a href="#orge90e732">IMDS</a></li>
<li><a href="#org524a14d">Kinesis</a>
<ul>
<li><a href="#orgfb070f7">Delete Stream</a></li>
</ul>
</li>
<li><a href="#org447341c">Kinesis Firehose</a>
<ul>
<li><a href="#org538cae4">Describe Stream</a></li>
<li><a href="#org1c25db3">Update Stream S3 Destination Bucket</a></li>
<li><a href="#org9a05898">Update Stream S3 Destination Prefix</a></li>
</ul>
</li>
<li><a href="#org58ab81e">Lambda</a>
<ul>
<li><a href="#org6a93227">Invoke function</a></li>
<li><a href="#org37e6f45">Create Function with Zip File</a></li>
<li><a href="#org1da8806">Update Function code with Zip File</a></li>
<li><a href="#org61177cb">Container Image: Run Interactively</a></li>
</ul>
</li>
<li><a href="#orgdcc0535">Organizations</a></li>
<li><a href="#org77afbd8">Polly</a></li>
<li><a href="#org4f417a6">Reosurce Access Manager (RAM)</a></li>
<li><a href="#orged392ac">RDS</a>
<ul>
<li><a href="#org7f886c4">describe-db-instances</a></li>
<li><a href="#org16b6eae">modify-db-instance</a></li>
<li><a href="#org8f4c0c1">describe-db-engine-versions</a></li>
<li><a href="#org9affadf">pending maintenance actions for a DB</a></li>
<li><a href="#org550d068">create-db-snapshot</a></li>
<li><a href="#org12c6d7c">create-parameter-group</a></li>
<li><a href="#orgee75330">describe-parameter-group</a></li>
</ul>
</li>
<li><a href="#orga7f2e6b">Route53</a>
<ul>
<li><a href="#org9955e19">Get HostedZoneId from domain name</a></li>
<li><a href="#orgd48bc48">List Records for a HostedZone</a></li>
</ul>
</li>
<li><a href="#orgd2c2c24">SageMaker</a>
<ul>
<li><a href="#org11186f0">list-models</a></li>
</ul>
</li>
<li><a href="#org3882600">SecretsManager</a>
<ul>
<li><a href="#org1d541b3">List Secrets</a></li>
<li><a href="#org0b68467">Get Secret</a></li>
<li><a href="#org795edde">Create Secret</a></li>
</ul>
</li>
<li><a href="#org5f3f64c">ServiceCatalog</a>
<ul>
<li><a href="#orgca6e0d5">Get Product IDs</a></li>
<li><a href="#orgad610cf">Launch Product</a></li>
</ul>
</li>
<li><a href="#orgd46de62">Service Quotas</a>
<ul>
<li><a href="#org4b922f7">Get all service quotas</a></li>
<li><a href="#org9bacdde">Get one quota</a></li>
<li><a href="#org5938041">Get default quota</a></li>
</ul>
</li>
<li><a href="#org8cb6e83">S3</a>
<ul>
<li><a href="#orgd915749">Canonical ID</a></li>
<li><a href="#org8437c60">list-buckets</a></li>
<li><a href="#orgb569f97">Create Bucket</a></li>
<li><a href="#org3598548">List Objects</a></li>
<li><a href="#org6660dfd">Get object</a></li>
<li><a href="#org1fddda1">Get multiple objects</a></li>
<li><a href="#org5dacec5">Get Bucket Policy</a></li>
<li><a href="#orgec7aefc">Clear and delete buckets</a></li>
</ul>
</li>
<li><a href="#org154e02e">SNS</a>
<ul>
<li><a href="#org12b98d1">SNS topics</a></li>
</ul>
</li>
<li><a href="#org09ca393">SQS</a>
<ul>
<li><a href="#orgf6f0ddd">List Queues</a></li>
<li><a href="#orgd684c4d">Read Message</a></li>
<li><a href="#org21bfe09">Send Message</a></li>
</ul>
</li>
<li><a href="#orgf97ac30">SSM</a></li>
<li><a href="#org2823b6b">Identity Store (SSO)</a>
<ul>
<li><a href="#org39c2282">Register client</a></li>
<li><a href="#orgf5857a2">Token</a></li>
<li><a href="#org82aff8f">List my accounts</a></li>
<li><a href="#org3bea523">Get credentials</a></li>
</ul>
</li>
</ul>
</div>
</nav>

<div id="outline-container-org794f761" class="outline-2">
<h2 id="org794f761"><a href="#org794f761">Account</a></h2>
<div class="outline-text-2" id="text-org794f761">
<p>
Account number:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org6b7e2b4">aws sts get-caller-identity \
    --query 'Account' \
    --output text
</pre>
</div>
</div>
</div>

<div id="outline-container-org1f7c126" class="outline-2">
<h2 id="org1f7c126"><a href="#org1f7c126">IP Address Ranges</a></h2>
<div class="outline-text-2" id="text-org1f7c126">
<p>
AWS documentation is <a href="https://docs.aws.amazon.com/general/latest/gr/aws-ip-ranges.html">here</a>.
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org2f6562d">curl -s https://ip-ranges.amazonaws.com/ip-ranges.json
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">cat "$IpRanges" \
    | jq '.prefixes[]
          | select(.region = "us-east-2")
          | .ip_prefix'
</pre>
</div>
</div>

<div id="outline-container-org71c9ae4" class="outline-3">
<h3 id="org71c9ae4"><a href="#org71c9ae4">Get Region of IP</a></h3>
<div class="outline-text-3" id="text-org71c9ae4">
<p>
(Would be cool).
</p>

<p>
Check IP address against each CIDR range. Would be cool to do this using bit
comparisons.
</p>

<p>
See: <a href="https://unix.stackexchange.com/questions/274330/check-ip-is-in-range-of-whitelist-array">https://unix.stackexchange.com/questions/274330/check-ip-is-in-range-of-whitelist-array</a>
</p>
</div>
</div>
</div>

<div id="outline-container-orga2c80b6" class="outline-2">
<h2 id="orga2c80b6"><a href="#orga2c80b6">Regions</a></h2>
<div class="outline-text-2" id="text-orga2c80b6">
</div>
<div id="outline-container-org3b1ae44" class="outline-3">
<h3 id="org3b1ae44"><a href="#org3b1ae44">All regions in partition</a></h3>
<div class="outline-text-3" id="text-org3b1ae44">
<div class="org-src-container">
<pre class="src src-sh" id="orge689a99">aws ec2 describe-regions \
    | jq -r ".Regions[].RegionName"
</pre>
</div>

<p>
Number of regions:
</p>

<div class="org-src-container">
<pre class="src src-sh">echo $AllRegions | wc -w   # Using wc

regions=($AllRegions)      # Or use an array, and
echo ${#regions[*]}        # print array length
</pre>
</div>
</div>
</div>

<div id="outline-container-org87aae0d" class="outline-3">
<h3 id="org87aae0d"><a href="#org87aae0d">All regions in all partitions</a></h3>
<div class="outline-text-3" id="text-org87aae0d">
<p>
Should be in the botocore data files. Also, we can pull them from the IpRanges
document. You have to decide whether "GLOBAL" is a "region" in your situation.
</p>

<div class="org-src-container">
<pre class="src src-sh">cat "$IpRanges" \
    | jq -r '.prefixes[].region' \
    | sort | uniq
</pre>
</div>
</div>
</div>

<div id="outline-container-org6f38c66" class="outline-3">
<h3 id="org6f38c66"><a href="#org6f38c66">Run a command in all regions</a></h3>
<div class="outline-text-3" id="text-org6f38c66">
</div>
<div id="outline-container-org35f50d8" class="outline-4">
<h4 id="org35f50d8"><a href="#org35f50d8">Linear</a></h4>
<div class="outline-text-4" id="text-org35f50d8">
<p>
Get the number of VPCs in each region the slow and simple way.
</p>

<div class="org-src-container">
<pre class="src src-sh">for region in $regions; do
    vpcs=($(aws --region $region ec2 describe-vpcs | jq '.Vpcs[].VpcId'))
    echo "$region: ${#vpcs[*]}"
done
</pre>
</div>
</div>
</div>

<div id="outline-container-org10954f5" class="outline-4">
<h4 id="org10954f5"><a href="#org10954f5">Parallel</a></h4>
<div class="outline-text-4" id="text-org10954f5">
<p>
Get the number of VPCs in each region the 🚀 and 😎 (and 🤮) way by starting
a subprocess for each region in parallel. Note that <code>${#regions[@]}</code> is bash
syntax for the length of the <code>$regions</code> array.
</p>

<div class="org-src-container">
<pre class="src src-sh">script=$(cat &lt;&lt;-"EOF"
vpcs=($(aws --region {} ec2 describe-vpcs | jq '.Vpcs[].VpcId'))
echo "{}: ${#vpcs[@]}"
EOF
)

regions=($regions)
printf "%s\n" "${regions[@]}" \
    | xargs -n 1 \
            -P ${#regions[*]} \
            -I {} \
            bash -c "$script"
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org015ee64" class="outline-2">
<h2 id="org015ee64"><a href="#org015ee64">ACM</a></h2>
<div class="outline-text-2" id="text-org015ee64">
</div>
<div id="outline-container-orgaf56ddf" class="outline-3">
<h3 id="orgaf56ddf"><a href="#orgaf56ddf">list-certificates</a></h3>
<div class="outline-text-3" id="text-orgaf56ddf">
<div class="org-src-container">
<pre class="src src-sh">aws acm list-certificates \
    --includes "keyUsage=ANY" \
    | jq '.CertificateSummaryList[]'
</pre>
</div>
</div>
</div>

<div id="outline-container-orge582349" class="outline-3">
<h3 id="orge582349"><a href="#orge582349">describe-certificate</a></h3>
<div class="outline-text-3" id="text-orge582349">
<div class="org-src-container">
<pre class="src src-sh">aws acm describe-certificate \
    --certificate-arn $cert_arn
</pre>
</div>
</div>
</div>

<div id="outline-container-org7046c76" class="outline-3">
<h3 id="org7046c76"><a href="#org7046c76">get-certificate</a></h3>
<div class="outline-text-3" id="text-org7046c76">
<div class="org-src-container">
<pre class="src src-sh">aws acm get-certificate \
    --certificate-arn $cert_arn
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdb1877e" class="outline-3">
<h3 id="orgdb1877e"><a href="#orgdb1877e">Get certificate PEM File</a></h3>
<div class="outline-text-3" id="text-orgdb1877e">
<div class="org-src-container">
<pre class="src src-sh">aws acm get-certificate \
    --certificate-arn $cert_arn \
    | jq -r '.Certificate' &gt; cert.pem
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgc0dd0e1" class="outline-2">
<h2 id="orgc0dd0e1"><a href="#orgc0dd0e1">API Gateway V2</a></h2>
<div class="outline-text-2" id="text-orgc0dd0e1">
</div>
<div id="outline-container-orgeb6899e" class="outline-3">
<h3 id="orgeb6899e"><a href="#orgeb6899e">get-apis</a></h3>
<div class="outline-text-3" id="text-orgeb6899e">
<div class="org-src-container">
<pre class="src src-sh">aws apigatewayv2 get-apis \
    | jq '.Items[]'
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org01b27bf" class="outline-2">
<h2 id="org01b27bf"><a href="#org01b27bf">CloudFormation</a></h2>
<div class="outline-text-2" id="text-org01b27bf">
<p>
For create/deploy/update, see my <a href="https://github.com/cfclrk/cloudformation/blob/main/README.org">cloudformation/README.org</a>.
</p>
</div>

<div id="outline-container-org0f3b956" class="outline-3">
<h3 id="org0f3b956"><a href="#org0f3b956">View Stack Log</a></h3>
<div class="outline-text-3" id="text-org0f3b956">
<div class="org-src-container">
<pre class="src src-sh">aws cloudformation list-stacks \
    | jq -M '.StackSummaries[0].StackId' \
    | xargs aws cloudformation describe-stack-events --stack-name
</pre>
</div>
</div>
</div>

<div id="outline-container-org1e70677" class="outline-3">
<h3 id="org1e70677"><a href="#org1e70677">List Stacks</a></h3>
<div class="outline-text-3" id="text-org1e70677">
<p>
List only the created stacks
</p>

<div class="org-src-container">
<pre class="src src-sh">aws cloudformation list-stacks \
    --stack-status-filter CREATE_IN_PROGRESS CREATE_COMPLETE
</pre>
</div>
</div>
</div>

<div id="outline-container-org8d668ce" class="outline-3">
<h3 id="org8d668ce"><a href="#org8d668ce">Stack Outputs</a></h3>
<div class="outline-text-3" id="text-org8d668ce">
<div class="org-src-container">
<pre class="src src-sh">aws cloudformation describe-stacks \
    --stack-name $StackName \
    | jq '.Stacks[].Outputs[]'
</pre>
</div>

<p>
Get the value of a single output:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws cloudformation describe-stacks \
    --stack-name $StackName \
    --query "Stacks[0].Outputs[?OutputKey=='$OutputKey'].OutputValue" \
    --output text
</pre>
</div>
</div>
</div>

<div id="outline-container-org05b8482" class="outline-3">
<h3 id="org05b8482"><a href="#org05b8482">Get Stack Parameters</a></h3>
<div class="outline-text-3" id="text-org05b8482">
<p>
Get all parameters used to create a particular stack:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws cloudformation describe-stacks \
    --stack-name $StackName \
    | jq '.Stacks[].Parameters[]'
</pre>
</div>

<p>
Get the value of a single parameter:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws cloudformation describe-stacks \
    --stack-name $StackName \
    --query "Stacks[0].Parameters[?ParameterKey=='$Parameter'].ParameterValue" \
    --output text
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc5aaa62" class="outline-3">
<h3 id="orgc5aaa62"><a href="#orgc5aaa62">Exports</a></h3>
<div class="outline-text-3" id="text-orgc5aaa62">
<p>
Get value of the exported field with name <code>$ExportName</code>:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws cloudformation list-exports \
    --query "Exports[?Name=='$ExportName'].Value" \
    --output text
</pre>
</div>

<p>
List exports that start with a string:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws cloudformation list-exports \
    --query "Exports[?starts_with(Name, 'foo-')].[Name, Value]" \
    --output text
</pre>
</div>
</div>
</div>

<div id="outline-container-org464bf6a" class="outline-3">
<h3 id="org464bf6a"><a href="#org464bf6a">Spec Files</a></h3>
<div class="outline-text-3" id="text-org464bf6a">
<p>
URLs are documented <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-resource-specification.html">here</a>.
</p>
</div>
</div>
</div>

<div id="outline-container-org099dc4f" class="outline-2">
<h2 id="org099dc4f"><a href="#org099dc4f">CloudWatch</a></h2>
<div class="outline-text-2" id="text-org099dc4f">
</div>
<div id="outline-container-org798084f" class="outline-3">
<h3 id="org798084f"><a href="#org798084f">Delete All Alarms</a></h3>
<div class="outline-text-3" id="text-org798084f">
<div class="org-src-container">
<pre class="src src-sh">alarms=$(aws cloudwatch describe-alarms \
             | jq -r '.MetricAlarms[].AlarmName')

for alarm in $alarms; do
    aws cloudwatch delete-alarms \
        --alarm-names $alarm;
done
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdab1a9f" class="outline-3">
<h3 id="orgdab1a9f"><a href="#orgdab1a9f">Create Alarm Targeting ASG policy</a></h3>
<div class="outline-text-3" id="text-orgdab1a9f">
<div class="org-src-container">
<pre class="src src-sh">aws cloudwatch put-metric-alarm \
    --alarm-name AddCapacity \
    --metric-name CPUUtilization \
    --namespace AWS/EC2 \
    --statistic Average \
    --period 120 \
    --threshold 80 \
    --comparison-operator GreaterThanOrEqualToThreshold \
    --dimensions "Name=AutoScalingGroupName,Value=my-asg" \
    --evaluation-periods 2 \
    --alarm-actions $ScalingPolicyArn
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgac55fec" class="outline-2">
<h2 id="orgac55fec"><a href="#orgac55fec">CodeDeploy</a></h2>
<div class="outline-text-2" id="text-orgac55fec">
</div>
<div id="outline-container-org10d58a9" class="outline-3">
<h3 id="org10d58a9"><a href="#org10d58a9">list-deployments</a></h3>
<div class="outline-text-3" id="text-org10d58a9">
<div class="org-src-container">
<pre class="src src-sh">aws deploy list-deployments \
    --application-name $app
</pre>
</div>
</div>
</div>

<div id="outline-container-org5e6a1ee" class="outline-3">
<h3 id="org5e6a1ee"><a href="#org5e6a1ee">list-tags-for-resource</a></h3>
<div class="outline-text-3" id="text-org5e6a1ee">
<div class="org-src-container">
<pre class="src src-sh">aws deploy list-tags-for-resource \
    --resource-arn ""
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd109f23" class="outline-2">
<h2 id="orgd109f23"><a href="#orgd109f23">DynamoDB</a></h2>
<div class="outline-text-2" id="text-orgd109f23">
<p>
The paper: <a href="https://www.allthingsdistributed.com/files/amazon-dynamo-sosp2007.pdf">Dynamo: Amazon’s Highly Available Key-value Store</a>. This describes a
distributed database with a leaderless replication model.
</p>

<p>
From <a href="https://shop.aer.io/oreilly/p/designing-data-intensive-applications/9781449373320-9149">Designing Data-Intensive Applications</a> by Martin Kleppmann:
</p>

<blockquote>
<p>
Dynamo is not available to users outside of Amazon. Confusingly, AWS offers a
hosted database product called DynamoDB, which uses a completely different
architecture: it is based on single-leader replication.
</p>
</blockquote>
</div>

<div id="outline-container-orgcd484b0" class="outline-3">
<h3 id="orgcd484b0"><a href="#orgcd484b0">List Tables</a></h3>
<div class="outline-text-3" id="text-orgcd484b0">
<div class="org-src-container">
<pre class="src src-sh">aws dynamodb  list-tables | jq '.TableNames[]'
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf86641d" class="outline-3">
<h3 id="orgf86641d"><a href="#orgf86641d">Delete Tables Like a Maniac</a></h3>
<div class="outline-text-3" id="text-orgf86641d">
<p>
AWS allows you to delete have 10 <code>delete-table</code> operations running at a time.
We can create a pool of 10 processes and continuously pump <code>delete-table</code>
commands into it using <code>xargs</code>.
</p>

<div class="org-src-container">
<pre class="src src-sh">script=$(cat &lt;&lt;"EOF"
aws dynamodb delete-table --table-name {}
aws dynamodb wait table-not-exists --table-name {}
EOF
      )
echo ${tables[*]} \
    | xargs -n 1 -P 10 -I {} sh -c "$scrpt"
</pre>
</div>

<p>
TODO: When I originally wrote this, I remember needing to add a <code>tr " " "\n"</code>
or something for portability with Linux. Test this out again.
</p>

<p>
TODO: script used to be one command (using <code>&amp;&amp;</code>); test again after splitting
it into two commands.
</p>
</div>
</div>
</div>

<div id="outline-container-org4428828" class="outline-2">
<h2 id="org4428828"><a href="#org4428828">EC2 AMIs</a></h2>
<div class="outline-text-2" id="text-org4428828">
</div>
<div id="outline-container-org2b53905" class="outline-3">
<h3 id="org2b53905"><a href="#org2b53905">List AMIs</a></h3>
<div class="outline-text-3" id="text-org2b53905">
<p>
All of this account's AMIs:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-images --owners $Account
</pre>
</div>

<p>
All of this account's AMIs with a particular Name tag:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-images \
    --owners $account \
    --filters "Name=tag:Name,Values=My AMI"
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc7ef82e" class="outline-3">
<h3 id="orgc7ef82e"><a href="#orgc7ef82e">Get Latest Image</a></h3>
<div class="outline-text-3" id="text-orgc7ef82e">
<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-images \
    --owners $Account \
    --filters "Name=state,Values=available" \
    | jq -r '.Images
             | sort_by(.CreationDate)
             | last | .ImageId'
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc9b362b" class="outline-3">
<h3 id="orgc9b362b"><a href="#orgc9b362b">Delete AMIs and EBS Snapshots</a></h3>
<div class="outline-text-3" id="text-orgc9b362b">
<p>
List AMIs to delete and set to variable <code>AmisToDelete</code>. Then:
</p>

<div class="org-src-container">
<pre class="src src-sh">jq -c '.Images
       | sort_by(.CreationDate)
       | .[]
       | {name: .Name, snap: .BlockDeviceMappings[]
       | select(.Ebs != null)
       | .Ebs.SnapshotId}' &lt; $AmisToDelete &gt; images.txt
</pre>
</div>

<p>
And then&#x2026; what did I do?
</p>

<div class="org-src-container">
<pre class="src src-sh">for i in (cat images.txt | jq); do
    # deregister image
    # delete the snapshot
done
</pre>
</div>
</div>
</div>

<div id="outline-container-org69e431f" class="outline-3">
<h3 id="org69e431f"><a href="#org69e431f">List Accounts That Can Access AMI</a></h3>
<div class="outline-text-3" id="text-org69e431f">
<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-image-attribute \
    --image-id $ImageID \
    --attribute launchPermission
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org004791f" class="outline-2">
<h2 id="org004791f"><a href="#org004791f">EC2 AZs</a></h2>
<div class="outline-text-2" id="text-org004791f">
<p>
All AZs in all regions:
</p>

<div class="org-src-container">
<pre class="src src-sh">for region in $AllRegions; do
    azs=$(aws --region $region \
              ec2 describe-availability-zones \
              | jq -c '[.AvailabilityZones[].ZoneName]')
    printf "$region: $azs\n"
done
</pre>
</div>
</div>

<div id="outline-container-orgd972451" class="outline-3">
<h3 id="orgd972451"><a href="#orgd972451">The Actual AZ</a></h3>
<div class="outline-text-3" id="text-orgd972451">
<p>
<code>us-east-1b</code> does not mean the same thing in every AWS account. If everyone
creates infra in <code>us-east-1b</code>, that infra will actually be in several
different AZs, depending on which AZ <code>us-east-1b</code> maps to for each account.
To determine the <i>real</i> AZ, you need to look at the <b>Zone ID</b>.
</p>

<p>
Print the Zone Name and Zone ID for each AZ in a region:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-availability-zones \
    | jq -c '.AvailabilityZones[]
             | {"Name": .ZoneName, "Id": .ZoneId}'
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orge786173" class="outline-2">
<h2 id="orge786173"><a href="#orge786173">EC2 KeyPairs</a></h2>
<div class="outline-text-2" id="text-orge786173">
</div>
<div id="outline-container-org86b1c6a" class="outline-3">
<h3 id="org86b1c6a"><a href="#org86b1c6a">Create</a></h3>
<div class="outline-text-3" id="text-org86b1c6a">
<div class="org-src-container">
<pre class="src src-sh" id="org2e3517b">aws ec2 create-key-pair --key-name $KeyName
</pre>
</div>

<p>
Copy private key to <code>~/.ssh</code>
</p>

<div class="org-src-container">
<pre class="src src-bash">KeyName=$(echo $KeyPair | jq -r '.KeyName')
KeyFile=~/.ssh/$dir/$KeyName
echo $KeyPair | jq -r '.KeyMaterial' &gt; $KeyFile
chmod 0600 $KeyFile
echo $KeyFile
</pre>
</div>
</div>
</div>

<div id="outline-container-org7584c80" class="outline-3">
<h3 id="org7584c80"><a href="#org7584c80">Describe</a></h3>
<div class="outline-text-3" id="text-org7584c80">
<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-key-pairs | jq '.KeyPairs[]'
</pre>
</div>
</div>
</div>

<div id="outline-container-org82dbef7" class="outline-3">
<h3 id="org82dbef7"><a href="#org82dbef7">Delete</a></h3>
<div class="outline-text-3" id="text-org82dbef7">
<div class="org-src-container">
<pre class="src src-sh">aws ec2 delete-key-pair --key-name $KeyName
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org802dfa8" class="outline-2">
<h2 id="org802dfa8"><a href="#org802dfa8">EC2 Instances</a></h2>
<div class="outline-text-2" id="text-org802dfa8">
</div>
<div id="outline-container-org7cca485" class="outline-3">
<h3 id="org7cca485"><a href="#org7cca485">Get Running Instances</a></h3>
<div class="outline-text-3" id="text-org7cca485">
<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-instances \
    --query "Reservations[].Instances[?State.name=="running"]"
</pre>
</div>
</div>
</div>

<div id="outline-container-orgba14233" class="outline-3">
<h3 id="orgba14233"><a href="#orgba14233">Get All Instance Tags</a></h3>
<div class="outline-text-3" id="text-orgba14233">
<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-instances \
    | jq -c '.Reservations[] | .Instances[] | .Tags[]'
</pre>
</div>
</div>
</div>

<div id="outline-container-org3fcddfb" class="outline-3">
<h3 id="org3fcddfb"><a href="#org3fcddfb">Get Instances with Tag Key</a></h3>
<div class="outline-text-3" id="text-org3fcddfb">
<p>
With just a specific Tag key, disregarding value:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-instances \
    --filter "Name=tag-key,Values=k8s.io/role/node" \
    | jq '.Reservations[].Instances[]'
</pre>
</div>
</div>
</div>

<div id="outline-container-org880fa44" class="outline-3">
<h3 id="org880fa44"><a href="#org880fa44">Get Instances with Tag Key/Value</a></h3>
<div class="outline-text-3" id="text-org880fa44">
<p>
With just a specific Tag key:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-instances \
    --filter "Name=tag:$TagName,Values=$TagValue" \
    | jq -r '.Reservations[].Instances[].Tags[]
             | select(.Key == "Name")
             | .Value'
</pre>
</div>

<p>
With a specific tag key and value
</p>
</div>
</div>
</div>

<div id="outline-container-orgeb57041" class="outline-2">
<h2 id="orgeb57041"><a href="#orgeb57041">EC2 Transit Gateway</a></h2>
<div class="outline-text-2" id="text-orgeb57041">
</div>
<div id="outline-container-orgdaf548c" class="outline-3">
<h3 id="orgdaf548c"><a href="#orgdaf548c">List Routes in a TG Route Table</a></h3>
<div class="outline-text-3" id="text-orgdaf548c">
<div class="org-src-container">
<pre class="src src-sh">aws --profile shared-services --region us-east-1 \
    ec2 search-transit-gateway-routes \
    --transit-gateway-route-table-id $TGWRouteTableId \
    --filters "Name=type,Values=propagated" \
    | jq -r '.Routes[].DestinationCidrBlock'
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orge5506b4" class="outline-2">
<h2 id="orge5506b4"><a href="#orge5506b4">EC2 VPCs</a></h2>
<div class="outline-text-2" id="text-orge5506b4">
</div>
<div id="outline-container-org85e3a67" class="outline-3">
<h3 id="org85e3a67"><a href="#org85e3a67">VPCs</a></h3>
<div class="outline-text-3" id="text-org85e3a67">
<div class="org-src-container">
<pre class="src src-bash">aws ec2 describe-vpcs | jq '.Vpcs[]'
</pre>
</div>

<p>
The names of VPCs that have a <code>Name</code> tag:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-vpcs \
    --filters Name=tag-key,Values=Name \
    | jq -r '.Vpcs[].Tags[]
             | select(.Key == "Name")
             | .Value'
</pre>
</div>
</div>
</div>

<div id="outline-container-org2bbb314" class="outline-3">
<h3 id="org2bbb314"><a href="#org2bbb314">Subnets</a></h3>
<div class="outline-text-3" id="text-org2bbb314">
<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-subnets  | jq '.Subnets'
</pre>
</div>
</div>
</div>

<div id="outline-container-org094bba0" class="outline-3">
<h3 id="org094bba0"><a href="#org094bba0">SecurityGroups</a></h3>
<div class="outline-text-3" id="text-org094bba0">
<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-security-groups \
    | jq '.SecurityGroups'
</pre>
</div>
</div>
</div>

<div id="outline-container-org4bfe151" class="outline-3">
<h3 id="org4bfe151"><a href="#org4bfe151">Private ALB IPs</a></h3>
<div class="outline-text-3" id="text-org4bfe151">
<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-network-interfaces \
    | jq -r '.NetworkInterfaces[]
          | select(.Attachment.InstanceOwnerId == "amazon-elb")
          | .PrivateIpAddress'
</pre>
</div>
</div>
</div>

<div id="outline-container-org6b60942" class="outline-3">
<h3 id="org6b60942"><a href="#org6b60942">Managed Prefix Lists</a></h3>
<div class="outline-text-3" id="text-org6b60942">
<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-managed-prefix-lists \
    | jq '.PrefixLists[]'
</pre>
</div>

<p>
#+header :var PrefixListID=""
</p>
<div class="org-src-container">
<pre class="src src-sh">aws ec2 get-managed-prefix-list-entries \
    --prefix-list-id $PrefixListID \
    | jq '.Entries[]'
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb09cc04" class="outline-2">
<h2 id="orgb09cc04"><a href="#orgb09cc04">EC2 Volumes</a></h2>
<div class="outline-text-2" id="text-orgb09cc04">
</div>
<div id="outline-container-org809994b" class="outline-3">
<h3 id="org809994b"><a href="#org809994b">List Volumes</a></h3>
<div class="outline-text-3" id="text-org809994b">
<div class="org-src-container">
<pre class="src src-sh" id="org63bbbaa">aws ec2 describe-volumes \
    --filters Name=tag-key,Values=$Tag \
    | jq -r '.Volumes[].VolumeId'
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd0a9318" class="outline-3">
<h3 id="orgd0a9318"><a href="#orgd0a9318">List Unattached Volumes</a></h3>
<div class="outline-text-3" id="text-orgd0a9318">
<div class="org-src-container">
<pre class="src src-sh" id="org941bb05">aws ec2 describe-volumes \
    --filters Name=status,Values=available \
    | jq -r '.Volumes[].VolumeId'
</pre>
</div>
</div>
</div>

<div id="outline-container-orge29a71c" class="outline-3">
<h3 id="orge29a71c"><a href="#orge29a71c">Delete Volumes</a></h3>
<div class="outline-text-3" id="text-orge29a71c">
<div class="org-src-container">
<pre class="src src-sh">for volume in $Volumes; do
    aws ec2 delete-volume --volume-id $volume
done
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgbb03ebe" class="outline-2">
<h2 id="orgbb03ebe"><a href="#orgbb03ebe">ECR</a></h2>
<div class="outline-text-2" id="text-orgbb03ebe">
</div>
<div id="outline-container-orgd6f2beb" class="outline-3">
<h3 id="orgd6f2beb"><a href="#orgd6f2beb">Log in</a></h3>
<div class="outline-text-3" id="text-orgd6f2beb">
<p>
TODO: <code>$account</code> doesn't work (newline)
</p>

<div class="org-src-container">
<pre class="src src-sh">ecr=$account.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com
pw=$(aws ecr get-login-password)
docker login \
       --username AWS \
       --password "$pw" \
       "https://$ecr"
</pre>
</div>
</div>
</div>

<div id="outline-container-org5b407f7" class="outline-3">
<h3 id="org5b407f7"><a href="#org5b407f7">Create Repository</a></h3>
<div class="outline-text-3" id="text-org5b407f7">
<div class="org-src-container">
<pre class="src src-sh">aws ecr create-repository \
    --repository-name $repoName \
    --tags "Key=Foo,Value=True"
</pre>
</div>
</div>
</div>

<div id="outline-container-org1122884" class="outline-3">
<h3 id="org1122884"><a href="#org1122884">Add Image</a></h3>
<div class="outline-text-3" id="text-org1122884">
<p>
Tag image for ECR:
</p>

<div class="org-src-container">
<pre class="src src-sh">ecr=$account.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com
docker tag \
       $image:$tag \
       $ecr/$name:$tag
</pre>
</div>

<p>
Push it:
</p>

<div class="org-src-container">
<pre class="src src-sh">ecr=$account.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com
docker push \
       $ecr/$name:$tag
</pre>
</div>
</div>
</div>

<div id="outline-container-org9cd81d3" class="outline-3">
<h3 id="org9cd81d3"><a href="#org9cd81d3">describe-registry</a></h3>
<div class="outline-text-3" id="text-org9cd81d3">
<div class="org-src-container">
<pre class="src src-sh">aws ecr describe-registry
</pre>
</div>
</div>
</div>

<div id="outline-container-orgadca32b" class="outline-3">
<h3 id="orgadca32b"><a href="#orgadca32b">describe-repositories</a></h3>
<div class="outline-text-3" id="text-orgadca32b">
<div class="org-src-container">
<pre class="src src-sh">aws ecr describe-repositories \
    --registry-id "&lt;id&gt;"
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb71ddde" class="outline-3">
<h3 id="orgb71ddde"><a href="#orgb71ddde">list-tags-for-resource</a></h3>
<div class="outline-text-3" id="text-orgb71ddde">
<p>
The ARN is like <code>arn:aws:ecr:us-east-1:&lt;account-num&gt;:repository/&lt;repo-name&gt;</code>.
</p>

<div class="org-src-container">
<pre class="src src-sh">aws ecr list-tags-for-resource \
    --resource-arn "$arn"
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org8d3d512" class="outline-2">
<h2 id="org8d3d512"><a href="#org8d3d512">ECS</a></h2>
<div class="outline-text-2" id="text-org8d3d512">
<p>
Fix a CloudFormation deployment where an ECS service fails to stabilize. Taken
from <a href="https://aws.amazon.com/premiumsupport/knowledge-center/cloudformation-ecs-service-stabilize/">this</a> AWS blog post. Just updates the number of ECS service tasks to 0.
</p>

<div class="org-src-container">
<pre class="src src-sh">aws ecs update-service \
    --cluster $cluster \
    --service $service \
    --desired-count 0
</pre>
</div>
</div>

<div id="outline-container-orgdcc4f98" class="outline-3">
<h3 id="orgdcc4f98"><a href="#orgdcc4f98">list-clusters</a></h3>
<div class="outline-text-3" id="text-orgdcc4f98">
<div class="org-src-container">
<pre class="src src-sh">aws ecs list-clusters \
    | jq '.clusterArns[]'
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc613706" class="outline-3">
<h3 id="orgc613706"><a href="#orgc613706">describe-clusters</a></h3>
<div class="outline-text-3" id="text-orgc613706">
<div class="org-src-container">
<pre class="src src-sh">aws ecs describe-clusters \
    --clusters $cluster \
    | jq '.clusters[]'
</pre>
</div>
</div>
</div>

<div id="outline-container-org3c4b26c" class="outline-3">
<h3 id="org3c4b26c"><a href="#org3c4b26c">describe-services</a></h3>
<div class="outline-text-3" id="text-org3c4b26c">
<div class="org-src-container">
<pre class="src src-sh">aws ecs describe-services \
    --cluster $cluster \
    --services $service \
    | jq '.services[]'
</pre>
</div>
</div>
</div>

<div id="outline-container-org39188b3" class="outline-3">
<h3 id="org39188b3"><a href="#org39188b3">describe-task-definition</a></h3>
<div class="outline-text-3" id="text-org39188b3">
<div class="org-src-container">
<pre class="src src-sh">aws ecs describe-task-definition \
    --task-definition $task \
    | jq '.taskDefinition.containerDefinitions[]'
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb5f9388" class="outline-3">
<h3 id="orgb5f9388"><a href="#orgb5f9388">descibe-task-sets</a></h3>
<div class="outline-text-3" id="text-orgb5f9388">
<div class="org-src-container">
<pre class="src src-sh" id="org32b4c6d">aws ecs describe-services \
    --cluster $cluster \
    --services $service \
    | jq -r '.services[].taskSets[].id'
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">aws ecs describe-task-sets \
    --cluster $cluster \
    --service $service \
    --task-sets $task_set \
    | jq '.taskSets[]'
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org7c0a659" class="outline-2">
<h2 id="org7c0a659"><a href="#org7c0a659">EKS</a></h2>
<div class="outline-text-2" id="text-org7c0a659">
</div>
<div id="outline-container-org902ce68" class="outline-3">
<h3 id="org902ce68"><a href="#org902ce68">List Clusters</a></h3>
<div class="outline-text-3" id="text-org902ce68">
<div class="org-src-container">
<pre class="src src-sh">aws eks list-clusters | jq '.clusters[]'
</pre>
</div>
</div>
</div>

<div id="outline-container-org07ccf37" class="outline-3">
<h3 id="org07ccf37"><a href="#org07ccf37">Get Kube Config</a></h3>
<div class="outline-text-3" id="text-org07ccf37">
<div class="org-src-container">
<pre class="src src-sh">KUBECONFIG=~/.kube/ironnet_clusters/$CLUSTER_NAME
aws eks update-kubeconfig \
    --name $CLUSTER_NAME \
    --kubeconfig $KUBECONFIG
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orga2776ff" class="outline-2">
<h2 id="orga2776ff"><a href="#orga2776ff">Elasticache</a></h2>
<div class="outline-text-2" id="text-orga2776ff">
</div>
<div id="outline-container-org0f79de6" class="outline-3">
<h3 id="org0f79de6"><a href="#org0f79de6">List CacheClusters</a></h3>
<div class="outline-text-3" id="text-org0f79de6">
<div class="org-src-container">
<pre class="src src-sh">aws elasticache describe-cache-clusters \
    --show-cache-node-info \
    | jq '.CacheClusters'
</pre>
</div>
</div>
</div>

<div id="outline-container-org178032d" class="outline-3">
<h3 id="org178032d"><a href="#org178032d">List ReplicationGroups</a></h3>
<div class="outline-text-3" id="text-org178032d">
<div class="org-src-container">
<pre class="src src-sh">aws elasticache describe-replication-groups
        | jq '.ReplicationGroups'
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf2eab5b" class="outline-2">
<h2 id="orgf2eab5b"><a href="#orgf2eab5b">ElasticBeanstalk</a></h2>
<div class="outline-text-2" id="text-orgf2eab5b">
</div>
<div id="outline-container-org3545be4" class="outline-3">
<h3 id="org3545be4"><a href="#org3545be4">Config Options for Nampespace</a></h3>
<div class="outline-text-3" id="text-org3545be4">
<div class="org-src-container">
<pre class="src src-sh">aws elasticbeanstalk describe-configuration-options \
    | jq '.Options[]
          | if .Namespace == "aws:autoscaling:launchconfiguration"
            then .
            else null
            end'
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org4f6c1e4" class="outline-2">
<h2 id="org4f6c1e4"><a href="#org4f6c1e4">ElasticLoadBalancingV2</a></h2>
<div class="outline-text-2" id="text-org4f6c1e4">
</div>
<div id="outline-container-orgfe93821" class="outline-3">
<h3 id="orgfe93821"><a href="#orgfe93821">Describe ALBs</a></h3>
<div class="outline-text-3" id="text-orgfe93821">
<div class="org-src-container">
<pre class="src src-sh">aws elbv2 describe-load-balancers \
    | jq '.LoadBalancers[] | select(.Type == "application")'
</pre>
</div>
</div>
</div>

<div id="outline-container-org8c78c4c" class="outline-3">
<h3 id="org8c78c4c"><a href="#org8c78c4c">Get DNS Name</a></h3>
<div class="outline-text-3" id="text-org8c78c4c">
<div class="org-src-container">
<pre class="src src-sh">aws elbv2 describe-load-balancers \
    | jq -r --arg DEPLOYMENT_NAME "$DEPLOYMENT_NAME" \
         '.LoadBalancers[]
          | select(.Type == "application")
          | select(.LoadBalancerName
          | startswith($DEPLOYMENT_NAME))
          | .DNSName'
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org15cef0e" class="outline-2">
<h2 id="org15cef0e"><a href="#org15cef0e">GlobalAccelerator</a></h2>
<div class="outline-text-2" id="text-org15cef0e">
<p>
GlobalAccelerator is only in <code>us-west-2</code>, so set the region explicitly.
</p>
</div>

<div id="outline-container-orgdcbeffd" class="outline-3">
<h3 id="orgdcbeffd"><a href="#orgdcbeffd">List Accelerators</a></h3>
<div class="outline-text-3" id="text-orgdcbeffd">
<div class="org-src-container">
<pre class="src src-sh">aws --region us-west-2 \
    globalaccelerator list-accelerators \
    | jq '.Accelerators[]'
</pre>
</div>
</div>
</div>

<div id="outline-container-org5318dce" class="outline-3">
<h3 id="org5318dce"><a href="#org5318dce">List Listeners</a></h3>
<div class="outline-text-3" id="text-org5318dce">
<div class="org-src-container">
<pre class="src src-sh">aws --region us-west-2 \
    globalaccelerator list-listeners \
    --accelerator-arn $AcceleratorArn
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf87b5c0" class="outline-3">
<h3 id="orgf87b5c0"><a href="#orgf87b5c0">IPs</a></h3>
<div class="outline-text-3" id="text-orgf87b5c0">
<div class="org-src-container">
<pre class="src src-sh">aws --region us-west-2 \
    globalaccelerator list-accelerators \
    | jq -r '.Accelerators[].IpSets[].IpAddresses[]'
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgce07388" class="outline-2">
<h2 id="orgce07388"><a href="#orgce07388">IAM</a></h2>
<div class="outline-text-2" id="text-orgce07388">
</div>
<div id="outline-container-org92d8b3d" class="outline-3">
<h3 id="org92d8b3d"><a href="#org92d8b3d">Create Policy</a></h3>
<div class="outline-text-3" id="text-org92d8b3d">
<div class="org-src-container">
<pre class="src src-sh">aws iam create-policy \
    --policy-name $PolicyName \
    --policy-document '{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Allow",
    "Action": [
      "secretsmanager:GetSecretValue",
      "secretsmanager:DescribeSecret"
    ],
    "Resource": [
      "arn:*:secretsmanager:*:*:secret:MySecret"
    ]
  }]
}'
</pre>
</div>
</div>
</div>

<div id="outline-container-org29b87dc" class="outline-3">
<h3 id="org29b87dc"><a href="#org29b87dc">Describe Policy</a></h3>
<div class="outline-text-3" id="text-org29b87dc">
<div class="org-src-container">
<pre class="src src-sh">aws iam get-policy --policy-arn $arn
</pre>
</div>
</div>
</div>

<div id="outline-container-org44188e0" class="outline-3">
<h3 id="org44188e0"><a href="#org44188e0">Assume Role</a></h3>
<div class="outline-text-3" id="text-org44188e0">
<div class="org-src-container">
<pre class="src src-sh" id="org1e27212">aws sts assume-role \
    --role-session-name foo \
    --role-arn $RoleArn
</pre>
</div>
</div>
</div>

<div id="outline-container-org2ec8d74" class="outline-3">
<h3 id="org2ec8d74"><a href="#org2ec8d74">List Instance Profiles</a></h3>
<div class="outline-text-3" id="text-org2ec8d74">
<div class="org-src-container">
<pre class="src src-sh">aws iam list-instance-profiles \
    | jq '.InstanceProfiles[].InstanceProfileName'
</pre>
</div>
</div>
</div>

<div id="outline-container-org17db863" class="outline-3">
<h3 id="org17db863"><a href="#org17db863">Delete Instance Profile</a></h3>
<div class="outline-text-3" id="text-org17db863">
<div class="org-src-container">
<pre class="src src-sh">aws iam delete-instance-profile \
    --instance-profile-name $Name
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orge90e732" class="outline-2">
<h2 id="orge90e732"><a href="#orge90e732">IMDS</a></h2>
<div class="outline-text-2" id="text-orge90e732">
<p>
<a href="http://169.254.169.254/latest/meta-data/">http://169.254.169.254/latest/meta-data/</a>
</p>
</div>
</div>

<div id="outline-container-org524a14d" class="outline-2">
<h2 id="org524a14d"><a href="#org524a14d">Kinesis</a></h2>
<div class="outline-text-2" id="text-org524a14d">
</div>
<div id="outline-container-orgfb070f7" class="outline-3">
<h3 id="orgfb070f7"><a href="#orgfb070f7">Delete Stream</a></h3>
<div class="outline-text-3" id="text-orgfb070f7">
<div class="org-src-container">
<pre class="src src-sh">aws kinesis delete-stream --stream-name $stream
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org447341c" class="outline-2">
<h2 id="org447341c"><a href="#org447341c">Kinesis Firehose</a></h2>
<div class="outline-text-2" id="text-org447341c">
</div>
<div id="outline-container-org538cae4" class="outline-3">
<h3 id="org538cae4"><a href="#org538cae4">Describe Stream</a></h3>
<div class="outline-text-3" id="text-org538cae4">
<div class="org-src-container">
<pre class="src src-sh">aws firehose describe-delivery-stream \
    --delivery-stream-name $StreamName \
    | jq '.DeliveryStreamDescription'
</pre>
</div>
</div>
</div>

<div id="outline-container-org1c25db3" class="outline-3">
<h3 id="org1c25db3"><a href="#org1c25db3">Update Stream S3 Destination Bucket</a></h3>
<div class="outline-text-3" id="text-org1c25db3">
<div class="org-src-container">
<pre class="src src-sh">aws firehose update-destination \
    --delivery-stream-name $StreamName \
    --current-delivery-stream-version-id 1 \
    --destination-id destinationId-000000000001 \
    --extended-s3-destination-update \
    BucketARN=arn:aws:s3:::$BucketName
</pre>
</div>

<p>
THEN:
</p>

<ul class="org-ul">
<li>Update the Stream's IAM policy to allow it to write to the new location</li>
<li>Update the S3 Bucket Policy to allow the Stream's IAM Role to write to it</li>
</ul>
</div>
</div>

<div id="outline-container-org9a05898" class="outline-3">
<h3 id="org9a05898"><a href="#org9a05898">Update Stream S3 Destination Prefix</a></h3>
<div class="outline-text-3" id="text-org9a05898">
<div class="org-src-container">
<pre class="src src-sh">aws firehose update-destination \
    --delivery-stream-name $StreamName \
    --current-delivery-stream-version-id 1 \
    --destination-id destinationId-000000000001 \
    --extended-s3-destination-update Prefix=$Prefix
</pre>
</div>

<p>
Also may need to update the IAM Policy and the S3 Bucket policy, as above.
</p>
</div>
</div>
</div>

<div id="outline-container-org58ab81e" class="outline-2">
<h2 id="org58ab81e"><a href="#org58ab81e">Lambda</a></h2>
<div class="outline-text-2" id="text-org58ab81e">
</div>
<div id="outline-container-org6a93227" class="outline-3">
<h3 id="org6a93227"><a href="#org6a93227">Invoke function</a></h3>
<div class="outline-text-3" id="text-org6a93227">
<div class="org-src-container">
<pre class="src src-bash">aws lambda invoke \
    --cli-binary-format raw-in-base64-out \
    --function-name cf-Hello-World \
    /tmp/cats.json
</pre>
</div>

<p>
Invoke from a bastion host:
</p>

<div class="org-src-container">
<pre class="src src-bash">/usr/local/bin/aws lambda invoke \
                   --cli-binary-format raw-in-base64-out \
                   --function-name cf-Hello-World \
                   /tmp/cats.json
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">cat /tmp/out.json | jq -r '.body' | jq
</pre>
</div>

<p>
With payload file:
</p>

<div class="org-src-container">
<pre class="src src-bash">aws lambda invoke \
    --cli-binary-format raw-in-base64-out \
    --function-name hello-world \
    --payload file://tests/resources/event_alb.json \
    /tmp/out.json
</pre>
</div>
</div>
</div>

<div id="outline-container-org37e6f45" class="outline-3">
<h3 id="org37e6f45"><a href="#org37e6f45">Create Function with Zip File</a></h3>
<div class="outline-text-3" id="text-org37e6f45">
<div class="org-src-container">
<pre class="src src-sh">aws lambda create-function \
    --function-name artifacttool \
    --runtime python2.7 \
    --role $RoleArn \
    --handler lambda_function.lambda_handler \
    --zip-file fileb://$ZipFileName
</pre>
</div>
</div>
</div>

<div id="outline-container-org1da8806" class="outline-3">
<h3 id="org1da8806"><a href="#org1da8806">Update Function code with Zip File</a></h3>
<div class="outline-text-3" id="text-org1da8806">
<div class="org-src-container">
<pre class="src src-sh">aws lambda update-function-code \
    --function-name artifacttool \
    --zip-file fileb://$ZipFileName
</pre>
</div>
</div>
</div>

<div id="outline-container-org61177cb" class="outline-3">
<h3 id="org61177cb"><a href="#org61177cb">Container Image: Run Interactively</a></h3>
<div class="outline-text-3" id="text-org61177cb">
<div class="org-src-container">
<pre class="src src-sh">docker run -it --rm \
       --entrypoint bash \
       public.ecr.aws/lambda/python:3.8
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgdcc0535" class="outline-2">
<h2 id="orgdcc0535"><a href="#orgdcc0535">Organizations</a></h2>
<div class="outline-text-2" id="text-orgdcc0535">
<div class="org-src-container">
<pre class="src src-sh" id="org4b6b4fd">aws organizations list-roots \
    | jq -r '.Roots[].Id'
</pre>
</div>
</div>
</div>

<div id="outline-container-org77afbd8" class="outline-2">
<h2 id="org77afbd8"><a href="#org77afbd8">Polly</a></h2>
<div class="outline-text-2" id="text-org77afbd8">
<div class="org-src-container">
<pre class="src src-sh">aws polly synthesize-speech \
    --engine standard \
    --output-format mp3 \
    --voice-id Amy \
    --text "All these cats wear hats." \
    /tmp/speech_standard.mp3 \
    &amp;&amp; afplay /tmp/speech_standard.mp3
</pre>
</div>
</div>
</div>

<div id="outline-container-org4f417a6" class="outline-2">
<h2 id="org4f417a6"><a href="#org4f417a6">Reosurce Access Manager (RAM)</a></h2>
<div class="outline-text-2" id="text-org4f417a6">
<p>
This needs to be run against the AWS account that actually owns the shared
resources. E.g. in a LandingZone environment, probably the shared-services
account.
</p>

<div class="org-src-container">
<pre class="src src-sh">aws ram list-resources --resource-owner SELF
</pre>
</div>
</div>
</div>

<div id="outline-container-orged392ac" class="outline-2">
<h2 id="orged392ac"><a href="#orged392ac">RDS</a></h2>
<div class="outline-text-2" id="text-orged392ac">
</div>
<div id="outline-container-org7f886c4" class="outline-3">
<h3 id="org7f886c4"><a href="#org7f886c4">describe-db-instances</a></h3>
<div class="outline-text-3" id="text-org7f886c4">
<div class="org-src-container">
<pre class="src src-sh">aws rds describe-db-instances \
    --db-instance-identifier "$db_name" \
    | jq '.DBInstances[]'
</pre>
</div>
</div>
</div>

<div id="outline-container-org16b6eae" class="outline-3">
<h3 id="org16b6eae"><a href="#org16b6eae">modify-db-instance</a></h3>
<div class="outline-text-3" id="text-org16b6eae">
<p>
Run this command to apply pending maintenance:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws rds modify-db-instance \
    --db-instance-identifier "$db_name" \
    --apply-immediately
</pre>
</div>
</div>
</div>

<div id="outline-container-org8f4c0c1" class="outline-3">
<h3 id="org8f4c0c1"><a href="#org8f4c0c1">describe-db-engine-versions</a></h3>
<div class="outline-text-3" id="text-org8f4c0c1">
<div class="org-src-container">
<pre class="src src-sh">aws rds describe-db-engine-versions \
    --engine "postgres" \
    --filters 'Key=status,Values=deprecated'
</pre>
</div>
</div>
</div>

<div id="outline-container-org9affadf" class="outline-3">
<h3 id="org9affadf"><a href="#org9affadf">pending maintenance actions for a DB</a></h3>
<div class="outline-text-3" id="text-org9affadf">
<div class="org-src-container">
<pre class="src src-sh">aws rds describe-pending-maintenance-actions \
    | jq '.PendingMaintenanceActions[]
          | select(.ResourceIdentifier=="$DB_ARN")'
</pre>
</div>
</div>
</div>

<div id="outline-container-org550d068" class="outline-3">
<h3 id="org550d068"><a href="#org550d068">create-db-snapshot</a></h3>
<div class="outline-text-3" id="text-org550d068">
<div class="org-src-container">
<pre class="src src-sh">aws rds create-db-snapshot \
    --db-snapshot-identifier "$snap_id" \
    --db-instance-identifier work-number-dev
</pre>
</div>

<p>
Check whether a snapshot exists yet:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws rds describe-db-snapshots \
    --db-snapshot-identifier "$snap_id" \
    --db-instance-identifier "$db_name" \
    | jq '.DBSnapshots[].OriginalSnapshotCreateTime'
</pre>
</div>
</div>
</div>

<div id="outline-container-org12c6d7c" class="outline-3">
<h3 id="org12c6d7c"><a href="#org12c6d7c">create-parameter-group</a></h3>
<div class="outline-text-3" id="text-org12c6d7c">
<div class="org-src-container">
<pre class="src src-sh">aws rds create-db-parameter-group \
    --db-parameter-group-name "cclark-test" \
    --db-parameter-group-family "postgres11" \
    --description "cclark test group"
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">aws rds modify-db-parameter-group \
    --db-parameter-group-name "cclark-test" \
    --parameters "ParameterName='max_slot_wal_keep_size',ParameterValue=4000,ApplyMethod=immediate"
</pre>
</div>
</div>
</div>

<div id="outline-container-orgee75330" class="outline-3">
<h3 id="orgee75330"><a href="#orgee75330">describe-parameter-group</a></h3>
<div class="outline-text-3" id="text-orgee75330">
<div class="org-src-container">
<pre class="src src-sh">aws rds describe-db-parameters \
    --db-parameter-group-name "cclark-test" \
    | jq '.Parameters[]
          | select(.ParameterName | contains("wal_"))'
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orga7f2e6b" class="outline-2">
<h2 id="orga7f2e6b"><a href="#orga7f2e6b">Route53</a></h2>
<div class="outline-text-2" id="text-orga7f2e6b">
</div>
<div id="outline-container-org9955e19" class="outline-3">
<h3 id="org9955e19"><a href="#org9955e19">Get HostedZoneId from domain name</a></h3>
<div class="outline-text-3" id="text-org9955e19">
<div class="org-src-container">
<pre class="src src-sh" id="orge74718d">aws route53 list-hosted-zones \
    | jq -r --arg name $hostedZoneName \
         '.HostedZones[]
          | select(.Name == $name + ".")
          | select(.Config.PrivateZone == false)
          | .Id'
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd48bc48" class="outline-3">
<h3 id="orgd48bc48"><a href="#orgd48bc48">List Records for a HostedZone</a></h3>
<div class="outline-text-3" id="text-orgd48bc48">
<div class="org-src-container">
<pre class="src src-sh">aws route53 list-resource-record-sets \
    --hosted-zone-id $hostedZoneId \
    | jq '.ResourceRecordSets[]'
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd2c2c24" class="outline-2">
<h2 id="orgd2c2c24"><a href="#orgd2c2c24">SageMaker</a></h2>
<div class="outline-text-2" id="text-orgd2c2c24">
</div>
<div id="outline-container-org11186f0" class="outline-3">
<h3 id="org11186f0"><a href="#org11186f0">list-models</a></h3>
<div class="outline-text-3" id="text-org11186f0">
<div class="org-src-container">
<pre class="src src-sh">aws sagemaker list-models | jq '.Models[]'
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org3882600" class="outline-2">
<h2 id="org3882600"><a href="#org3882600">SecretsManager</a></h2>
<div class="outline-text-2" id="text-org3882600">
</div>
<div id="outline-container-org1d541b3" class="outline-3">
<h3 id="org1d541b3"><a href="#org1d541b3">List Secrets</a></h3>
<div class="outline-text-3" id="text-org1d541b3">
<div class="org-src-container">
<pre class="src src-sh">aws secretsmanager list-secrets \
    | jq -r '.SecretList[].Name'
</pre>
</div>

<p>
Filter:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws secretsmanager list-secrets \
    --filters 'Key=name,Values=foo/bar' \
    | jq -r '.SecretList[].Name'
</pre>
</div>
</div>
</div>

<div id="outline-container-org0b68467" class="outline-3">
<h3 id="org0b68467"><a href="#org0b68467">Get Secret</a></h3>
<div class="outline-text-3" id="text-org0b68467">
<div class="org-src-container">
<pre class="src src-sh">aws secretsmanager get-secret-value \
    --secret-id $SecretName \
    | jq -r '.SecretString'
</pre>
</div>
</div>
</div>

<div id="outline-container-org795edde" class="outline-3">
<h3 id="org795edde"><a href="#org795edde">Create Secret</a></h3>
<div class="outline-text-3" id="text-org795edde">
<div class="org-src-container">
<pre class="src src-sh">aws secretsmanager create-secret \
    --name $SecretName \
    --secret-string $SecretValue
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org5f3f64c" class="outline-2">
<h2 id="org5f3f64c"><a href="#org5f3f64c">ServiceCatalog</a></h2>
<div class="outline-text-2" id="text-org5f3f64c">
</div>
<div id="outline-container-orgca6e0d5" class="outline-3">
<h3 id="orgca6e0d5"><a href="#orgca6e0d5">Get Product IDs</a></h3>
<div class="outline-text-3" id="text-orgca6e0d5">
<div class="org-src-container">
<pre class="src src-sh">aws --profile main servicecatalog search-products-as-admin
</pre>
</div>
</div>
</div>

<div id="outline-container-orgad610cf" class="outline-3">
<h3 id="orgad610cf"><a href="#orgad610cf">Launch Product</a></h3>
<div class="outline-text-3" id="text-orgad610cf">
<p>
Note that user, even Admin user, must be added to the Portfolio users/groups.
You can do this with <code>aws servicecatalog associate-principal-with-portfolio</code>
</p>
</div>
</div>
</div>

<div id="outline-container-orgd46de62" class="outline-2">
<h2 id="orgd46de62"><a href="#orgd46de62">Service Quotas</a></h2>
<div class="outline-text-2" id="text-orgd46de62">
</div>
<div id="outline-container-org4b922f7" class="outline-3">
<h3 id="org4b922f7"><a href="#org4b922f7">Get all service quotas</a></h3>
<div class="outline-text-3" id="text-org4b922f7">
<div class="org-src-container">
<pre class="src src-sh">aws service-quotas list-service-quotas \
    --service-code rds \
    | jq -c '.Quotas[] | {Value, QuotaName}'
</pre>
</div>
</div>
</div>

<div id="outline-container-org9bacdde" class="outline-3">
<h3 id="org9bacdde"><a href="#org9bacdde">Get one quota</a></h3>
<div class="outline-text-3" id="text-org9bacdde">
<div class="org-src-container">
<pre class="src src-sh">aws service-quotas list-service-quotas \
    --service-code rds \
    | jq '.Quotas[]
          | select(.QuotaName == "Parameter groups")'
</pre>
</div>
</div>
</div>

<div id="outline-container-org5938041" class="outline-3">
<h3 id="org5938041"><a href="#org5938041">Get default quota</a></h3>
<div class="outline-text-3" id="text-org5938041">
<p>
Is this actually different from the above? What makes this default?
</p>

<div class="org-src-container">
<pre class="src src-sh">aws service-quotas get-aws-default-service-quota \
    --service-code firehose \
    --quota-code "L-14BB0BE7" \
    | jq '.Quota'
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org8cb6e83" class="outline-2">
<h2 id="org8cb6e83"><a href="#org8cb6e83">S3</a></h2>
<div class="outline-text-2" id="text-org8cb6e83">
</div>
<div id="outline-container-orgd915749" class="outline-3">
<h3 id="orgd915749"><a href="#orgd915749">Canonical ID</a></h3>
<div class="outline-text-3" id="text-orgd915749">
<div class="org-src-container">
<pre class="src src-sh">aws s3api get-bucket-acl --bucket $BucketName
</pre>
</div>
</div>
</div>

<div id="outline-container-org8437c60" class="outline-3">
<h3 id="org8437c60"><a href="#org8437c60">list-buckets</a></h3>
<div class="outline-text-3" id="text-org8437c60">
<p>
List buckets that start with the name <code>$prefix</code>.
</p>

<div class="org-src-container">
<pre class="src src-sh">aws s3api list-buckets \
    | jq -r --arg prefix $prefix \
         '.Buckets[]
          | select(.Name | startswith($prefix)).Name'
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb569f97" class="outline-3">
<h3 id="orgb569f97"><a href="#orgb569f97">Create Bucket</a></h3>
<div class="outline-text-3" id="text-orgb569f97">
<div class="org-src-container">
<pre class="src src-sh">aws s3api create-bucket \
    --bucket $BUCKET_NAME \
    --create-bucket-configuration LocationConstraint=$AWS_DEFAULT_REGION
</pre>
</div>
</div>
</div>

<div id="outline-container-org3598548" class="outline-3">
<h3 id="org3598548"><a href="#org3598548">List Objects</a></h3>
<div class="outline-text-3" id="text-org3598548">
<p>
All objects
</p>

<div class="org-src-container">
<pre class="src src-sh">aws s3api list-objects-v2 \
    --bucket $BucketName \
    | jq '.Contents[]'
</pre>
</div>

<p>
10 most recent objects. AWS has no way of doing this filtering server-side,
so you need to request all objects and then sort them.
</p>

<div class="org-src-container">
<pre class="src src-sh">aws s3api list-objects-v2 \
    --bucket $BucketName \
    | jq -r '.Contents
             | sort_by(.LastModified)
             | reverse | first | .Key'
</pre>
</div>
</div>
</div>

<div id="outline-container-org6660dfd" class="outline-3">
<h3 id="org6660dfd"><a href="#org6660dfd">Get object</a></h3>
<div class="outline-text-3" id="text-org6660dfd">
<div class="org-src-container">
<pre class="src src-sh">aws s3api get-object \
    --bucket $BucketName \
    --key $Key ./foo
</pre>
</div>
</div>
</div>

<div id="outline-container-org1fddda1" class="outline-3">
<h3 id="org1fddda1"><a href="#org1fddda1">Get multiple objects</a></h3>
<div class="outline-text-3" id="text-org1fddda1">
<div class="org-src-container">
<pre class="src src-sh">mkdir -p ~/Downloads/foo
aws s3 cp \
    --recursive \
    s3://$BucketName/ \
    ~/Downloads/foo/
</pre>
</div>
</div>
</div>

<div id="outline-container-org5dacec5" class="outline-3">
<h3 id="org5dacec5"><a href="#org5dacec5">Get Bucket Policy</a></h3>
<div class="outline-text-3" id="text-org5dacec5">
<div class="org-src-container">
<pre class="src src-sh">aws s3api get-bucket-policy --bucket $BucketName \
    | jq -r '.Policy' | jq
</pre>
</div>
</div>
</div>

<div id="outline-container-orgec7aefc" class="outline-3">
<h3 id="orgec7aefc"><a href="#orgec7aefc">Clear and delete buckets</a></h3>
<div class="outline-text-3" id="text-orgec7aefc">
<p>
To clear a bucket, I have functions for this in <a href="https://github.com/cfclrk/dotfiles/blob/master/dotfiles/.functions.fish">dotfiles/.functions.fish</a>.
</p>
</div>
</div>
</div>

<div id="outline-container-org154e02e" class="outline-2">
<h2 id="org154e02e"><a href="#org154e02e">SNS</a></h2>
<div class="outline-text-2" id="text-org154e02e">
</div>
<div id="outline-container-org12b98d1" class="outline-3">
<h3 id="org12b98d1"><a href="#org12b98d1">SNS topics</a></h3>
<div class="outline-text-3" id="text-org12b98d1">
<div class="org-src-container">
<pre class="src src-sh">aws sns list-topics \
    | jq '.Topics[] | .TopicArn'
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org09ca393" class="outline-2">
<h2 id="org09ca393"><a href="#org09ca393">SQS</a></h2>
<div class="outline-text-2" id="text-org09ca393">
</div>
<div id="outline-container-orgf6f0ddd" class="outline-3">
<h3 id="orgf6f0ddd"><a href="#orgf6f0ddd">List Queues</a></h3>
<div class="outline-text-3" id="text-orgf6f0ddd">
<div class="org-src-container">
<pre class="src src-sh">aws sqs list-queues \
    | jq '.QueueUrls[]'
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd684c4d" class="outline-3">
<h3 id="orgd684c4d"><a href="#orgd684c4d">Read Message</a></h3>
<div class="outline-text-3" id="text-orgd684c4d">
<div class="org-src-container">
<pre class="src src-sh" id="org967f7ac">aws sqs receive-message \
    --queue-url "$q_url" \
    --attribute-names All \
    --message-attribute-names All \
    --max-number-of-messages 2
</pre>
</div>
</div>
</div>

<div id="outline-container-org21bfe09" class="outline-3">
<h3 id="org21bfe09"><a href="#org21bfe09">Send Message</a></h3>
<div class="outline-text-3" id="text-org21bfe09">
<div class="org-src-container">
<pre class="src src-sh">aws sqs send-message \
    --queue-url "$q_url" \
    --message-body '{"Message": "{\"foo\":\"bar\"}"}'
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf97ac30" class="outline-2">
<h2 id="orgf97ac30"><a href="#orgf97ac30">SSM</a></h2>
<div class="outline-text-2" id="text-orgf97ac30">
<div class="org-src-container">
<pre class="src src-sh">aws ssm get-parameter \
    --with-decryption \
    --name $name
</pre>
</div>
</div>
</div>

<div id="outline-container-org2823b6b" class="outline-2">
<h2 id="org2823b6b"><a href="#org2823b6b">Identity Store (SSO)</a></h2>
<div class="outline-text-2" id="text-org2823b6b">
<p>
AWS SSO was renamed to AWS Identity Store.
</p>

<ul class="org-ul">
<li><p>
<a href="https://docs.aws.amazon.com/singlesignon/latest/IdentityStoreAPIReference/welcome.html">Identity Store API Reference</a>
</p>

<p>
These API operations correspond to the <code>aws identitystore</code> commands.
</p></li>

<li><p>
<a href="https://docs.aws.amazon.com/singlesignon/latest/PortalAPIReference/Welcome.html">IAM Idenetity Center Portal API Reference</a>
</p>

<p>
These API operations correspond to the <code>aws sso</code> commands.
</p></li>
</ul>
</div>

<div id="outline-container-org39c2282" class="outline-3">
<h3 id="org39c2282"><a href="#org39c2282">Register client</a></h3>
<div class="outline-text-3" id="text-org39c2282">
<p>
This command <b>does not</b> require AWS credentials. You only need a region.
</p>

<div class="org-src-container">
<pre class="src src-sh">aws --region us-east-1 sso-oidc register-client \
    --client-name foo \
    --client-type public
</pre>
</div>

<p>
Returns an object like:
</p>

<pre class="example" id="org315e0cf">
{
    "clientId": "abc1234",
    "clientSecret": "a JSON Web Token",
    "clientIdIssuedAt": 1659099242,
    "clientSecretExpiresAt": 1666875242
}
</pre>
</div>
</div>

<div id="outline-container-orgf5857a2" class="outline-3">
<h3 id="orgf5857a2"><a href="#orgf5857a2">Token</a></h3>
<div class="outline-text-3" id="text-orgf5857a2">
<div class="org-src-container">
<pre class="src src-sh">aws sso login
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh" id="org2fd03f1">token_file=~/.aws/sso/cache/$token_name.json
cat $token_file | jq -r '.accessToken'
</pre>
</div>
</div>
</div>

<div id="outline-container-org82aff8f" class="outline-3">
<h3 id="org82aff8f"><a href="#org82aff8f">List my accounts</a></h3>
<div class="outline-text-3" id="text-org82aff8f">
<div class="org-src-container">
<pre class="src src-sh">aws --region us-east-1 sso list-accounts \
    --access-token $token
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">aws --region us-east-1 sso list-account-roles \
    --access-token $token \
    --account-id $account
</pre>
</div>
</div>
</div>

<div id="outline-container-org3bea523" class="outline-3">
<h3 id="org3bea523"><a href="#org3bea523">Get credentials</a></h3>
<div class="outline-text-3" id="text-org3bea523">
<p>
The jq can be improved. See: <a href="https://github.com/aws/aws-cli/issues/5261">https://github.com/aws/aws-cli/issues/5261</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">creds=$(aws --region us-east-1 sso get-role-credentials \
            --role-name $role \
            --account-id $account \
            --access-token $token)

access_key=$(echo $creds | jq '.roleCredentials.accessKeyId')
secret_key=$(echo $creds | jq '.roleCredentials.secretAccessKey')
access_token=$(echo $creds | jq '.roleCredentials.sessionToken')

echo "AWS_ACCESS_KEY_ID=$access_key"
echo "AWS_SECRET_ACCESS_KEY=$secret_key"
echo "AWS_SESSION_TOKEN=$access_token"
echo "AWS_REGION=us-east-1"
echo "AWS_DEFAULT_REGION=us-east-1"
</pre>
</div>
</div>
</div>
</div>
</div>
</body>
</html>