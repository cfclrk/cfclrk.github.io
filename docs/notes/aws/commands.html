<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AWS Commands</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/static/main.css" />
</head>
<body>
<div id="preamble" class="status">
<nav id="navbar" class="cf">
  <ul class="cf">
    <li class="fl">
      <a href="/">cfclrk</a>
    </li>
    <li class="fr">
      <a href="/articles/home.html">Articles</a>
    </li>
    <li class="fr">
      <a href="/notes/home.html">Notes</a>
    </li>
	<li class="fr">
      <a href="/cloudformation/home.html">CloudFormation</a>
    </li>
  </ul>
</nav>
</div>
<div id="content" class="content">
<header>
<h1 class="title">AWS Commands</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orga3cd5e5">Account</a></li>
<li><a href="#orgf9a3f98">IP Address Ranges</a>
<ul>
<li><a href="#org0b6e61a">Get Region of IP</a></li>
</ul>
</li>
<li><a href="#org9a1716c">Regions</a>
<ul>
<li><a href="#orgadaf3d4">All Regions in Partition</a></li>
<li><a href="#org7355c61">All Regions in All Partitions</a></li>
<li><a href="#orgaca6d6e">Run a Command in All Regions</a>
<ul>
<li><a href="#orgcc449bc">Linear</a></li>
<li><a href="#orge080a7d">Parallel</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org6622052">ACM</a>
<ul>
<li><a href="#orga9d8f9e">List</a></li>
<li><a href="#org678a1f2">Describe</a></li>
<li><a href="#org8db7a20">Get Certificate</a></li>
<li><a href="#org671ce03">Get Certificate PEM File</a></li>
</ul>
</li>
<li><a href="#org8de3ff6">API Gateway V2</a>
<ul>
<li><a href="#org71d0405">List APIs</a></li>
</ul>
</li>
<li><a href="#orgcbdb582">CloudFormation</a>
<ul>
<li><a href="#org63ac14e">View Stack Log</a></li>
<li><a href="#org6ccb4a8">List Stacks</a></li>
<li><a href="#org13cf153">Stack Outputs</a></li>
<li><a href="#org0a91f8b">Get Stack Parameters</a></li>
<li><a href="#orgc932ae7">Exports</a></li>
<li><a href="#orgbfffa28">Spec Files</a></li>
</ul>
</li>
<li><a href="#org33ab348">CloudWatch</a>
<ul>
<li><a href="#org1cd064b">Delete All Alarms</a></li>
<li><a href="#orge254053">Create Alarm Targeting ASG policy</a></li>
</ul>
</li>
<li><a href="#orgd24a04e">DynamoDB</a>
<ul>
<li><a href="#orgc6af328">List Tables</a></li>
<li><a href="#org415b9af">Delete Tables Like a Maniac</a></li>
</ul>
</li>
<li><a href="#orge4e6655">EC2 AMIs</a>
<ul>
<li><a href="#orgc04b88b">List AMIs</a></li>
<li><a href="#org4fd5b0b">Get Latest Image</a></li>
<li><a href="#org1853a33">Delete AMIs and EBS Snapshots</a></li>
<li><a href="#orgf3af7df">List Accounts That Can Access AMI</a></li>
</ul>
</li>
<li><a href="#org3f45316">EC2 AZs</a>
<ul>
<li><a href="#orgd39896b">The Actual AZ</a></li>
</ul>
</li>
<li><a href="#orgbc46786">EC2 KeyPairs</a>
<ul>
<li><a href="#org4a97cf6">Create</a></li>
<li><a href="#org3a8e820">Describe</a></li>
<li><a href="#org878c9b3">Delete</a></li>
</ul>
</li>
<li><a href="#org210a7a7">EC2 Instances</a>
<ul>
<li><a href="#org0194855">Get Running Instances</a></li>
<li><a href="#org23c1756">Get All Instance Tags</a></li>
<li><a href="#orgbdfda0a">Get Instances with Tag Key</a></li>
<li><a href="#orgb1a735e">Get Instances with Tag Key/Value</a></li>
</ul>
</li>
<li><a href="#org78e7e4e">EC2 Transit Gateway</a>
<ul>
<li><a href="#orgc7117db">List Routes in a TG Route Table</a></li>
</ul>
</li>
<li><a href="#orga4e9f31">EC2 VPCs</a>
<ul>
<li><a href="#org3227143">VPCs</a></li>
<li><a href="#org6f3864a">Subnets</a></li>
<li><a href="#org03fe971">SecurityGroups</a></li>
<li><a href="#org5e6a6b6">Private ALB IPs</a></li>
<li><a href="#org45563e2">Managed Prefix Lists</a></li>
</ul>
</li>
<li><a href="#org7d0d552">EC2 Volumes</a>
<ul>
<li><a href="#org00561f2">List Volumes</a></li>
<li><a href="#orgb8112d8">List Unattached Volumes</a></li>
<li><a href="#org8fe17be">Delete Volumes</a></li>
</ul>
</li>
<li><a href="#orgfc156b4">ECR</a>
<ul>
<li><a href="#org3708cce">Log in</a></li>
<li><a href="#org265c9f4">Create Repository</a></li>
<li><a href="#org087e3cc">Add Image</a></li>
</ul>
</li>
<li><a href="#orgda46040">ECS</a></li>
<li><a href="#org9d82bc1">EKS</a>
<ul>
<li><a href="#org6abcc97">List Clusters</a></li>
<li><a href="#org29fa068">Get Kube Config</a></li>
</ul>
</li>
<li><a href="#orgb68facb">Elasticache</a>
<ul>
<li><a href="#orgdef9d6b">List CacheClusters</a></li>
<li><a href="#org63e1a8c">List ReplicationGroups</a></li>
</ul>
</li>
<li><a href="#org236cda6">ElasticBeanstalk</a>
<ul>
<li><a href="#org4b51a27">Config Options for Nampespace</a></li>
</ul>
</li>
<li><a href="#org97aa4bd">ElasticLoadBalancingV2</a>
<ul>
<li><a href="#orgbf9c75a">Describe ALBs</a></li>
<li><a href="#org2ad0e9d">Get DNS Name</a></li>
</ul>
</li>
<li><a href="#orgf82ecdb">GlobalAccelerator</a>
<ul>
<li><a href="#orga1fb30d">List Accelerators</a></li>
<li><a href="#orgbd138d9">List Listeners</a></li>
<li><a href="#org12897ab">IPs</a></li>
</ul>
</li>
<li><a href="#org7f0dd30">IAM</a>
<ul>
<li><a href="#org6e078b2">Create Policy</a></li>
<li><a href="#orgdefdcf3">Assume Role</a></li>
<li><a href="#org7ecfb89">List Instance Profiles</a></li>
<li><a href="#orge751e28">Delete Instance Profile</a></li>
</ul>
</li>
<li><a href="#org5dd2021">IMDS</a></li>
<li><a href="#orgd48228e">Kinesis</a>
<ul>
<li><a href="#org29a60bd">Delete Stream</a></li>
</ul>
</li>
<li><a href="#org3913fd2">Kinesis Firehose</a>
<ul>
<li><a href="#org2d6cfe5">Describe Stream</a></li>
<li><a href="#org8bce3c2">Update Stream S3 Destination Bucket</a></li>
<li><a href="#org65e428f">Update Stream S3 Destination Prefix</a></li>
</ul>
</li>
<li><a href="#org95ccb5f">Lambda</a>
<ul>
<li><a href="#org602ebd8">Invoke function</a></li>
<li><a href="#org44f7e3e">Create Function with Zip File</a></li>
<li><a href="#org857242a">Update Function code with Zip File</a></li>
<li><a href="#org5121dcc">Container Image: Run Interactively</a></li>
</ul>
</li>
<li><a href="#orgdeb7bd1">Organizations</a></li>
<li><a href="#org9b7dd05">Polly</a></li>
<li><a href="#orgc6df4eb">Reosurce Access Manager (RAM)</a></li>
<li><a href="#org4f8f023">Route53</a>
<ul>
<li><a href="#org54ae2ac">Get HostedZoneId from Name</a></li>
<li><a href="#org53ca653">List Records for a HostedZone</a></li>
</ul>
</li>
<li><a href="#org210ccd5">SecretsManager</a>
<ul>
<li><a href="#org9dd3401">List Secrets</a></li>
<li><a href="#org261dfd6">Get Secret</a></li>
<li><a href="#org5082bcf">Create Secret</a></li>
</ul>
</li>
<li><a href="#orgd7bd8b6">ServiceCatalog</a>
<ul>
<li><a href="#orga2e3988">Get Product IDs</a></li>
<li><a href="#orgf0b2fc4">Launch Product</a></li>
</ul>
</li>
<li><a href="#orgdddbaf3">Service Quotas</a>
<ul>
<li><a href="#org1cecf31">Get Quota</a></li>
<li><a href="#org51dca83">Get Default Quota</a></li>
</ul>
</li>
<li><a href="#orgd3edbcc">S3</a>
<ul>
<li><a href="#org89bd061">Canonical ID</a></li>
<li><a href="#org82dd913">Create Bucket</a></li>
<li><a href="#org291922e">List Objects</a></li>
<li><a href="#org5109ba4">Get Object</a></li>
<li><a href="#orge29acab">Get Bucket Policy</a></li>
<li><a href="#org2794a96">Delete Buckets</a></li>
</ul>
</li>
<li><a href="#org30ded50">SNS</a>
<ul>
<li><a href="#org81186a6">SNS topics</a></li>
</ul>
</li>
<li><a href="#orge5f17af">SQS</a>
<ul>
<li><a href="#org5aa0029">List Queues</a></li>
</ul>
</li>
<li><a href="#org611c47a">SSM</a></li>
<li><a href="#orgc6df39a">SSO</a>
<ul>
<li><a href="#org5599b19">Token</a></li>
<li><a href="#org8f92a28">List Accounts I Can Access</a></li>
</ul>
</li>
</ul>
</div>
</nav>

<div id="outline-container-orga3cd5e5" class="outline-2">
<h2 id="orga3cd5e5"><a href="#orga3cd5e5">Account</a></h2>
<div class="outline-text-2" id="text-orga3cd5e5">
<p>
Account number:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org38e5620">aws sts get-caller-identity --query <span style="color: #98be65;">'Account'</span> --output text
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf9a3f98" class="outline-2">
<h2 id="orgf9a3f98"><a href="#orgf9a3f98">IP Address Ranges</a></h2>
<div class="outline-text-2" id="text-orgf9a3f98">
<p>
AWS documentation is <a href="https://docs.aws.amazon.com/general/latest/gr/aws-ip-ranges.html">here</a>.
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org4a2a8c4">curl -s https://ip-ranges.amazonaws.com/ip-ranges.json
</pre>
</div>

<p>
<a href="ip_ranges.json">ip_ranges.json</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">cat <span style="color: #98be65;">"$IpRanges"</span> <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.prefixes[]</span>
<span style="color: #98be65;">          | select(.region = "us-east-2")</span>
<span style="color: #98be65;">          | .ip_prefix'</span>
</pre>
</div>
</div>

<div id="outline-container-org0b6e61a" class="outline-3">
<h3 id="org0b6e61a"><a href="#org0b6e61a">Get Region of IP</a></h3>
<div class="outline-text-3" id="text-org0b6e61a">
<p>
(Would be cool).
</p>

<p>
Check IP address against each CIDR range. Would be cool to do this using bit
comparisons.
</p>

<p>
See: <a href="https://unix.stackexchange.com/questions/274330/check-ip-is-in-range-of-whitelist-array">https://unix.stackexchange.com/questions/274330/check-ip-is-in-range-of-whitelist-array</a>
</p>
</div>
</div>
</div>

<div id="outline-container-org9a1716c" class="outline-2">
<h2 id="org9a1716c"><a href="#org9a1716c">Regions</a></h2>
<div class="outline-text-2" id="text-org9a1716c">
</div>
<div id="outline-container-orgadaf3d4" class="outline-3">
<h3 id="orgadaf3d4"><a href="#orgadaf3d4">All Regions in Partition</a></h3>
<div class="outline-text-3" id="text-orgadaf3d4">
<div class="org-src-container">
<pre class="src src-sh" id="org4ff72a9">aws ec2 describe-regions <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">".Regions[].RegionName"</span>
</pre>
</div>

<div class="results">#+RESULTS:</div><pre class="example">
eu-north-1
ap-south-1
eu-west-3
eu-west-2
eu-west-1
ap-northeast-3
ap-northeast-2
ap-northeast-1
sa-east-1
ca-central-1
ap-southeast-1
ap-southeast-2
eu-central-1
us-east-1
us-east-2
us-west-1
us-west-2
</pre>


<p>
Number of regions:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #c678dd;">echo</span> $<span style="color: #dcaeea;">AllRegions</span> | wc -w   <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Using wc</span>

<span style="color: #dcaeea;">regions</span>=($<span style="color: #dcaeea;">AllRegions</span>)      <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Or use an array, and</span>
<span style="color: #c678dd;">echo</span> ${#<span style="color: #dcaeea;">regions</span>[*]}        <span style="color: #5B6268;"># </span><span style="color: #5B6268;">print array length</span>
</pre>
</div>

<div class="results">#+RESULTS:</div><pre class="example">
21
21
</pre>
</div>
</div>

<div id="outline-container-org7355c61" class="outline-3">
<h3 id="org7355c61"><a href="#org7355c61">All Regions in All Partitions</a></h3>
<div class="outline-text-3" id="text-org7355c61">
<p>
Should be in the botocore data files. Also, we can pull them from the IpRanges
document. You have to decide whether "GLOBAL" is a "region" in your situation.
</p>

<div class="org-src-container">
<pre class="src src-sh">cat <span style="color: #98be65;">"$IpRanges"</span> <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.prefixes[].region'</span> <span style="color: #98be65;">\</span>
    | sort | uniq
</pre>
</div>
</div>
</div>

<div id="outline-container-orgaca6d6e" class="outline-3">
<h3 id="orgaca6d6e"><a href="#orgaca6d6e">Run a Command in All Regions</a></h3>
<div class="outline-text-3" id="text-orgaca6d6e">
</div>
<div id="outline-container-orgcc449bc" class="outline-4">
<h4 id="orgcc449bc"><a href="#orgcc449bc">Linear</a></h4>
<div class="outline-text-4" id="text-orgcc449bc">
<p>
Get the number of VPCs in each region the slow and simple way.
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #51afef;">for</span> region<span style="color: #51afef;"> in</span> $<span style="color: #dcaeea;">regions</span>; <span style="color: #51afef;">do</span>
    <span style="color: #dcaeea;">vpcs</span>=($(aws --region $<span style="color: #dcaeea;">region</span> ec2 describe-vpcs | jq <span style="color: #98be65;">'.Vpcs[].VpcId'</span>))
    <span style="color: #c678dd;">echo</span> <span style="color: #98be65;">"$region: ${#vpcs[*]}"</span>
<span style="color: #51afef;">done</span>
</pre>
</div>

<div class="results">#+RESULTS:</div><pre class="example">
eu-north-1: 0
ap-south-1: 0
eu-west-3: 0
eu-west-2: 0
eu-west-1: 0
ap-northeast-3: 1
ap-northeast-2: 0
ap-northeast-1: 0
sa-east-1: 0
ca-central-1: 0
ap-southeast-1: 1
ap-southeast-2: 0
eu-central-1: 0
us-east-1: 2
us-east-2: 3
us-west-1: 0
us-west-2: 0
</pre>
</div>
</div>

<div id="outline-container-orge080a7d" class="outline-4">
<h4 id="orge080a7d"><a href="#orge080a7d">Parallel</a></h4>
<div class="outline-text-4" id="text-orge080a7d">
<p>
Get the number of VPCs in each region the 🚀 and 😎 (and 🤮) way by starting
a subprocess for each region in parallel. Note that <code>${#regions[@]}</code> is bash
syntax for the length of the <code>$regions</code> array.
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #dcaeea;">script</span>=$(cat &lt;&lt;-<span style="color: #98be65;">"EOF"</span>
<span style="color: #98be65;">vpcs=($(aws --region {} ec2 describe-vpcs | jq '.Vpcs[].VpcId'))</span>
<span style="color: #98be65;">echo "{}: ${#vpcs[@]}"</span>
<span style="color: #98be65;">EOF</span>
)

<span style="color: #dcaeea;">regions</span>=($<span style="color: #dcaeea;">regions</span>)
printf <span style="color: #98be65;">"%s\n"</span> <span style="color: #98be65;">"${regions[@]}"</span> <span style="color: #98be65;">\</span>
    | xargs -n 1 <span style="color: #98be65;">\</span>
            -P ${#<span style="color: #dcaeea;">regions</span>[*]} <span style="color: #98be65;">\</span>
            -I {} <span style="color: #98be65;">\</span>
            bash -c <span style="color: #98be65;">"$script"</span>
</pre>
</div>

<div class="results">#+RESULTS:</div><pre class="example">
us-east-2: 8
ca-central-1: 2
eu-south-1: 1
eu-west-3: 1
us-west-2: 3
us-east-1: 97
eu-central-1: 1
us-west-1: 4
eu-north-1: 2
eu-west-2: 3
eu-west-1: 1
sa-east-1: 1
ap-northeast-2: 1
ap-northeast-1: 2
ap-south-1: 1
me-south-1: 1
ap-east-1: 1
ap-northeast-3: 1
af-south-1: 1
ap-southeast-1: 1
ap-southeast-2: 1
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org6622052" class="outline-2">
<h2 id="org6622052"><a href="#org6622052">ACM</a></h2>
<div class="outline-text-2" id="text-org6622052">
</div>
<div id="outline-container-orga9d8f9e" class="outline-3">
<h3 id="orga9d8f9e"><a href="#orga9d8f9e">List</a></h3>
<div class="outline-text-3" id="text-orga9d8f9e">
<div class="org-src-container">
<pre class="src src-sh">aws acm list-certificates <span style="color: #98be65;">\</span>
    --includes <span style="color: #98be65;">"keyUsage=ANY"</span> <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.CertificateSummaryList[]'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org678a1f2" class="outline-3">
<h3 id="org678a1f2"><a href="#org678a1f2">Describe</a></h3>
<div class="outline-text-3" id="text-org678a1f2">
<div class="org-src-container">
<pre class="src src-sh">aws acm describe-certificate <span style="color: #98be65;">\</span>
    --certificate-arn $<span style="color: #dcaeea;">CertArn</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org8db7a20" class="outline-3">
<h3 id="org8db7a20"><a href="#org8db7a20">Get Certificate</a></h3>
<div class="outline-text-3" id="text-org8db7a20">
<div class="org-src-container">
<pre class="src src-sh">aws acm get-certificate <span style="color: #98be65;">\</span>
    --certificate-arn $<span style="color: #dcaeea;">CertificateArn</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org671ce03" class="outline-3">
<h3 id="org671ce03"><a href="#org671ce03">Get Certificate PEM File</a></h3>
<div class="outline-text-3" id="text-org671ce03">
<div class="org-src-container">
<pre class="src src-sh">aws acm get-certificate <span style="color: #98be65;">\</span>
    --certificate-arn $<span style="color: #dcaeea;">CertificateArn</span> <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.Certificate'</span> &gt; route_guide_cert.pem
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">cat appliance_cert.pem
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org8de3ff6" class="outline-2">
<h2 id="org8de3ff6"><a href="#org8de3ff6">API Gateway V2</a></h2>
<div class="outline-text-2" id="text-org8de3ff6">
</div>
<div id="outline-container-org71d0405" class="outline-3">
<h3 id="org71d0405"><a href="#org71d0405">List APIs</a></h3>
<div class="outline-text-3" id="text-org71d0405">
<div class="org-src-container">
<pre class="src src-sh">aws apigatewayv2 get-apis <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.Items[]'</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgcbdb582" class="outline-2">
<h2 id="orgcbdb582"><a href="#orgcbdb582">CloudFormation</a></h2>
<div class="outline-text-2" id="text-orgcbdb582">
<p>
For create/deploy/update, see my <a href="https://github.com/cfclrk/cloudformation/blob/main/README.org">cloudformation/README.org</a>.
</p>
</div>

<div id="outline-container-org63ac14e" class="outline-3">
<h3 id="org63ac14e"><a href="#org63ac14e">View Stack Log</a></h3>
<div class="outline-text-3" id="text-org63ac14e">
<div class="org-src-container">
<pre class="src src-sh">aws cloudformation list-stacks <span style="color: #98be65;">\</span>
    | jq -M <span style="color: #98be65;">'.StackSummaries[0].StackId'</span> <span style="color: #98be65;">\</span>
    | xargs aws cloudformation describe-stack-events --stack-name
</pre>
</div>
</div>
</div>

<div id="outline-container-org6ccb4a8" class="outline-3">
<h3 id="org6ccb4a8"><a href="#org6ccb4a8">List Stacks</a></h3>
<div class="outline-text-3" id="text-org6ccb4a8">
<p>
List only the created stacks
</p>

<div class="org-src-container">
<pre class="src src-sh">aws cloudformation list-stacks <span style="color: #98be65;">\</span>
    --stack-status-filter CREATE_IN_PROGRESS CREATE_COMPLETE
</pre>
</div>
</div>
</div>

<div id="outline-container-org13cf153" class="outline-3">
<h3 id="org13cf153"><a href="#org13cf153">Stack Outputs</a></h3>
<div class="outline-text-3" id="text-org13cf153">
<div class="org-src-container">
<pre class="src src-sh">aws cloudformation describe-stacks <span style="color: #98be65;">\</span>
    --stack-name $<span style="color: #dcaeea;">StackName</span> <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.Stacks[].Outputs[]'</span>
</pre>
</div>

<p>
Get the value of a single output:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws cloudformation describe-stacks <span style="color: #98be65;">\</span>
    --stack-name $<span style="color: #dcaeea;">StackName</span> <span style="color: #98be65;">\</span>
    --query <span style="color: #98be65;">"Stacks[0].Outputs[?OutputKey=='$OutputKey'].OutputValue"</span> <span style="color: #98be65;">\</span>
    --output text
</pre>
</div>
</div>
</div>

<div id="outline-container-org0a91f8b" class="outline-3">
<h3 id="org0a91f8b"><a href="#org0a91f8b">Get Stack Parameters</a></h3>
<div class="outline-text-3" id="text-org0a91f8b">
<p>
Get all parameters used to create a particular stack:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws cloudformation describe-stacks <span style="color: #98be65;">\</span>
    --stack-name $<span style="color: #dcaeea;">StackName</span> <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.Stacks[].Parameters[]'</span>
</pre>
</div>

<p>
Get the value of a single parameter:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws cloudformation describe-stacks <span style="color: #98be65;">\</span>
    --stack-name $<span style="color: #dcaeea;">StackName</span> <span style="color: #98be65;">\</span>
    --query <span style="color: #98be65;">"Stacks[0].Parameters[?ParameterKey=='$Parameter'].ParameterValue"</span> <span style="color: #98be65;">\</span>
    --output text
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc932ae7" class="outline-3">
<h3 id="orgc932ae7"><a href="#orgc932ae7">Exports</a></h3>
<div class="outline-text-3" id="text-orgc932ae7">
<p>
Get value of the exported field with name <code>$ExportName</code>:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws cloudformation list-exports <span style="color: #98be65;">\</span>
    --query <span style="color: #98be65;">"Exports[?Name=='$ExportName'].Value"</span> <span style="color: #98be65;">\</span>
    --output text
</pre>
</div>

<p>
List exports that start with a string:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws cloudformation list-exports <span style="color: #98be65;">\</span>
    --query <span style="color: #98be65;">"Exports[?starts_with(Name, 'foo-')].[Name, Value]"</span> <span style="color: #98be65;">\</span>
    --output text
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbfffa28" class="outline-3">
<h3 id="orgbfffa28"><a href="#orgbfffa28">Spec Files</a></h3>
<div class="outline-text-3" id="text-orgbfffa28">
<p>
URLs are documented <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-resource-specification.html">here</a>.
</p>
</div>
</div>
</div>

<div id="outline-container-org33ab348" class="outline-2">
<h2 id="org33ab348"><a href="#org33ab348">CloudWatch</a></h2>
<div class="outline-text-2" id="text-org33ab348">
</div>
<div id="outline-container-org1cd064b" class="outline-3">
<h3 id="org1cd064b"><a href="#org1cd064b">Delete All Alarms</a></h3>
<div class="outline-text-3" id="text-org1cd064b">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #dcaeea;">alarms</span>=$(aws cloudwatch describe-alarms <span style="color: #98be65;">\</span>
             | jq -r <span style="color: #98be65;">'.MetricAlarms[].AlarmName'</span>)

<span style="color: #51afef;">for</span> alarm<span style="color: #51afef;"> in</span> $<span style="color: #dcaeea;">alarms</span>; <span style="color: #51afef;">do</span>
    aws cloudwatch delete-alarms <span style="color: #98be65;">\</span>
        --alarm-names $<span style="color: #dcaeea;">alarm</span>;
<span style="color: #51afef;">done</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge254053" class="outline-3">
<h3 id="orge254053"><a href="#orge254053">Create Alarm Targeting ASG policy</a></h3>
<div class="outline-text-3" id="text-orge254053">
<div class="org-src-container">
<pre class="src src-sh">aws cloudwatch put-metric-alarm <span style="color: #98be65;">\</span>
    --alarm-name AddCapacity <span style="color: #98be65;">\</span>
    --metric-name CPUUtilization <span style="color: #98be65;">\</span>
    --namespace AWS/EC2 <span style="color: #98be65;">\</span>
    --statistic Average <span style="color: #98be65;">\</span>
    --period 120 <span style="color: #98be65;">\</span>
    --threshold 80 <span style="color: #98be65;">\</span>
    --comparison-operator GreaterThanOrEqualToThreshold <span style="color: #98be65;">\</span>
    --dimensions <span style="color: #98be65;">"Name=AutoScalingGroupName,Value=my-asg"</span> <span style="color: #98be65;">\</span>
    --evaluation-periods 2 <span style="color: #98be65;">\</span>
    --alarm-actions $<span style="color: #dcaeea;">ScalingPolicyArn</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd24a04e" class="outline-2">
<h2 id="orgd24a04e"><a href="#orgd24a04e">DynamoDB</a></h2>
<div class="outline-text-2" id="text-orgd24a04e">
<p>
The paper: <a href="https://www.allthingsdistributed.com/files/amazon-dynamo-sosp2007.pdf">Dynamo: Amazon’s Highly Available Key-value Store</a>. This describes a
distributed database with a leaderless replication model.
</p>

<p>
From <a href="https://shop.aer.io/oreilly/p/designing-data-intensive-applications/9781449373320-9149">Designing Data-Intensive Applications</a> by Martin Kleppmann:
</p>

<blockquote>
<p>
Dynamo is not available to users outside of Amazon. Confusingly, AWS offers a
hosted database product called DynamoDB, which uses a completely different
architecture: it is based on single-leader replication.
</p>
</blockquote>
</div>

<div id="outline-container-orgc6af328" class="outline-3">
<h3 id="orgc6af328"><a href="#orgc6af328">List Tables</a></h3>
<div class="outline-text-3" id="text-orgc6af328">
<div class="org-src-container">
<pre class="src src-sh">aws dynamodb  list-tables | jq <span style="color: #98be65;">'.TableNames[]'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org415b9af" class="outline-3">
<h3 id="org415b9af"><a href="#org415b9af">Delete Tables Like a Maniac</a></h3>
<div class="outline-text-3" id="text-org415b9af">
<p>
AWS allows you to delete have 10 <code>delete-table</code> operations running at a time.
We can create a pool of 10 processes and continuously pump <code>delete-table</code>
commands into it using <code>xargs</code>.
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #dcaeea;">script</span>=$(cat &lt;&lt;<span style="color: #98be65;">"EOF"</span>
<span style="color: #98be65;">aws dynamodb delete-table --table-name {}</span>
<span style="color: #98be65;">aws dynamodb wait table-not-exists --table-name {}</span>
<span style="color: #98be65;">EOF</span>
      )
<span style="color: #c678dd;">echo</span> ${<span style="color: #dcaeea;">tables</span>[*]} <span style="color: #98be65;">\</span>
    | xargs -n 1 -P 10 -I {} sh -c <span style="color: #98be65;">"$scrpt"</span>
</pre>
</div>

<p>
TODO: When I originally wrote this, I remember needing to add a <code>tr " " "\n"</code>
or something for portability with Linux. Test this out again.
</p>

<p>
TODO: script used to be one command (using <code>&amp;&amp;</code>); test again after splitting
it into two commands.
</p>
</div>
</div>
</div>

<div id="outline-container-orge4e6655" class="outline-2">
<h2 id="orge4e6655"><a href="#orge4e6655">EC2 AMIs</a></h2>
<div class="outline-text-2" id="text-orge4e6655">
</div>
<div id="outline-container-orgc04b88b" class="outline-3">
<h3 id="orgc04b88b"><a href="#orgc04b88b">List AMIs</a></h3>
<div class="outline-text-3" id="text-orgc04b88b">
<p>
All of this account's AMIs:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-images --owners $<span style="color: #dcaeea;">Account</span>
</pre>
</div>

<p>
All of this account's AMIs with a particular Name tag:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-images <span style="color: #98be65;">\</span>
    --owners $<span style="color: #dcaeea;">account</span> <span style="color: #98be65;">\</span>
    --filters <span style="color: #98be65;">"Name=tag:Name,Values=My AMI"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4fd5b0b" class="outline-3">
<h3 id="org4fd5b0b"><a href="#org4fd5b0b">Get Latest Image</a></h3>
<div class="outline-text-3" id="text-org4fd5b0b">
<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-images <span style="color: #98be65;">\</span>
    --owners $<span style="color: #dcaeea;">Account</span> <span style="color: #98be65;">\</span>
    --filters <span style="color: #98be65;">"Name=state,Values=available"</span> <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.Images</span>
<span style="color: #98be65;">             | sort_by(.CreationDate)</span>
<span style="color: #98be65;">             | last | .ImageId'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1853a33" class="outline-3">
<h3 id="org1853a33"><a href="#org1853a33">Delete AMIs and EBS Snapshots</a></h3>
<div class="outline-text-3" id="text-org1853a33">
<p>
List AMIs to delete and set to variable <code>AmisToDelete</code>. Then:
</p>

<div class="org-src-container">
<pre class="src src-sh">jq -c <span style="color: #98be65;">'.Images</span>
<span style="color: #98be65;">       | sort_by(.CreationDate)</span>
<span style="color: #98be65;">       | .[]</span>
<span style="color: #98be65;">       | {name: .Name, snap: .BlockDeviceMappings[]</span>
<span style="color: #98be65;">       | select(.Ebs != null)</span>
<span style="color: #98be65;">       | .Ebs.SnapshotId}'</span> &lt; $<span style="color: #dcaeea;">AmisToDelete</span> &gt; images.txt
</pre>
</div>

<p>
And then&#x2026; what did I do?
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #51afef;">for</span> i<span style="color: #51afef;"> in</span> (cat images.txt | jq); <span style="color: #51afef;">do</span>
    <span style="color: #5B6268;"># </span><span style="color: #5B6268;">deregister image</span>
    <span style="color: #5B6268;"># </span><span style="color: #5B6268;">delete the snapshot</span>
<span style="color: #51afef;">done</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf3af7df" class="outline-3">
<h3 id="orgf3af7df"><a href="#orgf3af7df">List Accounts That Can Access AMI</a></h3>
<div class="outline-text-3" id="text-orgf3af7df">
<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-image-attribute <span style="color: #98be65;">\</span>
    --image-id $<span style="color: #dcaeea;">ImageID</span> <span style="color: #98be65;">\</span>
    --attribute launchPermission
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org3f45316" class="outline-2">
<h2 id="org3f45316"><a href="#org3f45316">EC2 AZs</a></h2>
<div class="outline-text-2" id="text-org3f45316">
<p>
All AZs in all regions:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #51afef;">for</span> region<span style="color: #51afef;"> in</span> $<span style="color: #dcaeea;">AllRegions</span>; <span style="color: #51afef;">do</span>
    <span style="color: #dcaeea;">azs</span>=$(aws --region $<span style="color: #dcaeea;">region</span> ec2 describe-availability-zones <span style="color: #98be65;">\</span>
              | jq -c <span style="color: #98be65;">'[.AvailabilityZones[].ZoneName]'</span>)
    printf <span style="color: #98be65;">"$region: $azs\n"</span>
<span style="color: #51afef;">done</span>
</pre>
</div>

<div class="results">#+RESULTS:</div><pre class="example">
eu-north-1: ["eu-north-1a","eu-north-1b","eu-north-1c"]
ap-south-1: ["ap-south-1a","ap-south-1b","ap-south-1c"]
eu-west-3: ["eu-west-3a","eu-west-3b","eu-west-3c"]
eu-west-2: ["eu-west-2a","eu-west-2b","eu-west-2c"]
eu-west-1: ["eu-west-1a","eu-west-1b","eu-west-1c"]
ap-northeast-3: ["ap-northeast-3a","ap-northeast-3b","ap-northeast-3c"]
ap-northeast-2: ["ap-northeast-2a","ap-northeast-2b","ap-northeast-2c","ap-northeast-2d"]
ap-northeast-1: ["ap-northeast-1a","ap-northeast-1c","ap-northeast-1d"]
sa-east-1: ["sa-east-1a","sa-east-1b","sa-east-1c"]
ca-central-1: ["ca-central-1a","ca-central-1b","ca-central-1d"]
ap-southeast-1: ["ap-southeast-1a","ap-southeast-1b","ap-southeast-1c"]
ap-southeast-2: ["ap-southeast-2a","ap-southeast-2b","ap-southeast-2c"]
eu-central-1: ["eu-central-1a","eu-central-1b","eu-central-1c"]
us-east-1: ["us-east-1a","us-east-1b","us-east-1c","us-east-1d","us-east-1e","us-east-1f"]
us-east-2: ["us-east-2a","us-east-2b","us-east-2c"]
us-west-1: ["us-west-1b","us-west-1c"]
us-west-2: ["us-west-2a","us-west-2b","us-west-2c","us-west-2d"]
</pre>
</div>

<div id="outline-container-orgd39896b" class="outline-3">
<h3 id="orgd39896b"><a href="#orgd39896b">The Actual AZ</a></h3>
<div class="outline-text-3" id="text-orgd39896b">
<p>
<code>us-east-1b</code> does not mean the same thing in every AWS account. If everyone
creates infra in <code>us-east-1b</code>, that infra will actually be in several
different AZs, depending on which AZ <code>us-east-1b</code> maps to for each account.
To determine the <i>real</i> AZ, you need to look at the <b>Zone ID</b>.
</p>

<p>
Print the Zone Name and Zone ID for each AZ in a region:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-availability-zones <span style="color: #98be65;">\</span>
    | jq -c <span style="color: #98be65;">'.AvailabilityZones[]</span>
<span style="color: #98be65;">             | {"Name": .ZoneName, "Id": .ZoneId}'</span>
</pre>
</div>

<div class="results">#+RESULTS:</div><pre class="example">
{"Name":"us-east-2a","Id":"use2-az1"}
{"Name":"us-east-2b","Id":"use2-az2"}
{"Name":"us-east-2c","Id":"use2-az3"}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbc46786" class="outline-2">
<h2 id="orgbc46786"><a href="#orgbc46786">EC2 KeyPairs</a></h2>
<div class="outline-text-2" id="text-orgbc46786">
</div>
<div id="outline-container-org4a97cf6" class="outline-3">
<h3 id="org4a97cf6"><a href="#org4a97cf6">Create</a></h3>
<div class="outline-text-3" id="text-org4a97cf6">
<div class="org-src-container">
<pre class="src src-sh" id="org1b6f3aa">aws ec2 create-key-pair --key-name $<span style="color: #dcaeea;">KeyName</span>
</pre>
</div>

<p>
Copy private key to <code>~/.ssh</code>
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #dcaeea;">KeyName</span>=$(<span style="color: #c678dd;">echo</span> $<span style="color: #dcaeea;">KeyPair</span> | jq -r <span style="color: #98be65;">'.KeyName'</span>)
<span style="color: #dcaeea;">KeyFile</span>=~/.ssh/$<span style="color: #dcaeea;">dir</span>/$<span style="color: #dcaeea;">KeyName</span>
<span style="color: #c678dd;">echo</span> $<span style="color: #dcaeea;">KeyPair</span> | jq -r <span style="color: #98be65;">'.KeyMaterial'</span> &gt; $<span style="color: #dcaeea;">KeyFile</span>
chmod 0600 $<span style="color: #dcaeea;">KeyFile</span>
<span style="color: #c678dd;">echo</span> $<span style="color: #dcaeea;">KeyFile</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3a8e820" class="outline-3">
<h3 id="org3a8e820"><a href="#org3a8e820">Describe</a></h3>
<div class="outline-text-3" id="text-org3a8e820">
<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-key-pairs | jq <span style="color: #98be65;">'.KeyPairs[]'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org878c9b3" class="outline-3">
<h3 id="org878c9b3"><a href="#org878c9b3">Delete</a></h3>
<div class="outline-text-3" id="text-org878c9b3">
<div class="org-src-container">
<pre class="src src-sh">aws ec2 delete-key-pair --key-name $<span style="color: #dcaeea;">KeyName</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org210a7a7" class="outline-2">
<h2 id="org210a7a7"><a href="#org210a7a7">EC2 Instances</a></h2>
<div class="outline-text-2" id="text-org210a7a7">
</div>
<div id="outline-container-org0194855" class="outline-3">
<h3 id="org0194855"><a href="#org0194855">Get Running Instances</a></h3>
<div class="outline-text-3" id="text-org0194855">
<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-instances <span style="color: #98be65;">\</span>
    --query <span style="color: #98be65;">"Reservations[].Instances[?State.name=="</span>running<span style="color: #98be65;">"]"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org23c1756" class="outline-3">
<h3 id="org23c1756"><a href="#org23c1756">Get All Instance Tags</a></h3>
<div class="outline-text-3" id="text-org23c1756">
<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-instances <span style="color: #98be65;">\</span>
    | jq -c <span style="color: #98be65;">'.Reservations[] | .Instances[] | .Tags[]'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbdfda0a" class="outline-3">
<h3 id="orgbdfda0a"><a href="#orgbdfda0a">Get Instances with Tag Key</a></h3>
<div class="outline-text-3" id="text-orgbdfda0a">
<p>
With just a specific Tag key, disregarding value:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-instances <span style="color: #98be65;">\</span>
    --filter <span style="color: #98be65;">"Name=tag-key,Values=k8s.io/role/node"</span> <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.Reservations[].Instances[]'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb1a735e" class="outline-3">
<h3 id="orgb1a735e"><a href="#orgb1a735e">Get Instances with Tag Key/Value</a></h3>
<div class="outline-text-3" id="text-orgb1a735e">
<p>
With just a specific Tag key:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-instances <span style="color: #98be65;">\</span>
    --filter <span style="color: #98be65;">"Name=tag:$TagName,Values=$TagValue"</span> <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.Reservations[].Instances[].Tags[]</span>
<span style="color: #98be65;">             | select(.Key == "Name")</span>
<span style="color: #98be65;">             | .Value'</span>
</pre>
</div>

<p>
With a specific tag key and value
</p>
</div>
</div>
</div>

<div id="outline-container-org78e7e4e" class="outline-2">
<h2 id="org78e7e4e"><a href="#org78e7e4e">EC2 Transit Gateway</a></h2>
<div class="outline-text-2" id="text-org78e7e4e">
</div>
<div id="outline-container-orgc7117db" class="outline-3">
<h3 id="orgc7117db"><a href="#orgc7117db">List Routes in a TG Route Table</a></h3>
<div class="outline-text-3" id="text-orgc7117db">
<div class="org-src-container">
<pre class="src src-sh">aws --profile shared-services --region us-east-1 <span style="color: #98be65;">\</span>
    ec2 search-transit-gateway-routes <span style="color: #98be65;">\</span>
    --transit-gateway-route-table-id $<span style="color: #dcaeea;">TGWRouteTableId</span> <span style="color: #98be65;">\</span>
    --filters <span style="color: #98be65;">"Name=type,Values=propagated"</span> <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.Routes[].DestinationCidrBlock'</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orga4e9f31" class="outline-2">
<h2 id="orga4e9f31"><a href="#orga4e9f31">EC2 VPCs</a></h2>
<div class="outline-text-2" id="text-orga4e9f31">
</div>
<div id="outline-container-org3227143" class="outline-3">
<h3 id="org3227143"><a href="#org3227143">VPCs</a></h3>
<div class="outline-text-3" id="text-org3227143">
<div class="org-src-container">
<pre class="src src-bash">aws ec2 describe-vpcs | jq <span style="color: #98be65;">'.Vpcs[]'</span>
</pre>
</div>

<p>
The names of VPCs that have a <code>Name</code> tag:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-vpcs <span style="color: #98be65;">\</span>
    --filters <span style="color: #dcaeea;">Name</span>=tag-key,<span style="color: #dcaeea;">Values</span>=Name <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.Vpcs[].Tags[]</span>
<span style="color: #98be65;">             | select(.Key == "Name")</span>
<span style="color: #98be65;">             | .Value'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6f3864a" class="outline-3">
<h3 id="org6f3864a"><a href="#org6f3864a">Subnets</a></h3>
<div class="outline-text-3" id="text-org6f3864a">
<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-subnets  | jq <span style="color: #98be65;">'.Subnets'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org03fe971" class="outline-3">
<h3 id="org03fe971"><a href="#org03fe971">SecurityGroups</a></h3>
<div class="outline-text-3" id="text-org03fe971">
<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-security-groups <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.SecurityGroups'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5e6a6b6" class="outline-3">
<h3 id="org5e6a6b6"><a href="#org5e6a6b6">Private ALB IPs</a></h3>
<div class="outline-text-3" id="text-org5e6a6b6">
<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-network-interfaces <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.NetworkInterfaces[]</span>
<span style="color: #98be65;">          | select(.Attachment.InstanceOwnerId == "amazon-elb")</span>
<span style="color: #98be65;">          | .PrivateIpAddress'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org45563e2" class="outline-3">
<h3 id="org45563e2"><a href="#org45563e2">Managed Prefix Lists</a></h3>
<div class="outline-text-3" id="text-org45563e2">
<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-managed-prefix-lists <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.PrefixLists[]'</span>
</pre>
</div>

<p>
#+header :var PrefixListID=""
</p>
<div class="org-src-container">
<pre class="src src-sh">aws ec2 get-managed-prefix-list-entries <span style="color: #98be65;">\</span>
    --prefix-list-id $<span style="color: #dcaeea;">PrefixListID</span> <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.Entries[]'</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org7d0d552" class="outline-2">
<h2 id="org7d0d552"><a href="#org7d0d552">EC2 Volumes</a></h2>
<div class="outline-text-2" id="text-org7d0d552">
</div>
<div id="outline-container-org00561f2" class="outline-3">
<h3 id="org00561f2"><a href="#org00561f2">List Volumes</a></h3>
<div class="outline-text-3" id="text-org00561f2">
<div class="org-src-container">
<pre class="src src-sh" id="org6e900d0">aws ec2 describe-volumes <span style="color: #98be65;">\</span>
    --filters <span style="color: #dcaeea;">Name</span>=tag-key,<span style="color: #dcaeea;">Values</span>=$<span style="color: #dcaeea;">Tag</span> <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.Volumes[].VolumeId'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb8112d8" class="outline-3">
<h3 id="orgb8112d8"><a href="#orgb8112d8">List Unattached Volumes</a></h3>
<div class="outline-text-3" id="text-orgb8112d8">
<div class="org-src-container">
<pre class="src src-sh" id="orge04ca44">aws ec2 describe-volumes <span style="color: #98be65;">\</span>
    --filters <span style="color: #dcaeea;">Name</span>=status,<span style="color: #dcaeea;">Values</span>=available <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.Volumes[].VolumeId'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org8fe17be" class="outline-3">
<h3 id="org8fe17be"><a href="#org8fe17be">Delete Volumes</a></h3>
<div class="outline-text-3" id="text-org8fe17be">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #51afef;">for</span> volume<span style="color: #51afef;"> in</span> $<span style="color: #dcaeea;">Volumes</span>; <span style="color: #51afef;">do</span>
    aws ec2 delete-volume --volume-id $<span style="color: #dcaeea;">volume</span>
<span style="color: #51afef;">done</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgfc156b4" class="outline-2">
<h2 id="orgfc156b4"><a href="#orgfc156b4">ECR</a></h2>
<div class="outline-text-2" id="text-orgfc156b4">
</div>
<div id="outline-container-org3708cce" class="outline-3">
<h3 id="org3708cce"><a href="#org3708cce">Log in</a></h3>
<div class="outline-text-3" id="text-org3708cce">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #dcaeea;">ecr</span>=$<span style="color: #dcaeea;">account</span>.dkr.ecr.$<span style="color: #dcaeea;">AWS_DEFAULT_REGION</span>.amazonaws.com
<span style="color: #dcaeea;">pw</span>=$(aws ecr get-login-password)
docker login <span style="color: #98be65;">\</span>
       --username AWS <span style="color: #98be65;">\</span>
       --password <span style="color: #98be65;">"$pw"</span> <span style="color: #98be65;">\</span>
       <span style="color: #98be65;">"https://$ecr"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org265c9f4" class="outline-3">
<h3 id="org265c9f4"><a href="#org265c9f4">Create Repository</a></h3>
<div class="outline-text-3" id="text-org265c9f4">
<div class="org-src-container">
<pre class="src src-sh">aws ecr create-repository <span style="color: #98be65;">\</span>
    --repository-name $<span style="color: #dcaeea;">repoName</span> <span style="color: #98be65;">\</span>
    --tags <span style="color: #98be65;">"Key=Foo,Value=True"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org087e3cc" class="outline-3">
<h3 id="org087e3cc"><a href="#org087e3cc">Add Image</a></h3>
<div class="outline-text-3" id="text-org087e3cc">
<p>
Tag image for ECR:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #dcaeea;">ecr</span>=$<span style="color: #dcaeea;">account</span>.dkr.ecr.$<span style="color: #dcaeea;">AWS_DEFAULT_REGION</span>.amazonaws.com
docker tag <span style="color: #98be65;">\</span>
       $<span style="color: #dcaeea;">image</span>:$<span style="color: #dcaeea;">tag</span> <span style="color: #98be65;">\</span>
       $<span style="color: #dcaeea;">ecr</span>/$<span style="color: #dcaeea;">name</span>:$<span style="color: #dcaeea;">tag</span>
</pre>
</div>

<p>
Push it:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #dcaeea;">ecr</span>=$<span style="color: #dcaeea;">account</span>.dkr.ecr.$<span style="color: #dcaeea;">AWS_DEFAULT_REGION</span>.amazonaws.com
docker push <span style="color: #98be65;">\</span>
       $<span style="color: #dcaeea;">ecr</span>/$<span style="color: #dcaeea;">name</span>:$<span style="color: #dcaeea;">tag</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgda46040" class="outline-2">
<h2 id="orgda46040"><a href="#orgda46040">ECS</a></h2>
<div class="outline-text-2" id="text-orgda46040">
<p>
Fix a CloudFormation deployment where an ECS service fails to stabilize. Taken
from <a href="https://aws.amazon.com/premiumsupport/knowledge-center/cloudformation-ecs-service-stabilize/">this</a> AWS blog post. Just updates the number of ECS service tasks to 0.
</p>

<div class="org-src-container">
<pre class="src src-sh">aws ecs update-service <span style="color: #98be65;">\</span>
    --cluster $<span style="color: #dcaeea;">ECS_CLUSTER_NAME</span> <span style="color: #98be65;">\</span>
    --service $<span style="color: #dcaeea;">ECS_SERVICE_NAME</span> <span style="color: #98be65;">\</span>
    --desired-count 0
</pre>
</div>
</div>
</div>

<div id="outline-container-org9d82bc1" class="outline-2">
<h2 id="org9d82bc1"><a href="#org9d82bc1">EKS</a></h2>
<div class="outline-text-2" id="text-org9d82bc1">
</div>
<div id="outline-container-org6abcc97" class="outline-3">
<h3 id="org6abcc97"><a href="#org6abcc97">List Clusters</a></h3>
<div class="outline-text-3" id="text-org6abcc97">
<div class="org-src-container">
<pre class="src src-sh">aws eks list-clusters | jq <span style="color: #98be65;">'.clusters[]'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org29fa068" class="outline-3">
<h3 id="org29fa068"><a href="#org29fa068">Get Kube Config</a></h3>
<div class="outline-text-3" id="text-org29fa068">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #dcaeea;">KUBECONFIG</span>=~/.kube/ironnet_clusters/$<span style="color: #dcaeea;">CLUSTER_NAME</span>
aws eks update-kubeconfig <span style="color: #98be65;">\</span>
    --name $<span style="color: #dcaeea;">CLUSTER_NAME</span> <span style="color: #98be65;">\</span>
    --kubeconfig $<span style="color: #dcaeea;">KUBECONFIG</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb68facb" class="outline-2">
<h2 id="orgb68facb"><a href="#orgb68facb">Elasticache</a></h2>
<div class="outline-text-2" id="text-orgb68facb">
</div>
<div id="outline-container-orgdef9d6b" class="outline-3">
<h3 id="orgdef9d6b"><a href="#orgdef9d6b">List CacheClusters</a></h3>
<div class="outline-text-3" id="text-orgdef9d6b">
<div class="org-src-container">
<pre class="src src-sh">aws elasticache describe-cache-clusters <span style="color: #98be65;">\</span>
    --show-cache-node-info <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.CacheClusters'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org63e1a8c" class="outline-3">
<h3 id="org63e1a8c"><a href="#org63e1a8c">List ReplicationGroups</a></h3>
<div class="outline-text-3" id="text-org63e1a8c">
<div class="org-src-container">
<pre class="src src-sh">aws elasticache describe-replication-groups
        | jq <span style="color: #98be65;">'.ReplicationGroups'</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org236cda6" class="outline-2">
<h2 id="org236cda6"><a href="#org236cda6">ElasticBeanstalk</a></h2>
<div class="outline-text-2" id="text-org236cda6">
</div>
<div id="outline-container-org4b51a27" class="outline-3">
<h3 id="org4b51a27"><a href="#org4b51a27">Config Options for Nampespace</a></h3>
<div class="outline-text-3" id="text-org4b51a27">
<div class="org-src-container">
<pre class="src src-sh">aws elasticbeanstalk describe-configuration-options <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.Options[]</span>
<span style="color: #98be65;">          | if .Namespace == "aws:autoscaling:launchconfiguration"</span>
<span style="color: #98be65;">            then .</span>
<span style="color: #98be65;">            else null</span>
<span style="color: #98be65;">            end'</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org97aa4bd" class="outline-2">
<h2 id="org97aa4bd"><a href="#org97aa4bd">ElasticLoadBalancingV2</a></h2>
<div class="outline-text-2" id="text-org97aa4bd">
</div>
<div id="outline-container-orgbf9c75a" class="outline-3">
<h3 id="orgbf9c75a"><a href="#orgbf9c75a">Describe ALBs</a></h3>
<div class="outline-text-3" id="text-orgbf9c75a">
<div class="org-src-container">
<pre class="src src-sh">aws elbv2 describe-load-balancers <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.LoadBalancers[] | select(.Type == "application")'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org2ad0e9d" class="outline-3">
<h3 id="org2ad0e9d"><a href="#org2ad0e9d">Get DNS Name</a></h3>
<div class="outline-text-3" id="text-org2ad0e9d">
<div class="org-src-container">
<pre class="src src-sh">aws elbv2 describe-load-balancers <span style="color: #98be65;">\</span>
    | jq -r --arg DEPLOYMENT_NAME <span style="color: #98be65;">"$DEPLOYMENT_NAME"</span> <span style="color: #98be65;">\</span>
         <span style="color: #98be65;">'.LoadBalancers[]</span>
<span style="color: #98be65;">          | select(.Type == "application")</span>
<span style="color: #98be65;">          | select(.LoadBalancerName</span>
<span style="color: #98be65;">          | startswith($DEPLOYMENT_NAME))</span>
<span style="color: #98be65;">          | .DNSName'</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf82ecdb" class="outline-2">
<h2 id="orgf82ecdb"><a href="#orgf82ecdb">GlobalAccelerator</a></h2>
<div class="outline-text-2" id="text-orgf82ecdb">
<p>
GlobalAccelerator is only in <code>us-west-2</code>, so set the region explicitly.
</p>
</div>

<div id="outline-container-orga1fb30d" class="outline-3">
<h3 id="orga1fb30d"><a href="#orga1fb30d">List Accelerators</a></h3>
<div class="outline-text-3" id="text-orga1fb30d">
<div class="org-src-container">
<pre class="src src-sh">aws --region us-west-2 <span style="color: #98be65;">\</span>
    globalaccelerator list-accelerators <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.Accelerators[]'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbd138d9" class="outline-3">
<h3 id="orgbd138d9"><a href="#orgbd138d9">List Listeners</a></h3>
<div class="outline-text-3" id="text-orgbd138d9">
<div class="org-src-container">
<pre class="src src-sh">aws --region us-west-2 <span style="color: #98be65;">\</span>
    globalaccelerator list-listeners <span style="color: #98be65;">\</span>
    --accelerator-arn $<span style="color: #dcaeea;">AcceleratorArn</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org12897ab" class="outline-3">
<h3 id="org12897ab"><a href="#org12897ab">IPs</a></h3>
<div class="outline-text-3" id="text-org12897ab">
<div class="org-src-container">
<pre class="src src-sh">aws --region us-west-2 <span style="color: #98be65;">\</span>
    globalaccelerator list-accelerators <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.Accelerators[].IpSets[].IpAddresses[]'</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org7f0dd30" class="outline-2">
<h2 id="org7f0dd30"><a href="#org7f0dd30">IAM</a></h2>
<div class="outline-text-2" id="text-org7f0dd30">
</div>
<div id="outline-container-org6e078b2" class="outline-3">
<h3 id="org6e078b2"><a href="#org6e078b2">Create Policy</a></h3>
<div class="outline-text-3" id="text-org6e078b2">
<div class="org-src-container">
<pre class="src src-sh">aws iam create-policy <span style="color: #98be65;">\</span>
    --policy-name $<span style="color: #dcaeea;">PolicyName</span> <span style="color: #98be65;">\</span>
    --policy-document <span style="color: #98be65;">'{</span>
<span style="color: #98be65;">  "Version": "2012-10-17",</span>
<span style="color: #98be65;">  "Statement": [{</span>
<span style="color: #98be65;">    "Effect": "Allow",</span>
<span style="color: #98be65;">    "Action": [</span>
<span style="color: #98be65;">      "secretsmanager:GetSecretValue",</span>
<span style="color: #98be65;">      "secretsmanager:DescribeSecret"</span>
<span style="color: #98be65;">    ],</span>
<span style="color: #98be65;">    "Resource": [</span>
<span style="color: #98be65;">      "arn:*:secretsmanager:*:*:secret:MySecret"</span>
<span style="color: #98be65;">    ]</span>
<span style="color: #98be65;">  }]</span>
<span style="color: #98be65;">}'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdefdcf3" class="outline-3">
<h3 id="orgdefdcf3"><a href="#orgdefdcf3">Assume Role</a></h3>
<div class="outline-text-3" id="text-orgdefdcf3">
<div class="org-src-container">
<pre class="src src-sh" id="orgd7788cd">aws sts assume-role <span style="color: #98be65;">\</span>
    --role-session-name foo <span style="color: #98be65;">\</span>
    --role-arn $<span style="color: #dcaeea;">RoleArn</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7ecfb89" class="outline-3">
<h3 id="org7ecfb89"><a href="#org7ecfb89">List Instance Profiles</a></h3>
<div class="outline-text-3" id="text-org7ecfb89">
<div class="org-src-container">
<pre class="src src-sh">aws iam list-instance-profiles <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.InstanceProfiles[].InstanceProfileName'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge751e28" class="outline-3">
<h3 id="orge751e28"><a href="#orge751e28">Delete Instance Profile</a></h3>
<div class="outline-text-3" id="text-orge751e28">
<div class="org-src-container">
<pre class="src src-sh">aws iam delete-instance-profile <span style="color: #98be65;">\</span>
    --instance-profile-name $<span style="color: #dcaeea;">Name</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org5dd2021" class="outline-2">
<h2 id="org5dd2021"><a href="#org5dd2021">IMDS</a></h2>
<div class="outline-text-2" id="text-org5dd2021">
<p>
<a href="http://169.254.169.254/latest/meta-data/">http://169.254.169.254/latest/meta-data/</a>
</p>
</div>
</div>

<div id="outline-container-orgd48228e" class="outline-2">
<h2 id="orgd48228e"><a href="#orgd48228e">Kinesis</a></h2>
<div class="outline-text-2" id="text-orgd48228e">
</div>
<div id="outline-container-org29a60bd" class="outline-3">
<h3 id="org29a60bd"><a href="#org29a60bd">Delete Stream</a></h3>
<div class="outline-text-3" id="text-org29a60bd">
<div class="org-src-container">
<pre class="src src-sh">aws kinesis delete-stream --stream-name $<span style="color: #dcaeea;">stream</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org3913fd2" class="outline-2">
<h2 id="org3913fd2"><a href="#org3913fd2">Kinesis Firehose</a></h2>
<div class="outline-text-2" id="text-org3913fd2">
</div>
<div id="outline-container-org2d6cfe5" class="outline-3">
<h3 id="org2d6cfe5"><a href="#org2d6cfe5">Describe Stream</a></h3>
<div class="outline-text-3" id="text-org2d6cfe5">
<div class="org-src-container">
<pre class="src src-sh">aws firehose describe-delivery-stream <span style="color: #98be65;">\</span>
    --delivery-stream-name $<span style="color: #dcaeea;">StreamName</span> <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.DeliveryStreamDescription'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org8bce3c2" class="outline-3">
<h3 id="org8bce3c2"><a href="#org8bce3c2">Update Stream S3 Destination Bucket</a></h3>
<div class="outline-text-3" id="text-org8bce3c2">
<div class="org-src-container">
<pre class="src src-sh">aws firehose update-destination <span style="color: #98be65;">\</span>
    --delivery-stream-name $<span style="color: #dcaeea;">StreamName</span> <span style="color: #98be65;">\</span>
    --current-delivery-stream-version-id 1 <span style="color: #98be65;">\</span>
    --destination-id destinationId-000000000001 <span style="color: #98be65;">\</span>
    --extended-s3-destination-update <span style="color: #98be65;">\</span>
    <span style="color: #dcaeea;">BucketARN</span>=arn:aws:s3:::$<span style="color: #dcaeea;">BucketName</span>
</pre>
</div>

<p>
THEN:
</p>

<ul class="org-ul">
<li>Update the Stream's IAM policy to allow it to write to the new location</li>
<li>Update the S3 Bucket Policy to allow the Stream's IAM Role to write to it</li>
</ul>
</div>
</div>

<div id="outline-container-org65e428f" class="outline-3">
<h3 id="org65e428f"><a href="#org65e428f">Update Stream S3 Destination Prefix</a></h3>
<div class="outline-text-3" id="text-org65e428f">
<div class="org-src-container">
<pre class="src src-sh">aws firehose update-destination <span style="color: #98be65;">\</span>
    --delivery-stream-name $<span style="color: #dcaeea;">StreamName</span> <span style="color: #98be65;">\</span>
    --current-delivery-stream-version-id 1 <span style="color: #98be65;">\</span>
    --destination-id destinationId-000000000001 <span style="color: #98be65;">\</span>
    --extended-s3-destination-update <span style="color: #dcaeea;">Prefix</span>=$<span style="color: #dcaeea;">Prefix</span>
</pre>
</div>

<p>
Also may need to update the IAM Policy and the S3 Bucket policy, as above.
</p>
</div>
</div>
</div>

<div id="outline-container-org95ccb5f" class="outline-2">
<h2 id="org95ccb5f"><a href="#org95ccb5f">Lambda</a></h2>
<div class="outline-text-2" id="text-org95ccb5f">
</div>
<div id="outline-container-org602ebd8" class="outline-3">
<h3 id="org602ebd8"><a href="#org602ebd8">Invoke function</a></h3>
<div class="outline-text-3" id="text-org602ebd8">
<div class="org-src-container">
<pre class="src src-bash">aws lambda invoke <span style="color: #98be65;">\</span>
    --cli-binary-format raw-in-base64-out <span style="color: #98be65;">\</span>
    --function-name cf-Hello-World <span style="color: #98be65;">\</span>
    /tmp/cats.json
</pre>
</div>

<p>
Invoke from a bastion host:
</p>

<div class="org-src-container">
<pre class="src src-bash">/usr/local/bin/aws lambda invoke <span style="color: #98be65;">\</span>
                   --cli-binary-format raw-in-base64-out <span style="color: #98be65;">\</span>
                   --function-name cf-Hello-World <span style="color: #98be65;">\</span>
                   /tmp/cats.json
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">cat /tmp/out.json | jq -r <span style="color: #98be65;">'.body'</span> | jq
</pre>
</div>

<p>
With payload file:
</p>

<div class="org-src-container">
<pre class="src src-bash">aws lambda invoke <span style="color: #98be65;">\</span>
    --cli-binary-format raw-in-base64-out <span style="color: #98be65;">\</span>
    --function-name hello-world <span style="color: #98be65;">\</span>
    --payload file://tests/resources/event_alb.json <span style="color: #98be65;">\</span>
    /tmp/out.json
</pre>
</div>
</div>
</div>

<div id="outline-container-org44f7e3e" class="outline-3">
<h3 id="org44f7e3e"><a href="#org44f7e3e">Create Function with Zip File</a></h3>
<div class="outline-text-3" id="text-org44f7e3e">
<div class="org-src-container">
<pre class="src src-sh">aws lambda create-function <span style="color: #98be65;">\</span>
    --function-name artifacttool <span style="color: #98be65;">\</span>
    --runtime python2.7 <span style="color: #98be65;">\</span>
    --role $<span style="color: #dcaeea;">RoleArn</span> <span style="color: #98be65;">\</span>
    --handler lambda_function.lambda_handler <span style="color: #98be65;">\</span>
    --zip-file fileb://$<span style="color: #dcaeea;">ZipFileName</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org857242a" class="outline-3">
<h3 id="org857242a"><a href="#org857242a">Update Function code with Zip File</a></h3>
<div class="outline-text-3" id="text-org857242a">
<div class="org-src-container">
<pre class="src src-sh">aws lambda update-function-code <span style="color: #98be65;">\</span>
    --function-name artifacttool <span style="color: #98be65;">\</span>
    --zip-file fileb://$<span style="color: #dcaeea;">ZipFileName</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5121dcc" class="outline-3">
<h3 id="org5121dcc"><a href="#org5121dcc">Container Image: Run Interactively</a></h3>
<div class="outline-text-3" id="text-org5121dcc">
<div class="org-src-container">
<pre class="src src-sh">docker run -it --rm <span style="color: #98be65;">\</span>
       --entrypoint bash <span style="color: #98be65;">\</span>
       public.ecr.aws/lambda/python:3.8
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgdeb7bd1" class="outline-2">
<h2 id="orgdeb7bd1"><a href="#orgdeb7bd1">Organizations</a></h2>
<div class="outline-text-2" id="text-orgdeb7bd1">
<div class="org-src-container">
<pre class="src src-sh" id="org2fe6396">aws organizations list-roots <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.Roots[].Id'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org9b7dd05" class="outline-2">
<h2 id="org9b7dd05"><a href="#org9b7dd05">Polly</a></h2>
<div class="outline-text-2" id="text-org9b7dd05">
<div class="org-src-container">
<pre class="src src-sh">aws polly synthesize-speech <span style="color: #98be65;">\</span>
    --engine standard <span style="color: #98be65;">\</span>
    --output-format mp3 <span style="color: #98be65;">\</span>
    --voice-id Amy <span style="color: #98be65;">\</span>
    --text <span style="color: #98be65;">"All these cats wear hats."</span> <span style="color: #98be65;">\</span>
    /tmp/speech_standard.mp3 <span style="color: #98be65;">\</span>
    &amp;&amp; afplay /tmp/speech_standard.mp3
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc6df4eb" class="outline-2">
<h2 id="orgc6df4eb"><a href="#orgc6df4eb">Reosurce Access Manager (RAM)</a></h2>
<div class="outline-text-2" id="text-orgc6df4eb">
<p>
This needs to be run against the AWS account that actually owns the shared
resources. E.g. in a LandingZone environment, probably the shared-services
account.
</p>

<div class="org-src-container">
<pre class="src src-sh">aws ram list-resources --resource-owner SELF
</pre>
</div>
</div>
</div>

<div id="outline-container-org4f8f023" class="outline-2">
<h2 id="org4f8f023"><a href="#org4f8f023">Route53</a></h2>
<div class="outline-text-2" id="text-org4f8f023">
</div>
<div id="outline-container-org54ae2ac" class="outline-3">
<h3 id="org54ae2ac"><a href="#org54ae2ac">Get HostedZoneId from Name</a></h3>
<div class="outline-text-3" id="text-org54ae2ac">
<p>
AWS credentials have to be set for the account that actually has this
HostedZone.
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org874ca33">aws route53 list-hosted-zones <span style="color: #98be65;">\</span>
    | jq -r --arg name $<span style="color: #dcaeea;">hostedZoneName</span> <span style="color: #98be65;">\</span>
         <span style="color: #98be65;">'.HostedZones[]</span>
<span style="color: #98be65;">          | select(.Name == $name + ".")</span>
<span style="color: #98be65;">          | .Id'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org53ca653" class="outline-3">
<h3 id="org53ca653"><a href="#org53ca653">List Records for a HostedZone</a></h3>
<div class="outline-text-3" id="text-org53ca653">
<div class="org-src-container">
<pre class="src src-sh">aws route53 list-resource-record-sets <span style="color: #98be65;">\</span>
    --hosted-zone-id $<span style="color: #dcaeea;">hostedZoneId</span> <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.ResourceRecordSets[]'</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org210ccd5" class="outline-2">
<h2 id="org210ccd5"><a href="#org210ccd5">SecretsManager</a></h2>
<div class="outline-text-2" id="text-org210ccd5">
</div>
<div id="outline-container-org9dd3401" class="outline-3">
<h3 id="org9dd3401"><a href="#org9dd3401">List Secrets</a></h3>
<div class="outline-text-3" id="text-org9dd3401">
<div class="org-src-container">
<pre class="src src-sh">aws secretsmanager list-secrets
</pre>
</div>
</div>
</div>

<div id="outline-container-org261dfd6" class="outline-3">
<h3 id="org261dfd6"><a href="#org261dfd6">Get Secret</a></h3>
<div class="outline-text-3" id="text-org261dfd6">
<div class="org-src-container">
<pre class="src src-sh">aws secretsmanager get-secret-value <span style="color: #98be65;">\</span>
    --secret-id $<span style="color: #dcaeea;">SecretName</span> <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.SecretString'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5082bcf" class="outline-3">
<h3 id="org5082bcf"><a href="#org5082bcf">Create Secret</a></h3>
<div class="outline-text-3" id="text-org5082bcf">
<div class="org-src-container">
<pre class="src src-sh">aws secretsmanager create-secret <span style="color: #98be65;">\</span>
    --name $<span style="color: #dcaeea;">SecretName</span> <span style="color: #98be65;">\</span>
    --secret-string $<span style="color: #dcaeea;">SecretValue</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd7bd8b6" class="outline-2">
<h2 id="orgd7bd8b6"><a href="#orgd7bd8b6">ServiceCatalog</a></h2>
<div class="outline-text-2" id="text-orgd7bd8b6">
</div>
<div id="outline-container-orga2e3988" class="outline-3">
<h3 id="orga2e3988"><a href="#orga2e3988">Get Product IDs</a></h3>
<div class="outline-text-3" id="text-orga2e3988">
<div class="org-src-container">
<pre class="src src-sh">aws --profile main servicecatalog search-products-as-admin
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf0b2fc4" class="outline-3">
<h3 id="orgf0b2fc4"><a href="#orgf0b2fc4">Launch Product</a></h3>
<div class="outline-text-3" id="text-orgf0b2fc4">
<p>
Note that user, even Admin user, must be added to the Portfolio users/groups.
You can do this with <code>aws servicecatalog associate-principal-with-portfolio</code>
</p>
</div>
</div>
</div>

<div id="outline-container-orgdddbaf3" class="outline-2">
<h2 id="orgdddbaf3"><a href="#orgdddbaf3">Service Quotas</a></h2>
<div class="outline-text-2" id="text-orgdddbaf3">
</div>
<div id="outline-container-org1cecf31" class="outline-3">
<h3 id="org1cecf31"><a href="#org1cecf31">Get Quota</a></h3>
<div class="outline-text-3" id="text-org1cecf31">
<div class="org-src-container">
<pre class="src src-sh">aws service-quotas list-service-quotas <span style="color: #98be65;">\</span>
    --service-code firehose <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.Quotas[] | {QuotaName, Value}'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org51dca83" class="outline-3">
<h3 id="org51dca83"><a href="#org51dca83">Get Default Quota</a></h3>
<div class="outline-text-3" id="text-org51dca83">
<div class="org-src-container">
<pre class="src src-sh">aws service-quotas get-aws-default-service-quota <span style="color: #98be65;">\</span>
    --service-code firehose <span style="color: #98be65;">\</span>
    --quota-code $<span style="color: #dcaeea;">QuotaCode</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd3edbcc" class="outline-2">
<h2 id="orgd3edbcc"><a href="#orgd3edbcc">S3</a></h2>
<div class="outline-text-2" id="text-orgd3edbcc">
</div>
<div id="outline-container-org89bd061" class="outline-3">
<h3 id="org89bd061"><a href="#org89bd061">Canonical ID</a></h3>
<div class="outline-text-3" id="text-org89bd061">
<div class="org-src-container">
<pre class="src src-sh">aws s3api get-bucket-acl --bucket $<span style="color: #dcaeea;">BucketName</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org82dd913" class="outline-3">
<h3 id="org82dd913"><a href="#org82dd913">Create Bucket</a></h3>
<div class="outline-text-3" id="text-org82dd913">
<div class="org-src-container">
<pre class="src src-sh">aws s3api create-bucket <span style="color: #98be65;">\</span>
    --bucket $<span style="color: #dcaeea;">BUCKET_NAME</span> <span style="color: #98be65;">\</span>
    --create-bucket-configuration <span style="color: #dcaeea;">LocationConstraint</span>=$<span style="color: #dcaeea;">AWS_DEFAULT_REGION</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org291922e" class="outline-3">
<h3 id="org291922e"><a href="#org291922e">List Objects</a></h3>
<div class="outline-text-3" id="text-org291922e">
<p>
All objects
</p>

<div class="org-src-container">
<pre class="src src-sh">aws s3api list-objects-v2 <span style="color: #98be65;">\</span>
    --bucket $<span style="color: #dcaeea;">BucketName</span> <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.Contents[]'</span>
</pre>
</div>

<p>
10 most recent objects. AWS has no way of doing this filtering server-side,
so you need to request all objects and then sort them.
</p>

<div class="org-src-container">
<pre class="src src-sh">aws s3api list-objects-v2 <span style="color: #98be65;">\</span>
    --bucket $<span style="color: #dcaeea;">BucketName</span> <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.Contents</span>
<span style="color: #98be65;">             | sort_by(.LastModified)</span>
<span style="color: #98be65;">             | reverse | first | .Key'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5109ba4" class="outline-3">
<h3 id="org5109ba4"><a href="#org5109ba4">Get Object</a></h3>
<div class="outline-text-3" id="text-org5109ba4">
<div class="org-src-container">
<pre class="src src-sh">aws s3api get-object <span style="color: #98be65;">\</span>
    --bucket $<span style="color: #dcaeea;">BucketName</span> <span style="color: #98be65;">\</span>
    --key $<span style="color: #dcaeea;">Key</span> ./foo
</pre>
</div>
</div>
</div>

<div id="outline-container-orge29acab" class="outline-3">
<h3 id="orge29acab"><a href="#orge29acab">Get Bucket Policy</a></h3>
<div class="outline-text-3" id="text-orge29acab">
<div class="org-src-container">
<pre class="src src-sh">aws s3api get-bucket-policy --bucket $<span style="color: #dcaeea;">BucketName</span> <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.Policy'</span> | jq
</pre>
</div>
</div>
</div>

<div id="outline-container-org2794a96" class="outline-3">
<h3 id="org2794a96"><a href="#org2794a96">Delete Buckets</a></h3>
<div class="outline-text-3" id="text-org2794a96">
<p>
I have functions for this in <a href="https://github.com/cfclrk/dotfiles/blob/master/dotfiles/.functions.fish">dotfiles/.functions.fish</a>.
</p>
</div>
</div>
</div>

<div id="outline-container-org30ded50" class="outline-2">
<h2 id="org30ded50"><a href="#org30ded50">SNS</a></h2>
<div class="outline-text-2" id="text-org30ded50">
</div>
<div id="outline-container-org81186a6" class="outline-3">
<h3 id="org81186a6"><a href="#org81186a6">SNS topics</a></h3>
<div class="outline-text-3" id="text-org81186a6">
<div class="org-src-container">
<pre class="src src-sh">aws sns list-topics <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.Topics[] | .TopicArn'</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orge5f17af" class="outline-2">
<h2 id="orge5f17af"><a href="#orge5f17af">SQS</a></h2>
<div class="outline-text-2" id="text-orge5f17af">
</div>
<div id="outline-container-org5aa0029" class="outline-3">
<h3 id="org5aa0029"><a href="#org5aa0029">List Queues</a></h3>
<div class="outline-text-3" id="text-org5aa0029">
<div class="org-src-container">
<pre class="src src-sh">aws sqs list-queues <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.QueueUrls[]'</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org611c47a" class="outline-2">
<h2 id="org611c47a"><a href="#org611c47a">SSM</a></h2>
<div class="outline-text-2" id="text-org611c47a">
<div class="org-src-container">
<pre class="src src-sh">aws ssm get-parameter <span style="color: #98be65;">\</span>
    --with-decryption <span style="color: #98be65;">\</span>
    --name $<span style="color: #dcaeea;">name</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc6df39a" class="outline-2">
<h2 id="orgc6df39a"><a href="#orgc6df39a">SSO</a></h2>
<div class="outline-text-2" id="text-orgc6df39a">
</div>
<div id="outline-container-org5599b19" class="outline-3">
<h3 id="org5599b19"><a href="#org5599b19">Token</a></h3>
<div class="outline-text-3" id="text-org5599b19">
<p>
TODO: Need to run aws sso login. Requires block in <code>~/.aws/config</code> I think.
</p>

<p>
TODO: Look up token file programatically
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org81487a4">cat $<span style="color: #dcaeea;">tokenFile</span> | jq -r <span style="color: #98be65;">'.accessToken'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org8f92a28" class="outline-3">
<h3 id="org8f92a28"><a href="#org8f92a28">List Accounts I Can Access</a></h3>
<div class="outline-text-3" id="text-org8f92a28">
<p>
TODO: SsoToken has a trailing newline!
</p>

<div class="org-src-container">
<pre class="src src-sh">aws sso list-accounts <span style="color: #98be65;">\</span>
    --access-token $<span style="color: #dcaeea;">SsoToken</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">aws sso list-account-roles <span style="color: #98be65;">\</span>
    --access-token <span style="color: #98be65;">"$SsoToken"</span> <span style="color: #98be65;">\</span>
    --account-id $<span style="color: #dcaeea;">Account</span>
</pre>
</div>
</div>
</div>
</div>
</div>
</body>
</html>
