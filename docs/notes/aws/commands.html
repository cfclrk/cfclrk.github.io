<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AWS Commands</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/static/main.css" />
</head>
<body>
<div id="preamble" class="status">
<nav id="navbar" class="cf">
  <ul class="cf">
    <li class="fl">
      <a href="/">cfclrk</a>
    </li>
    <li class="fr">
      <a href="/articles/home.html">Articles</a>
    </li>
    <li class="fr">
      <a href="/notes/home.html">Notes</a>
    </li>
	<li class="fr">
      <a href="/cloudformation/home.html">CloudFormation</a>
    </li>
  </ul>
</nav>
</div>
<div id="content" class="content">
<header>
<h1 class="title">AWS Commands</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org6b7e2b4">Account</a></li>
<li><a href="#org1f7c126">IP Address Ranges</a>
<ul>
<li><a href="#org71c9ae4">Get Region of IP</a></li>
</ul>
</li>
<li><a href="#orga2c80b6">Regions</a>
<ul>
<li><a href="#org263c5a8">All Regions in Partition</a></li>
<li><a href="#orgb1443f7">All Regions in All Partitions</a></li>
<li><a href="#org917554d">Run a Command in All Regions</a>
<ul>
<li><a href="#org35f50d8">Linear</a></li>
<li><a href="#org10954f5">Parallel</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org015ee64">ACM</a>
<ul>
<li><a href="#org7520f42">List</a></li>
<li><a href="#org73c75c9">Describe</a></li>
<li><a href="#orgc9c4ac1">Get Certificate</a></li>
<li><a href="#orgeab0333">Get Certificate PEM File</a></li>
</ul>
</li>
<li><a href="#orgc0dd0e1">API Gateway V2</a>
<ul>
<li><a href="#org533fd28">List APIs</a></li>
</ul>
</li>
<li><a href="#org01b27bf">CloudFormation</a>
<ul>
<li><a href="#org0f3b956">View Stack Log</a></li>
<li><a href="#org1e70677">List Stacks</a></li>
<li><a href="#org8d668ce">Stack Outputs</a></li>
<li><a href="#org05b8482">Get Stack Parameters</a></li>
<li><a href="#orgc5aaa62">Exports</a></li>
<li><a href="#org464bf6a">Spec Files</a></li>
</ul>
</li>
<li><a href="#org099dc4f">CloudWatch</a>
<ul>
<li><a href="#org798084f">Delete All Alarms</a></li>
<li><a href="#orgdab1a9f">Create Alarm Targeting ASG policy</a></li>
</ul>
</li>
<li><a href="#orgac55fec">CodeDeploy</a>
<ul>
<li><a href="#org10d58a9">list-deployments</a></li>
</ul>
</li>
<li><a href="#orgd109f23">DynamoDB</a>
<ul>
<li><a href="#orgcd484b0">List Tables</a></li>
<li><a href="#orgf86641d">Delete Tables Like a Maniac</a></li>
</ul>
</li>
<li><a href="#org4428828">EC2 AMIs</a>
<ul>
<li><a href="#org2b53905">List AMIs</a></li>
<li><a href="#orgc7ef82e">Get Latest Image</a></li>
<li><a href="#orgc9b362b">Delete AMIs and EBS Snapshots</a></li>
<li><a href="#org69e431f">List Accounts That Can Access AMI</a></li>
</ul>
</li>
<li><a href="#org004791f">EC2 AZs</a>
<ul>
<li><a href="#orgd972451">The Actual AZ</a></li>
</ul>
</li>
<li><a href="#orge786173">EC2 KeyPairs</a>
<ul>
<li><a href="#org86b1c6a">Create</a></li>
<li><a href="#org7584c80">Describe</a></li>
<li><a href="#org82dbef7">Delete</a></li>
</ul>
</li>
<li><a href="#org802dfa8">EC2 Instances</a>
<ul>
<li><a href="#org7cca485">Get Running Instances</a></li>
<li><a href="#orgba14233">Get All Instance Tags</a></li>
<li><a href="#org3fcddfb">Get Instances with Tag Key</a></li>
<li><a href="#org880fa44">Get Instances with Tag Key/Value</a></li>
</ul>
</li>
<li><a href="#orgeb57041">EC2 Transit Gateway</a>
<ul>
<li><a href="#orgdaf548c">List Routes in a TG Route Table</a></li>
</ul>
</li>
<li><a href="#orge5506b4">EC2 VPCs</a>
<ul>
<li><a href="#org85e3a67">VPCs</a></li>
<li><a href="#org2bbb314">Subnets</a></li>
<li><a href="#org094bba0">SecurityGroups</a></li>
<li><a href="#org4bfe151">Private ALB IPs</a></li>
<li><a href="#org6b60942">Managed Prefix Lists</a></li>
</ul>
</li>
<li><a href="#orgb09cc04">EC2 Volumes</a>
<ul>
<li><a href="#org809994b">List Volumes</a></li>
<li><a href="#orgd0a9318">List Unattached Volumes</a></li>
<li><a href="#orge29a71c">Delete Volumes</a></li>
</ul>
</li>
<li><a href="#orgbb03ebe">ECR</a>
<ul>
<li><a href="#orgd6f2beb">Log in</a></li>
<li><a href="#org5b407f7">Create Repository</a></li>
<li><a href="#org1122884">Add Image</a></li>
</ul>
</li>
<li><a href="#org8d3d512">ECS</a></li>
<li><a href="#org7c0a659">EKS</a>
<ul>
<li><a href="#org902ce68">List Clusters</a></li>
<li><a href="#org07ccf37">Get Kube Config</a></li>
</ul>
</li>
<li><a href="#orga2776ff">Elasticache</a>
<ul>
<li><a href="#org0f79de6">List CacheClusters</a></li>
<li><a href="#org178032d">List ReplicationGroups</a></li>
</ul>
</li>
<li><a href="#orgf2eab5b">ElasticBeanstalk</a>
<ul>
<li><a href="#org3545be4">Config Options for Nampespace</a></li>
</ul>
</li>
<li><a href="#org4f6c1e4">ElasticLoadBalancingV2</a>
<ul>
<li><a href="#orgfe93821">Describe ALBs</a></li>
<li><a href="#org8c78c4c">Get DNS Name</a></li>
</ul>
</li>
<li><a href="#org15cef0e">GlobalAccelerator</a>
<ul>
<li><a href="#orgdcbeffd">List Accelerators</a></li>
<li><a href="#org5318dce">List Listeners</a></li>
<li><a href="#orgf87b5c0">IPs</a></li>
</ul>
</li>
<li><a href="#orgce07388">IAM</a>
<ul>
<li><a href="#org92d8b3d">Create Policy</a></li>
<li><a href="#org29b87dc">Describe Policy</a></li>
<li><a href="#org44188e0">Assume Role</a></li>
<li><a href="#org2ec8d74">List Instance Profiles</a></li>
<li><a href="#org17db863">Delete Instance Profile</a></li>
</ul>
</li>
<li><a href="#orge90e732">IMDS</a></li>
<li><a href="#org524a14d">Kinesis</a>
<ul>
<li><a href="#orgfb070f7">Delete Stream</a></li>
</ul>
</li>
<li><a href="#org447341c">Kinesis Firehose</a>
<ul>
<li><a href="#org538cae4">Describe Stream</a></li>
<li><a href="#org1c25db3">Update Stream S3 Destination Bucket</a></li>
<li><a href="#org9a05898">Update Stream S3 Destination Prefix</a></li>
</ul>
</li>
<li><a href="#org58ab81e">Lambda</a>
<ul>
<li><a href="#org6a93227">Invoke function</a></li>
<li><a href="#org37e6f45">Create Function with Zip File</a></li>
<li><a href="#org1da8806">Update Function code with Zip File</a></li>
<li><a href="#org61177cb">Container Image: Run Interactively</a></li>
</ul>
</li>
<li><a href="#orgdcc0535">Organizations</a></li>
<li><a href="#org77afbd8">Polly</a></li>
<li><a href="#org4f417a6">Reosurce Access Manager (RAM)</a></li>
<li><a href="#orged392ac">RDS</a>
<ul>
<li><a href="#org7f886c4">describe-db-instances</a></li>
<li><a href="#org8f4c0c1">describe-db-engine-versions</a></li>
<li><a href="#org9affadf">pending maintenance actions for a DB</a></li>
</ul>
</li>
<li><a href="#orga7f2e6b">Route53</a>
<ul>
<li><a href="#org9955e19">Get HostedZoneId from domain name</a></li>
<li><a href="#orgd48bc48">List Records for a HostedZone</a></li>
</ul>
</li>
<li><a href="#org3882600">SecretsManager</a>
<ul>
<li><a href="#org1d541b3">List Secrets</a></li>
<li><a href="#org0b68467">Get Secret</a></li>
<li><a href="#org795edde">Create Secret</a></li>
</ul>
</li>
<li><a href="#org5f3f64c">ServiceCatalog</a>
<ul>
<li><a href="#orgca6e0d5">Get Product IDs</a></li>
<li><a href="#orgad610cf">Launch Product</a></li>
</ul>
</li>
<li><a href="#orgd46de62">Service Quotas</a>
<ul>
<li><a href="#orga77bd22">Get Quota</a></li>
<li><a href="#org158f895">Get Default Quota</a></li>
</ul>
</li>
<li><a href="#org8cb6e83">S3</a>
<ul>
<li><a href="#orgd915749">Canonical ID</a></li>
<li><a href="#orgb569f97">Create Bucket</a></li>
<li><a href="#org3598548">List Objects</a></li>
<li><a href="#org6660dfd">Get object</a></li>
<li><a href="#org1fddda1">Get multiple objects</a></li>
<li><a href="#org5dacec5">Get Bucket Policy</a></li>
<li><a href="#org81dc8d9">Delete Buckets</a></li>
</ul>
</li>
<li><a href="#org154e02e">SNS</a>
<ul>
<li><a href="#org12b98d1">SNS topics</a></li>
</ul>
</li>
<li><a href="#org09ca393">SQS</a>
<ul>
<li><a href="#orgf6f0ddd">List Queues</a></li>
<li><a href="#orgd684c4d">Read Message</a></li>
<li><a href="#org21bfe09">Send Message</a></li>
</ul>
</li>
<li><a href="#orgf97ac30">SSM</a></li>
<li><a href="#orgeea0d28">SSO</a>
<ul>
<li><a href="#org88165e1">Register Client</a></li>
<li><a href="#orgf5857a2">Token</a></li>
<li><a href="#orge8f9e05">List Accounts I Can Access</a></li>
</ul>
</li>
</ul>
</div>
</nav>

<div id="outline-container-org6b7e2b4" class="outline-2">
<h2 id="org6b7e2b4"><a href="#org6b7e2b4">Account</a></h2>
<div class="outline-text-2" id="text-org6b7e2b4">
<p>
Account number:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org15d6f3c">aws sts get-caller-identity <span style="color: #98be65;">\</span>
    --query <span style="color: #98be65;">'Account'</span> <span style="color: #98be65;">\</span>
    --output text
</pre>
</div>
</div>
</div>

<div id="outline-container-org1f7c126" class="outline-2">
<h2 id="org1f7c126"><a href="#org1f7c126">IP Address Ranges</a></h2>
<div class="outline-text-2" id="text-org1f7c126">
<p>
AWS documentation is <a href="https://docs.aws.amazon.com/general/latest/gr/aws-ip-ranges.html">here</a>.
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org2f6562d">curl -s https://ip-ranges.amazonaws.com/ip-ranges.json
</pre>
</div>

<p>
<a href="ip_ranges.json">ip_ranges.json</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">cat <span style="color: #98be65;">"$IpRanges"</span> <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.prefixes[]</span>
<span style="color: #98be65;">          | select(.region = "us-east-2")</span>
<span style="color: #98be65;">          | .ip_prefix'</span>
</pre>
</div>
</div>

<div id="outline-container-org71c9ae4" class="outline-3">
<h3 id="org71c9ae4"><a href="#org71c9ae4">Get Region of IP</a></h3>
<div class="outline-text-3" id="text-org71c9ae4">
<p>
(Would be cool).
</p>

<p>
Check IP address against each CIDR range. Would be cool to do this using bit
comparisons.
</p>

<p>
See: <a href="https://unix.stackexchange.com/questions/274330/check-ip-is-in-range-of-whitelist-array">https://unix.stackexchange.com/questions/274330/check-ip-is-in-range-of-whitelist-array</a>
</p>
</div>
</div>
</div>

<div id="outline-container-orga2c80b6" class="outline-2">
<h2 id="orga2c80b6"><a href="#orga2c80b6">Regions</a></h2>
<div class="outline-text-2" id="text-orga2c80b6">
</div>
<div id="outline-container-org263c5a8" class="outline-3">
<h3 id="org263c5a8"><a href="#org263c5a8">All Regions in Partition</a></h3>
<div class="outline-text-3" id="text-org263c5a8">
<div class="org-src-container">
<pre class="src src-sh" id="orge689a99">aws ec2 describe-regions <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">".Regions[].RegionName"</span>
</pre>
</div>

<div class="results">#+RESULTS:</div><pre class="example">
eu-north-1
ap-south-1
eu-west-3
eu-west-2
eu-west-1
ap-northeast-3
ap-northeast-2
ap-northeast-1
sa-east-1
ca-central-1
ap-southeast-1
ap-southeast-2
eu-central-1
us-east-1
us-east-2
us-west-1
us-west-2
</pre>


<p>
Number of regions:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #c678dd;">echo</span> $<span style="color: #dcaeea;">AllRegions</span> | wc -w   <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Using wc</span>

<span style="color: #dcaeea;">regions</span>=($<span style="color: #dcaeea;">AllRegions</span>)      <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Or use an array, and</span>
<span style="color: #c678dd;">echo</span> ${#<span style="color: #dcaeea;">regions</span>[*]}        <span style="color: #5B6268;"># </span><span style="color: #5B6268;">print array length</span>
</pre>
</div>

<div class="results">#+RESULTS:</div><pre class="example">
21
21
</pre>
</div>
</div>

<div id="outline-container-orgb1443f7" class="outline-3">
<h3 id="orgb1443f7"><a href="#orgb1443f7">All Regions in All Partitions</a></h3>
<div class="outline-text-3" id="text-orgb1443f7">
<p>
Should be in the botocore data files. Also, we can pull them from the IpRanges
document. You have to decide whether "GLOBAL" is a "region" in your situation.
</p>

<div class="org-src-container">
<pre class="src src-sh">cat <span style="color: #98be65;">"$IpRanges"</span> <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.prefixes[].region'</span> <span style="color: #98be65;">\</span>
    | sort | uniq
</pre>
</div>
</div>
</div>

<div id="outline-container-org917554d" class="outline-3">
<h3 id="org917554d"><a href="#org917554d">Run a Command in All Regions</a></h3>
<div class="outline-text-3" id="text-org917554d">
</div>
<div id="outline-container-org35f50d8" class="outline-4">
<h4 id="org35f50d8"><a href="#org35f50d8">Linear</a></h4>
<div class="outline-text-4" id="text-org35f50d8">
<p>
Get the number of VPCs in each region the slow and simple way.
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #51afef;">for</span> region<span style="color: #51afef;"> in</span> $<span style="color: #dcaeea;">regions</span>; <span style="color: #51afef;">do</span>
    <span style="color: #dcaeea;">vpcs</span>=($(aws --region $<span style="color: #dcaeea;">region</span> ec2 describe-vpcs | jq <span style="color: #98be65;">'.Vpcs[].VpcId'</span>))
    <span style="color: #c678dd;">echo</span> <span style="color: #98be65;">"$region: ${#vpcs[*]}"</span>
<span style="color: #51afef;">done</span>
</pre>
</div>

<div class="results">#+RESULTS:</div><pre class="example">
eu-north-1: 0
ap-south-1: 0
eu-west-3: 0
eu-west-2: 0
eu-west-1: 0
ap-northeast-3: 1
ap-northeast-2: 0
ap-northeast-1: 0
sa-east-1: 0
ca-central-1: 0
ap-southeast-1: 1
ap-southeast-2: 0
eu-central-1: 0
us-east-1: 2
us-east-2: 3
us-west-1: 0
us-west-2: 0
</pre>
</div>
</div>

<div id="outline-container-org10954f5" class="outline-4">
<h4 id="org10954f5"><a href="#org10954f5">Parallel</a></h4>
<div class="outline-text-4" id="text-org10954f5">
<p>
Get the number of VPCs in each region the ðŸš€ and ðŸ˜Ž (and ðŸ¤®) way by starting
a subprocess for each region in parallel. Note that <code>${#regions[@]}</code> is bash
syntax for the length of the <code>$regions</code> array.
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #dcaeea;">script</span>=$(cat &lt;&lt;-<span style="color: #98be65;">"EOF"</span>
<span style="color: #98be65;">vpcs=($(aws --region {} ec2 describe-vpcs | jq '.Vpcs[].VpcId'))</span>
<span style="color: #98be65;">echo "{}: ${#vpcs[@]}"</span>
<span style="color: #98be65;">EOF</span>
)

<span style="color: #dcaeea;">regions</span>=($<span style="color: #dcaeea;">regions</span>)
printf <span style="color: #98be65;">"%s\n"</span> <span style="color: #98be65;">"${regions[@]}"</span> <span style="color: #98be65;">\</span>
    | xargs -n 1 <span style="color: #98be65;">\</span>
            -P ${#<span style="color: #dcaeea;">regions</span>[*]} <span style="color: #98be65;">\</span>
            -I {} <span style="color: #98be65;">\</span>
            bash -c <span style="color: #98be65;">"$script"</span>
</pre>
</div>

<div class="results">#+RESULTS:</div><pre class="example">
us-east-2: 8
ca-central-1: 2
eu-south-1: 1
eu-west-3: 1
us-west-2: 3
us-east-1: 97
eu-central-1: 1
us-west-1: 4
eu-north-1: 2
eu-west-2: 3
eu-west-1: 1
sa-east-1: 1
ap-northeast-2: 1
ap-northeast-1: 2
ap-south-1: 1
me-south-1: 1
ap-east-1: 1
ap-northeast-3: 1
af-south-1: 1
ap-southeast-1: 1
ap-southeast-2: 1
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org015ee64" class="outline-2">
<h2 id="org015ee64"><a href="#org015ee64">ACM</a></h2>
<div class="outline-text-2" id="text-org015ee64">
</div>
<div id="outline-container-org7520f42" class="outline-3">
<h3 id="org7520f42"><a href="#org7520f42">List</a></h3>
<div class="outline-text-3" id="text-org7520f42">
<div class="org-src-container">
<pre class="src src-sh">aws acm list-certificates <span style="color: #98be65;">\</span>
    --includes <span style="color: #98be65;">"keyUsage=ANY"</span> <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.CertificateSummaryList[]'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org73c75c9" class="outline-3">
<h3 id="org73c75c9"><a href="#org73c75c9">Describe</a></h3>
<div class="outline-text-3" id="text-org73c75c9">
<div class="org-src-container">
<pre class="src src-sh">aws acm describe-certificate <span style="color: #98be65;">\</span>
    --certificate-arn $<span style="color: #dcaeea;">CertArn</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc9c4ac1" class="outline-3">
<h3 id="orgc9c4ac1"><a href="#orgc9c4ac1">Get Certificate</a></h3>
<div class="outline-text-3" id="text-orgc9c4ac1">
<div class="org-src-container">
<pre class="src src-sh">aws acm get-certificate <span style="color: #98be65;">\</span>
    --certificate-arn $<span style="color: #dcaeea;">CertificateArn</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgeab0333" class="outline-3">
<h3 id="orgeab0333"><a href="#orgeab0333">Get Certificate PEM File</a></h3>
<div class="outline-text-3" id="text-orgeab0333">
<div class="org-src-container">
<pre class="src src-sh">aws acm get-certificate <span style="color: #98be65;">\</span>
    --certificate-arn $<span style="color: #dcaeea;">CertificateArn</span> <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.Certificate'</span> &gt; route_guide_cert.pem
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">cat appliance_cert.pem
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgc0dd0e1" class="outline-2">
<h2 id="orgc0dd0e1"><a href="#orgc0dd0e1">API Gateway V2</a></h2>
<div class="outline-text-2" id="text-orgc0dd0e1">
</div>
<div id="outline-container-org533fd28" class="outline-3">
<h3 id="org533fd28"><a href="#org533fd28">List APIs</a></h3>
<div class="outline-text-3" id="text-org533fd28">
<div class="org-src-container">
<pre class="src src-sh">aws apigatewayv2 get-apis <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.Items[]'</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org01b27bf" class="outline-2">
<h2 id="org01b27bf"><a href="#org01b27bf">CloudFormation</a></h2>
<div class="outline-text-2" id="text-org01b27bf">
<p>
For create/deploy/update, see my <a href="https://github.com/cfclrk/cloudformation/blob/main/README.org">cloudformation/README.org</a>.
</p>
</div>

<div id="outline-container-org0f3b956" class="outline-3">
<h3 id="org0f3b956"><a href="#org0f3b956">View Stack Log</a></h3>
<div class="outline-text-3" id="text-org0f3b956">
<div class="org-src-container">
<pre class="src src-sh">aws cloudformation list-stacks <span style="color: #98be65;">\</span>
    | jq -M <span style="color: #98be65;">'.StackSummaries[0].StackId'</span> <span style="color: #98be65;">\</span>
    | xargs aws cloudformation describe-stack-events --stack-name
</pre>
</div>
</div>
</div>

<div id="outline-container-org1e70677" class="outline-3">
<h3 id="org1e70677"><a href="#org1e70677">List Stacks</a></h3>
<div class="outline-text-3" id="text-org1e70677">
<p>
List only the created stacks
</p>

<div class="org-src-container">
<pre class="src src-sh">aws cloudformation list-stacks <span style="color: #98be65;">\</span>
    --stack-status-filter CREATE_IN_PROGRESS CREATE_COMPLETE
</pre>
</div>
</div>
</div>

<div id="outline-container-org8d668ce" class="outline-3">
<h3 id="org8d668ce"><a href="#org8d668ce">Stack Outputs</a></h3>
<div class="outline-text-3" id="text-org8d668ce">
<div class="org-src-container">
<pre class="src src-sh">aws cloudformation describe-stacks <span style="color: #98be65;">\</span>
    --stack-name $<span style="color: #dcaeea;">StackName</span> <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.Stacks[].Outputs[]'</span>
</pre>
</div>

<p>
Get the value of a single output:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws cloudformation describe-stacks <span style="color: #98be65;">\</span>
    --stack-name $<span style="color: #dcaeea;">StackName</span> <span style="color: #98be65;">\</span>
    --query <span style="color: #98be65;">"Stacks[0].Outputs[?OutputKey=='$OutputKey'].OutputValue"</span> <span style="color: #98be65;">\</span>
    --output text
</pre>
</div>
</div>
</div>

<div id="outline-container-org05b8482" class="outline-3">
<h3 id="org05b8482"><a href="#org05b8482">Get Stack Parameters</a></h3>
<div class="outline-text-3" id="text-org05b8482">
<p>
Get all parameters used to create a particular stack:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws cloudformation describe-stacks <span style="color: #98be65;">\</span>
    --stack-name $<span style="color: #dcaeea;">StackName</span> <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.Stacks[].Parameters[]'</span>
</pre>
</div>

<p>
Get the value of a single parameter:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws cloudformation describe-stacks <span style="color: #98be65;">\</span>
    --stack-name $<span style="color: #dcaeea;">StackName</span> <span style="color: #98be65;">\</span>
    --query <span style="color: #98be65;">"Stacks[0].Parameters[?ParameterKey=='$Parameter'].ParameterValue"</span> <span style="color: #98be65;">\</span>
    --output text
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc5aaa62" class="outline-3">
<h3 id="orgc5aaa62"><a href="#orgc5aaa62">Exports</a></h3>
<div class="outline-text-3" id="text-orgc5aaa62">
<p>
Get value of the exported field with name <code>$ExportName</code>:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws cloudformation list-exports <span style="color: #98be65;">\</span>
    --query <span style="color: #98be65;">"Exports[?Name=='$ExportName'].Value"</span> <span style="color: #98be65;">\</span>
    --output text
</pre>
</div>

<p>
List exports that start with a string:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws cloudformation list-exports <span style="color: #98be65;">\</span>
    --query <span style="color: #98be65;">"Exports[?starts_with(Name, 'foo-')].[Name, Value]"</span> <span style="color: #98be65;">\</span>
    --output text
</pre>
</div>
</div>
</div>

<div id="outline-container-org464bf6a" class="outline-3">
<h3 id="org464bf6a"><a href="#org464bf6a">Spec Files</a></h3>
<div class="outline-text-3" id="text-org464bf6a">
<p>
URLs are documented <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-resource-specification.html">here</a>.
</p>
</div>
</div>
</div>

<div id="outline-container-org099dc4f" class="outline-2">
<h2 id="org099dc4f"><a href="#org099dc4f">CloudWatch</a></h2>
<div class="outline-text-2" id="text-org099dc4f">
</div>
<div id="outline-container-org798084f" class="outline-3">
<h3 id="org798084f"><a href="#org798084f">Delete All Alarms</a></h3>
<div class="outline-text-3" id="text-org798084f">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #dcaeea;">alarms</span>=$(aws cloudwatch describe-alarms <span style="color: #98be65;">\</span>
             | jq -r <span style="color: #98be65;">'.MetricAlarms[].AlarmName'</span>)

<span style="color: #51afef;">for</span> alarm<span style="color: #51afef;"> in</span> $<span style="color: #dcaeea;">alarms</span>; <span style="color: #51afef;">do</span>
    aws cloudwatch delete-alarms <span style="color: #98be65;">\</span>
        --alarm-names $<span style="color: #dcaeea;">alarm</span>;
<span style="color: #51afef;">done</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdab1a9f" class="outline-3">
<h3 id="orgdab1a9f"><a href="#orgdab1a9f">Create Alarm Targeting ASG policy</a></h3>
<div class="outline-text-3" id="text-orgdab1a9f">
<div class="org-src-container">
<pre class="src src-sh">aws cloudwatch put-metric-alarm <span style="color: #98be65;">\</span>
    --alarm-name AddCapacity <span style="color: #98be65;">\</span>
    --metric-name CPUUtilization <span style="color: #98be65;">\</span>
    --namespace AWS/EC2 <span style="color: #98be65;">\</span>
    --statistic Average <span style="color: #98be65;">\</span>
    --period 120 <span style="color: #98be65;">\</span>
    --threshold 80 <span style="color: #98be65;">\</span>
    --comparison-operator GreaterThanOrEqualToThreshold <span style="color: #98be65;">\</span>
    --dimensions <span style="color: #98be65;">"Name=AutoScalingGroupName,Value=my-asg"</span> <span style="color: #98be65;">\</span>
    --evaluation-periods 2 <span style="color: #98be65;">\</span>
    --alarm-actions $<span style="color: #dcaeea;">ScalingPolicyArn</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgac55fec" class="outline-2">
<h2 id="orgac55fec"><a href="#orgac55fec">CodeDeploy</a></h2>
<div class="outline-text-2" id="text-orgac55fec">
</div>
<div id="outline-container-org10d58a9" class="outline-3">
<h3 id="org10d58a9"><a href="#org10d58a9">list-deployments</a></h3>
<div class="outline-text-3" id="text-org10d58a9">
<div class="org-src-container">
<pre class="src src-sh">aws deploy list-deployments --application-name saus
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd109f23" class="outline-2">
<h2 id="orgd109f23"><a href="#orgd109f23">DynamoDB</a></h2>
<div class="outline-text-2" id="text-orgd109f23">
<p>
The paper: <a href="https://www.allthingsdistributed.com/files/amazon-dynamo-sosp2007.pdf">Dynamo: Amazonâ€™s Highly Available Key-value Store</a>. This describes a
distributed database with a leaderless replication model.
</p>

<p>
From <a href="https://shop.aer.io/oreilly/p/designing-data-intensive-applications/9781449373320-9149">Designing Data-Intensive Applications</a> by Martin Kleppmann:
</p>

<blockquote>
<p>
Dynamo is not available to users outside of Amazon. Confusingly, AWS offers a
hosted database product called DynamoDB, which uses a completely different
architecture: it is based on single-leader replication.
</p>
</blockquote>
</div>

<div id="outline-container-orgcd484b0" class="outline-3">
<h3 id="orgcd484b0"><a href="#orgcd484b0">List Tables</a></h3>
<div class="outline-text-3" id="text-orgcd484b0">
<div class="org-src-container">
<pre class="src src-sh">aws dynamodb  list-tables | jq <span style="color: #98be65;">'.TableNames[]'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf86641d" class="outline-3">
<h3 id="orgf86641d"><a href="#orgf86641d">Delete Tables Like a Maniac</a></h3>
<div class="outline-text-3" id="text-orgf86641d">
<p>
AWS allows you to delete have 10 <code>delete-table</code> operations running at a time.
We can create a pool of 10 processes and continuously pump <code>delete-table</code>
commands into it using <code>xargs</code>.
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #dcaeea;">script</span>=$(cat &lt;&lt;<span style="color: #98be65;">"EOF"</span>
<span style="color: #98be65;">aws dynamodb delete-table --table-name {}</span>
<span style="color: #98be65;">aws dynamodb wait table-not-exists --table-name {}</span>
<span style="color: #98be65;">EOF</span>
      )
<span style="color: #c678dd;">echo</span> ${<span style="color: #dcaeea;">tables</span>[*]} <span style="color: #98be65;">\</span>
    | xargs -n 1 -P 10 -I {} sh -c <span style="color: #98be65;">"$scrpt"</span>
</pre>
</div>

<p>
TODO: When I originally wrote this, I remember needing to add a <code>tr " " "\n"</code>
or something for portability with Linux. Test this out again.
</p>

<p>
TODO: script used to be one command (using <code>&amp;&amp;</code>); test again after splitting
it into two commands.
</p>
</div>
</div>
</div>

<div id="outline-container-org4428828" class="outline-2">
<h2 id="org4428828"><a href="#org4428828">EC2 AMIs</a></h2>
<div class="outline-text-2" id="text-org4428828">
</div>
<div id="outline-container-org2b53905" class="outline-3">
<h3 id="org2b53905"><a href="#org2b53905">List AMIs</a></h3>
<div class="outline-text-3" id="text-org2b53905">
<p>
All of this account's AMIs:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-images --owners $<span style="color: #dcaeea;">Account</span>
</pre>
</div>

<p>
All of this account's AMIs with a particular Name tag:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-images <span style="color: #98be65;">\</span>
    --owners $<span style="color: #dcaeea;">account</span> <span style="color: #98be65;">\</span>
    --filters <span style="color: #98be65;">"Name=tag:Name,Values=My AMI"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc7ef82e" class="outline-3">
<h3 id="orgc7ef82e"><a href="#orgc7ef82e">Get Latest Image</a></h3>
<div class="outline-text-3" id="text-orgc7ef82e">
<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-images <span style="color: #98be65;">\</span>
    --owners $<span style="color: #dcaeea;">Account</span> <span style="color: #98be65;">\</span>
    --filters <span style="color: #98be65;">"Name=state,Values=available"</span> <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.Images</span>
<span style="color: #98be65;">             | sort_by(.CreationDate)</span>
<span style="color: #98be65;">             | last | .ImageId'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc9b362b" class="outline-3">
<h3 id="orgc9b362b"><a href="#orgc9b362b">Delete AMIs and EBS Snapshots</a></h3>
<div class="outline-text-3" id="text-orgc9b362b">
<p>
List AMIs to delete and set to variable <code>AmisToDelete</code>. Then:
</p>

<div class="org-src-container">
<pre class="src src-sh">jq -c <span style="color: #98be65;">'.Images</span>
<span style="color: #98be65;">       | sort_by(.CreationDate)</span>
<span style="color: #98be65;">       | .[]</span>
<span style="color: #98be65;">       | {name: .Name, snap: .BlockDeviceMappings[]</span>
<span style="color: #98be65;">       | select(.Ebs != null)</span>
<span style="color: #98be65;">       | .Ebs.SnapshotId}'</span> &lt; $<span style="color: #dcaeea;">AmisToDelete</span> &gt; images.txt
</pre>
</div>

<p>
And then&#x2026; what did I do?
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #51afef;">for</span> i<span style="color: #51afef;"> in</span> (cat images.txt | jq); <span style="color: #51afef;">do</span>
    <span style="color: #5B6268;"># </span><span style="color: #5B6268;">deregister image</span>
    <span style="color: #5B6268;"># </span><span style="color: #5B6268;">delete the snapshot</span>
<span style="color: #51afef;">done</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org69e431f" class="outline-3">
<h3 id="org69e431f"><a href="#org69e431f">List Accounts That Can Access AMI</a></h3>
<div class="outline-text-3" id="text-org69e431f">
<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-image-attribute <span style="color: #98be65;">\</span>
    --image-id $<span style="color: #dcaeea;">ImageID</span> <span style="color: #98be65;">\</span>
    --attribute launchPermission
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org004791f" class="outline-2">
<h2 id="org004791f"><a href="#org004791f">EC2 AZs</a></h2>
<div class="outline-text-2" id="text-org004791f">
<p>
All AZs in all regions:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #51afef;">for</span> region<span style="color: #51afef;"> in</span> $<span style="color: #dcaeea;">AllRegions</span>; <span style="color: #51afef;">do</span>
    <span style="color: #dcaeea;">azs</span>=$(aws --region $<span style="color: #dcaeea;">region</span> <span style="color: #98be65;">\</span>
              ec2 describe-availability-zones <span style="color: #98be65;">\</span>
              | jq -c <span style="color: #98be65;">'[.AvailabilityZones[].ZoneName]'</span>)
    printf <span style="color: #98be65;">"$region: $azs\n"</span>
<span style="color: #51afef;">done</span>
</pre>
</div>

<div class="results">#+RESULTS:</div><pre class="example">
eu-north-1: ["eu-north-1a","eu-north-1b","eu-north-1c"]
ap-south-1: ["ap-south-1a","ap-south-1b","ap-south-1c"]
eu-west-3: ["eu-west-3a","eu-west-3b","eu-west-3c"]
eu-west-2: ["eu-west-2a","eu-west-2b","eu-west-2c"]
eu-west-1: ["eu-west-1a","eu-west-1b","eu-west-1c"]
ap-northeast-3: ["ap-northeast-3a","ap-northeast-3b","ap-northeast-3c"]
ap-northeast-2: ["ap-northeast-2a","ap-northeast-2b","ap-northeast-2c","ap-northeast-2d"]
ap-northeast-1: ["ap-northeast-1a","ap-northeast-1c","ap-northeast-1d"]
sa-east-1: ["sa-east-1a","sa-east-1b","sa-east-1c"]
ca-central-1: ["ca-central-1a","ca-central-1b","ca-central-1d"]
ap-southeast-1: ["ap-southeast-1a","ap-southeast-1b","ap-southeast-1c"]
ap-southeast-2: ["ap-southeast-2a","ap-southeast-2b","ap-southeast-2c"]
eu-central-1: ["eu-central-1a","eu-central-1b","eu-central-1c"]
us-east-1: ["us-east-1a","us-east-1b","us-east-1c","us-east-1d","us-east-1e","us-east-1f"]
us-east-2: ["us-east-2a","us-east-2b","us-east-2c"]
us-west-1: ["us-west-1b","us-west-1c"]
us-west-2: ["us-west-2a","us-west-2b","us-west-2c","us-west-2d"]
</pre>
</div>

<div id="outline-container-orgd972451" class="outline-3">
<h3 id="orgd972451"><a href="#orgd972451">The Actual AZ</a></h3>
<div class="outline-text-3" id="text-orgd972451">
<p>
<code>us-east-1b</code> does not mean the same thing in every AWS account. If everyone
creates infra in <code>us-east-1b</code>, that infra will actually be in several
different AZs, depending on which AZ <code>us-east-1b</code> maps to for each account.
To determine the <i>real</i> AZ, you need to look at the <b>Zone ID</b>.
</p>

<p>
Print the Zone Name and Zone ID for each AZ in a region:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-availability-zones <span style="color: #98be65;">\</span>
    | jq -c <span style="color: #98be65;">'.AvailabilityZones[]</span>
<span style="color: #98be65;">             | {"Name": .ZoneName, "Id": .ZoneId}'</span>
</pre>
</div>

<div class="results">#+RESULTS:</div><pre class="example">
{"Name":"us-east-2a","Id":"use2-az1"}
{"Name":"us-east-2b","Id":"use2-az2"}
{"Name":"us-east-2c","Id":"use2-az3"}
</pre>
</div>
</div>
</div>

<div id="outline-container-orge786173" class="outline-2">
<h2 id="orge786173"><a href="#orge786173">EC2 KeyPairs</a></h2>
<div class="outline-text-2" id="text-orge786173">
</div>
<div id="outline-container-org86b1c6a" class="outline-3">
<h3 id="org86b1c6a"><a href="#org86b1c6a">Create</a></h3>
<div class="outline-text-3" id="text-org86b1c6a">
<div class="org-src-container">
<pre class="src src-sh" id="org2e3517b">aws ec2 create-key-pair --key-name $<span style="color: #dcaeea;">KeyName</span>
</pre>
</div>

<p>
Copy private key to <code>~/.ssh</code>
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #dcaeea;">KeyName</span>=$(<span style="color: #c678dd;">echo</span> $<span style="color: #dcaeea;">KeyPair</span> | jq -r <span style="color: #98be65;">'.KeyName'</span>)
<span style="color: #dcaeea;">KeyFile</span>=~/.ssh/$<span style="color: #dcaeea;">dir</span>/$<span style="color: #dcaeea;">KeyName</span>
<span style="color: #c678dd;">echo</span> $<span style="color: #dcaeea;">KeyPair</span> | jq -r <span style="color: #98be65;">'.KeyMaterial'</span> &gt; $<span style="color: #dcaeea;">KeyFile</span>
chmod 0600 $<span style="color: #dcaeea;">KeyFile</span>
<span style="color: #c678dd;">echo</span> $<span style="color: #dcaeea;">KeyFile</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7584c80" class="outline-3">
<h3 id="org7584c80"><a href="#org7584c80">Describe</a></h3>
<div class="outline-text-3" id="text-org7584c80">
<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-key-pairs | jq <span style="color: #98be65;">'.KeyPairs[]'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org82dbef7" class="outline-3">
<h3 id="org82dbef7"><a href="#org82dbef7">Delete</a></h3>
<div class="outline-text-3" id="text-org82dbef7">
<div class="org-src-container">
<pre class="src src-sh">aws ec2 delete-key-pair --key-name $<span style="color: #dcaeea;">KeyName</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org802dfa8" class="outline-2">
<h2 id="org802dfa8"><a href="#org802dfa8">EC2 Instances</a></h2>
<div class="outline-text-2" id="text-org802dfa8">
</div>
<div id="outline-container-org7cca485" class="outline-3">
<h3 id="org7cca485"><a href="#org7cca485">Get Running Instances</a></h3>
<div class="outline-text-3" id="text-org7cca485">
<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-instances <span style="color: #98be65;">\</span>
    --query <span style="color: #98be65;">"Reservations[].Instances[?State.name=="</span>running<span style="color: #98be65;">"]"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgba14233" class="outline-3">
<h3 id="orgba14233"><a href="#orgba14233">Get All Instance Tags</a></h3>
<div class="outline-text-3" id="text-orgba14233">
<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-instances <span style="color: #98be65;">\</span>
    | jq -c <span style="color: #98be65;">'.Reservations[] | .Instances[] | .Tags[]'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3fcddfb" class="outline-3">
<h3 id="org3fcddfb"><a href="#org3fcddfb">Get Instances with Tag Key</a></h3>
<div class="outline-text-3" id="text-org3fcddfb">
<p>
With just a specific Tag key, disregarding value:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-instances <span style="color: #98be65;">\</span>
    --filter <span style="color: #98be65;">"Name=tag-key,Values=k8s.io/role/node"</span> <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.Reservations[].Instances[]'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org880fa44" class="outline-3">
<h3 id="org880fa44"><a href="#org880fa44">Get Instances with Tag Key/Value</a></h3>
<div class="outline-text-3" id="text-org880fa44">
<p>
With just a specific Tag key:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-instances <span style="color: #98be65;">\</span>
    --filter <span style="color: #98be65;">"Name=tag:$TagName,Values=$TagValue"</span> <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.Reservations[].Instances[].Tags[]</span>
<span style="color: #98be65;">             | select(.Key == "Name")</span>
<span style="color: #98be65;">             | .Value'</span>
</pre>
</div>

<p>
With a specific tag key and value
</p>
</div>
</div>
</div>

<div id="outline-container-orgeb57041" class="outline-2">
<h2 id="orgeb57041"><a href="#orgeb57041">EC2 Transit Gateway</a></h2>
<div class="outline-text-2" id="text-orgeb57041">
</div>
<div id="outline-container-orgdaf548c" class="outline-3">
<h3 id="orgdaf548c"><a href="#orgdaf548c">List Routes in a TG Route Table</a></h3>
<div class="outline-text-3" id="text-orgdaf548c">
<div class="org-src-container">
<pre class="src src-sh">aws --profile shared-services --region us-east-1 <span style="color: #98be65;">\</span>
    ec2 search-transit-gateway-routes <span style="color: #98be65;">\</span>
    --transit-gateway-route-table-id $<span style="color: #dcaeea;">TGWRouteTableId</span> <span style="color: #98be65;">\</span>
    --filters <span style="color: #98be65;">"Name=type,Values=propagated"</span> <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.Routes[].DestinationCidrBlock'</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orge5506b4" class="outline-2">
<h2 id="orge5506b4"><a href="#orge5506b4">EC2 VPCs</a></h2>
<div class="outline-text-2" id="text-orge5506b4">
</div>
<div id="outline-container-org85e3a67" class="outline-3">
<h3 id="org85e3a67"><a href="#org85e3a67">VPCs</a></h3>
<div class="outline-text-3" id="text-org85e3a67">
<div class="org-src-container">
<pre class="src src-bash">aws ec2 describe-vpcs | jq <span style="color: #98be65;">'.Vpcs[]'</span>
</pre>
</div>

<p>
The names of VPCs that have a <code>Name</code> tag:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-vpcs <span style="color: #98be65;">\</span>
    --filters <span style="color: #dcaeea;">Name</span>=tag-key,<span style="color: #dcaeea;">Values</span>=Name <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.Vpcs[].Tags[]</span>
<span style="color: #98be65;">             | select(.Key == "Name")</span>
<span style="color: #98be65;">             | .Value'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org2bbb314" class="outline-3">
<h3 id="org2bbb314"><a href="#org2bbb314">Subnets</a></h3>
<div class="outline-text-3" id="text-org2bbb314">
<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-subnets  | jq <span style="color: #98be65;">'.Subnets'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org094bba0" class="outline-3">
<h3 id="org094bba0"><a href="#org094bba0">SecurityGroups</a></h3>
<div class="outline-text-3" id="text-org094bba0">
<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-security-groups <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.SecurityGroups'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4bfe151" class="outline-3">
<h3 id="org4bfe151"><a href="#org4bfe151">Private ALB IPs</a></h3>
<div class="outline-text-3" id="text-org4bfe151">
<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-network-interfaces <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.NetworkInterfaces[]</span>
<span style="color: #98be65;">          | select(.Attachment.InstanceOwnerId == "amazon-elb")</span>
<span style="color: #98be65;">          | .PrivateIpAddress'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6b60942" class="outline-3">
<h3 id="org6b60942"><a href="#org6b60942">Managed Prefix Lists</a></h3>
<div class="outline-text-3" id="text-org6b60942">
<div class="org-src-container">
<pre class="src src-sh">aws ec2 describe-managed-prefix-lists <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.PrefixLists[]'</span>
</pre>
</div>

<p>
#+header :var PrefixListID=""
</p>
<div class="org-src-container">
<pre class="src src-sh">aws ec2 get-managed-prefix-list-entries <span style="color: #98be65;">\</span>
    --prefix-list-id $<span style="color: #dcaeea;">PrefixListID</span> <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.Entries[]'</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb09cc04" class="outline-2">
<h2 id="orgb09cc04"><a href="#orgb09cc04">EC2 Volumes</a></h2>
<div class="outline-text-2" id="text-orgb09cc04">
</div>
<div id="outline-container-org809994b" class="outline-3">
<h3 id="org809994b"><a href="#org809994b">List Volumes</a></h3>
<div class="outline-text-3" id="text-org809994b">
<div class="org-src-container">
<pre class="src src-sh" id="org63bbbaa">aws ec2 describe-volumes <span style="color: #98be65;">\</span>
    --filters <span style="color: #dcaeea;">Name</span>=tag-key,<span style="color: #dcaeea;">Values</span>=$<span style="color: #dcaeea;">Tag</span> <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.Volumes[].VolumeId'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd0a9318" class="outline-3">
<h3 id="orgd0a9318"><a href="#orgd0a9318">List Unattached Volumes</a></h3>
<div class="outline-text-3" id="text-orgd0a9318">
<div class="org-src-container">
<pre class="src src-sh" id="org941bb05">aws ec2 describe-volumes <span style="color: #98be65;">\</span>
    --filters <span style="color: #dcaeea;">Name</span>=status,<span style="color: #dcaeea;">Values</span>=available <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.Volumes[].VolumeId'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge29a71c" class="outline-3">
<h3 id="orge29a71c"><a href="#orge29a71c">Delete Volumes</a></h3>
<div class="outline-text-3" id="text-orge29a71c">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #51afef;">for</span> volume<span style="color: #51afef;"> in</span> $<span style="color: #dcaeea;">Volumes</span>; <span style="color: #51afef;">do</span>
    aws ec2 delete-volume --volume-id $<span style="color: #dcaeea;">volume</span>
<span style="color: #51afef;">done</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgbb03ebe" class="outline-2">
<h2 id="orgbb03ebe"><a href="#orgbb03ebe">ECR</a></h2>
<div class="outline-text-2" id="text-orgbb03ebe">
</div>
<div id="outline-container-orgd6f2beb" class="outline-3">
<h3 id="orgd6f2beb"><a href="#orgd6f2beb">Log in</a></h3>
<div class="outline-text-3" id="text-orgd6f2beb">
<p>
TODO: <code>$account</code> doesn't work (newline)
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #dcaeea;">ecr</span>=$<span style="color: #dcaeea;">account</span>.dkr.ecr.$<span style="color: #dcaeea;">AWS_DEFAULT_REGION</span>.amazonaws.com
<span style="color: #dcaeea;">pw</span>=$(aws ecr get-login-password)
docker login <span style="color: #98be65;">\</span>
       --username AWS <span style="color: #98be65;">\</span>
       --password <span style="color: #98be65;">"$pw"</span> <span style="color: #98be65;">\</span>
       <span style="color: #98be65;">"https://$ecr"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5b407f7" class="outline-3">
<h3 id="org5b407f7"><a href="#org5b407f7">Create Repository</a></h3>
<div class="outline-text-3" id="text-org5b407f7">
<div class="org-src-container">
<pre class="src src-sh">aws ecr create-repository <span style="color: #98be65;">\</span>
    --repository-name $<span style="color: #dcaeea;">repoName</span> <span style="color: #98be65;">\</span>
    --tags <span style="color: #98be65;">"Key=Foo,Value=True"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1122884" class="outline-3">
<h3 id="org1122884"><a href="#org1122884">Add Image</a></h3>
<div class="outline-text-3" id="text-org1122884">
<p>
Tag image for ECR:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #dcaeea;">ecr</span>=$<span style="color: #dcaeea;">account</span>.dkr.ecr.$<span style="color: #dcaeea;">AWS_DEFAULT_REGION</span>.amazonaws.com
docker tag <span style="color: #98be65;">\</span>
       $<span style="color: #dcaeea;">image</span>:$<span style="color: #dcaeea;">tag</span> <span style="color: #98be65;">\</span>
       $<span style="color: #dcaeea;">ecr</span>/$<span style="color: #dcaeea;">name</span>:$<span style="color: #dcaeea;">tag</span>
</pre>
</div>

<p>
Push it:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #dcaeea;">ecr</span>=$<span style="color: #dcaeea;">account</span>.dkr.ecr.$<span style="color: #dcaeea;">AWS_DEFAULT_REGION</span>.amazonaws.com
docker push <span style="color: #98be65;">\</span>
       $<span style="color: #dcaeea;">ecr</span>/$<span style="color: #dcaeea;">name</span>:$<span style="color: #dcaeea;">tag</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org8d3d512" class="outline-2">
<h2 id="org8d3d512"><a href="#org8d3d512">ECS</a></h2>
<div class="outline-text-2" id="text-org8d3d512">
<p>
Fix a CloudFormation deployment where an ECS service fails to stabilize. Taken
from <a href="https://aws.amazon.com/premiumsupport/knowledge-center/cloudformation-ecs-service-stabilize/">this</a> AWS blog post. Just updates the number of ECS service tasks to 0.
</p>

<div class="org-src-container">
<pre class="src src-sh">aws ecs update-service <span style="color: #98be65;">\</span>
    --cluster $<span style="color: #dcaeea;">ECS_CLUSTER_NAME</span> <span style="color: #98be65;">\</span>
    --service $<span style="color: #dcaeea;">ECS_SERVICE_NAME</span> <span style="color: #98be65;">\</span>
    --desired-count 0
</pre>
</div>
</div>
</div>

<div id="outline-container-org7c0a659" class="outline-2">
<h2 id="org7c0a659"><a href="#org7c0a659">EKS</a></h2>
<div class="outline-text-2" id="text-org7c0a659">
</div>
<div id="outline-container-org902ce68" class="outline-3">
<h3 id="org902ce68"><a href="#org902ce68">List Clusters</a></h3>
<div class="outline-text-3" id="text-org902ce68">
<div class="org-src-container">
<pre class="src src-sh">aws eks list-clusters | jq <span style="color: #98be65;">'.clusters[]'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org07ccf37" class="outline-3">
<h3 id="org07ccf37"><a href="#org07ccf37">Get Kube Config</a></h3>
<div class="outline-text-3" id="text-org07ccf37">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #dcaeea;">KUBECONFIG</span>=~/.kube/ironnet_clusters/$<span style="color: #dcaeea;">CLUSTER_NAME</span>
aws eks update-kubeconfig <span style="color: #98be65;">\</span>
    --name $<span style="color: #dcaeea;">CLUSTER_NAME</span> <span style="color: #98be65;">\</span>
    --kubeconfig $<span style="color: #dcaeea;">KUBECONFIG</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orga2776ff" class="outline-2">
<h2 id="orga2776ff"><a href="#orga2776ff">Elasticache</a></h2>
<div class="outline-text-2" id="text-orga2776ff">
</div>
<div id="outline-container-org0f79de6" class="outline-3">
<h3 id="org0f79de6"><a href="#org0f79de6">List CacheClusters</a></h3>
<div class="outline-text-3" id="text-org0f79de6">
<div class="org-src-container">
<pre class="src src-sh">aws elasticache describe-cache-clusters <span style="color: #98be65;">\</span>
    --show-cache-node-info <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.CacheClusters'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org178032d" class="outline-3">
<h3 id="org178032d"><a href="#org178032d">List ReplicationGroups</a></h3>
<div class="outline-text-3" id="text-org178032d">
<div class="org-src-container">
<pre class="src src-sh">aws elasticache describe-replication-groups
        | jq <span style="color: #98be65;">'.ReplicationGroups'</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf2eab5b" class="outline-2">
<h2 id="orgf2eab5b"><a href="#orgf2eab5b">ElasticBeanstalk</a></h2>
<div class="outline-text-2" id="text-orgf2eab5b">
</div>
<div id="outline-container-org3545be4" class="outline-3">
<h3 id="org3545be4"><a href="#org3545be4">Config Options for Nampespace</a></h3>
<div class="outline-text-3" id="text-org3545be4">
<div class="org-src-container">
<pre class="src src-sh">aws elasticbeanstalk describe-configuration-options <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.Options[]</span>
<span style="color: #98be65;">          | if .Namespace == "aws:autoscaling:launchconfiguration"</span>
<span style="color: #98be65;">            then .</span>
<span style="color: #98be65;">            else null</span>
<span style="color: #98be65;">            end'</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org4f6c1e4" class="outline-2">
<h2 id="org4f6c1e4"><a href="#org4f6c1e4">ElasticLoadBalancingV2</a></h2>
<div class="outline-text-2" id="text-org4f6c1e4">
</div>
<div id="outline-container-orgfe93821" class="outline-3">
<h3 id="orgfe93821"><a href="#orgfe93821">Describe ALBs</a></h3>
<div class="outline-text-3" id="text-orgfe93821">
<div class="org-src-container">
<pre class="src src-sh">aws elbv2 describe-load-balancers <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.LoadBalancers[] | select(.Type == "application")'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org8c78c4c" class="outline-3">
<h3 id="org8c78c4c"><a href="#org8c78c4c">Get DNS Name</a></h3>
<div class="outline-text-3" id="text-org8c78c4c">
<div class="org-src-container">
<pre class="src src-sh">aws elbv2 describe-load-balancers <span style="color: #98be65;">\</span>
    | jq -r --arg DEPLOYMENT_NAME <span style="color: #98be65;">"$DEPLOYMENT_NAME"</span> <span style="color: #98be65;">\</span>
         <span style="color: #98be65;">'.LoadBalancers[]</span>
<span style="color: #98be65;">          | select(.Type == "application")</span>
<span style="color: #98be65;">          | select(.LoadBalancerName</span>
<span style="color: #98be65;">          | startswith($DEPLOYMENT_NAME))</span>
<span style="color: #98be65;">          | .DNSName'</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org15cef0e" class="outline-2">
<h2 id="org15cef0e"><a href="#org15cef0e">GlobalAccelerator</a></h2>
<div class="outline-text-2" id="text-org15cef0e">
<p>
GlobalAccelerator is only in <code>us-west-2</code>, so set the region explicitly.
</p>
</div>

<div id="outline-container-orgdcbeffd" class="outline-3">
<h3 id="orgdcbeffd"><a href="#orgdcbeffd">List Accelerators</a></h3>
<div class="outline-text-3" id="text-orgdcbeffd">
<div class="org-src-container">
<pre class="src src-sh">aws --region us-west-2 <span style="color: #98be65;">\</span>
    globalaccelerator list-accelerators <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.Accelerators[]'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5318dce" class="outline-3">
<h3 id="org5318dce"><a href="#org5318dce">List Listeners</a></h3>
<div class="outline-text-3" id="text-org5318dce">
<div class="org-src-container">
<pre class="src src-sh">aws --region us-west-2 <span style="color: #98be65;">\</span>
    globalaccelerator list-listeners <span style="color: #98be65;">\</span>
    --accelerator-arn $<span style="color: #dcaeea;">AcceleratorArn</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf87b5c0" class="outline-3">
<h3 id="orgf87b5c0"><a href="#orgf87b5c0">IPs</a></h3>
<div class="outline-text-3" id="text-orgf87b5c0">
<div class="org-src-container">
<pre class="src src-sh">aws --region us-west-2 <span style="color: #98be65;">\</span>
    globalaccelerator list-accelerators <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.Accelerators[].IpSets[].IpAddresses[]'</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgce07388" class="outline-2">
<h2 id="orgce07388"><a href="#orgce07388">IAM</a></h2>
<div class="outline-text-2" id="text-orgce07388">
</div>
<div id="outline-container-org92d8b3d" class="outline-3">
<h3 id="org92d8b3d"><a href="#org92d8b3d">Create Policy</a></h3>
<div class="outline-text-3" id="text-org92d8b3d">
<div class="org-src-container">
<pre class="src src-sh">aws iam create-policy <span style="color: #98be65;">\</span>
    --policy-name $<span style="color: #dcaeea;">PolicyName</span> <span style="color: #98be65;">\</span>
    --policy-document <span style="color: #98be65;">'{</span>
<span style="color: #98be65;">  "Version": "2012-10-17",</span>
<span style="color: #98be65;">  "Statement": [{</span>
<span style="color: #98be65;">    "Effect": "Allow",</span>
<span style="color: #98be65;">    "Action": [</span>
<span style="color: #98be65;">      "secretsmanager:GetSecretValue",</span>
<span style="color: #98be65;">      "secretsmanager:DescribeSecret"</span>
<span style="color: #98be65;">    ],</span>
<span style="color: #98be65;">    "Resource": [</span>
<span style="color: #98be65;">      "arn:*:secretsmanager:*:*:secret:MySecret"</span>
<span style="color: #98be65;">    ]</span>
<span style="color: #98be65;">  }]</span>
<span style="color: #98be65;">}'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org29b87dc" class="outline-3">
<h3 id="org29b87dc"><a href="#org29b87dc">Describe Policy</a></h3>
<div class="outline-text-3" id="text-org29b87dc">
<div class="org-src-container">
<pre class="src src-sh">aws iam get-policy --policy-arn $<span style="color: #dcaeea;">arn</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org44188e0" class="outline-3">
<h3 id="org44188e0"><a href="#org44188e0">Assume Role</a></h3>
<div class="outline-text-3" id="text-org44188e0">
<div class="org-src-container">
<pre class="src src-sh" id="org1e27212">aws sts assume-role <span style="color: #98be65;">\</span>
    --role-session-name foo <span style="color: #98be65;">\</span>
    --role-arn $<span style="color: #dcaeea;">RoleArn</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org2ec8d74" class="outline-3">
<h3 id="org2ec8d74"><a href="#org2ec8d74">List Instance Profiles</a></h3>
<div class="outline-text-3" id="text-org2ec8d74">
<div class="org-src-container">
<pre class="src src-sh">aws iam list-instance-profiles <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.InstanceProfiles[].InstanceProfileName'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org17db863" class="outline-3">
<h3 id="org17db863"><a href="#org17db863">Delete Instance Profile</a></h3>
<div class="outline-text-3" id="text-org17db863">
<div class="org-src-container">
<pre class="src src-sh">aws iam delete-instance-profile <span style="color: #98be65;">\</span>
    --instance-profile-name $<span style="color: #dcaeea;">Name</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orge90e732" class="outline-2">
<h2 id="orge90e732"><a href="#orge90e732">IMDS</a></h2>
<div class="outline-text-2" id="text-orge90e732">
<p>
<a href="http://169.254.169.254/latest/meta-data/">http://169.254.169.254/latest/meta-data/</a>
</p>
</div>
</div>

<div id="outline-container-org524a14d" class="outline-2">
<h2 id="org524a14d"><a href="#org524a14d">Kinesis</a></h2>
<div class="outline-text-2" id="text-org524a14d">
</div>
<div id="outline-container-orgfb070f7" class="outline-3">
<h3 id="orgfb070f7"><a href="#orgfb070f7">Delete Stream</a></h3>
<div class="outline-text-3" id="text-orgfb070f7">
<div class="org-src-container">
<pre class="src src-sh">aws kinesis delete-stream --stream-name $<span style="color: #dcaeea;">stream</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org447341c" class="outline-2">
<h2 id="org447341c"><a href="#org447341c">Kinesis Firehose</a></h2>
<div class="outline-text-2" id="text-org447341c">
</div>
<div id="outline-container-org538cae4" class="outline-3">
<h3 id="org538cae4"><a href="#org538cae4">Describe Stream</a></h3>
<div class="outline-text-3" id="text-org538cae4">
<div class="org-src-container">
<pre class="src src-sh">aws firehose describe-delivery-stream <span style="color: #98be65;">\</span>
    --delivery-stream-name $<span style="color: #dcaeea;">StreamName</span> <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.DeliveryStreamDescription'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1c25db3" class="outline-3">
<h3 id="org1c25db3"><a href="#org1c25db3">Update Stream S3 Destination Bucket</a></h3>
<div class="outline-text-3" id="text-org1c25db3">
<div class="org-src-container">
<pre class="src src-sh">aws firehose update-destination <span style="color: #98be65;">\</span>
    --delivery-stream-name $<span style="color: #dcaeea;">StreamName</span> <span style="color: #98be65;">\</span>
    --current-delivery-stream-version-id 1 <span style="color: #98be65;">\</span>
    --destination-id destinationId-000000000001 <span style="color: #98be65;">\</span>
    --extended-s3-destination-update <span style="color: #98be65;">\</span>
    <span style="color: #dcaeea;">BucketARN</span>=arn:aws:s3:::$<span style="color: #dcaeea;">BucketName</span>
</pre>
</div>

<p>
THEN:
</p>

<ul class="org-ul">
<li>Update the Stream's IAM policy to allow it to write to the new location</li>
<li>Update the S3 Bucket Policy to allow the Stream's IAM Role to write to it</li>
</ul>
</div>
</div>

<div id="outline-container-org9a05898" class="outline-3">
<h3 id="org9a05898"><a href="#org9a05898">Update Stream S3 Destination Prefix</a></h3>
<div class="outline-text-3" id="text-org9a05898">
<div class="org-src-container">
<pre class="src src-sh">aws firehose update-destination <span style="color: #98be65;">\</span>
    --delivery-stream-name $<span style="color: #dcaeea;">StreamName</span> <span style="color: #98be65;">\</span>
    --current-delivery-stream-version-id 1 <span style="color: #98be65;">\</span>
    --destination-id destinationId-000000000001 <span style="color: #98be65;">\</span>
    --extended-s3-destination-update <span style="color: #dcaeea;">Prefix</span>=$<span style="color: #dcaeea;">Prefix</span>
</pre>
</div>

<p>
Also may need to update the IAM Policy and the S3 Bucket policy, as above.
</p>
</div>
</div>
</div>

<div id="outline-container-org58ab81e" class="outline-2">
<h2 id="org58ab81e"><a href="#org58ab81e">Lambda</a></h2>
<div class="outline-text-2" id="text-org58ab81e">
</div>
<div id="outline-container-org6a93227" class="outline-3">
<h3 id="org6a93227"><a href="#org6a93227">Invoke function</a></h3>
<div class="outline-text-3" id="text-org6a93227">
<div class="org-src-container">
<pre class="src src-bash">aws lambda invoke <span style="color: #98be65;">\</span>
    --cli-binary-format raw-in-base64-out <span style="color: #98be65;">\</span>
    --function-name cf-Hello-World <span style="color: #98be65;">\</span>
    /tmp/cats.json
</pre>
</div>

<p>
Invoke from a bastion host:
</p>

<div class="org-src-container">
<pre class="src src-bash">/usr/local/bin/aws lambda invoke <span style="color: #98be65;">\</span>
                   --cli-binary-format raw-in-base64-out <span style="color: #98be65;">\</span>
                   --function-name cf-Hello-World <span style="color: #98be65;">\</span>
                   /tmp/cats.json
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">cat /tmp/out.json | jq -r <span style="color: #98be65;">'.body'</span> | jq
</pre>
</div>

<p>
With payload file:
</p>

<div class="org-src-container">
<pre class="src src-bash">aws lambda invoke <span style="color: #98be65;">\</span>
    --cli-binary-format raw-in-base64-out <span style="color: #98be65;">\</span>
    --function-name hello-world <span style="color: #98be65;">\</span>
    --payload file://tests/resources/event_alb.json <span style="color: #98be65;">\</span>
    /tmp/out.json
</pre>
</div>
</div>
</div>

<div id="outline-container-org37e6f45" class="outline-3">
<h3 id="org37e6f45"><a href="#org37e6f45">Create Function with Zip File</a></h3>
<div class="outline-text-3" id="text-org37e6f45">
<div class="org-src-container">
<pre class="src src-sh">aws lambda create-function <span style="color: #98be65;">\</span>
    --function-name artifacttool <span style="color: #98be65;">\</span>
    --runtime python2.7 <span style="color: #98be65;">\</span>
    --role $<span style="color: #dcaeea;">RoleArn</span> <span style="color: #98be65;">\</span>
    --handler lambda_function.lambda_handler <span style="color: #98be65;">\</span>
    --zip-file fileb://$<span style="color: #dcaeea;">ZipFileName</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1da8806" class="outline-3">
<h3 id="org1da8806"><a href="#org1da8806">Update Function code with Zip File</a></h3>
<div class="outline-text-3" id="text-org1da8806">
<div class="org-src-container">
<pre class="src src-sh">aws lambda update-function-code <span style="color: #98be65;">\</span>
    --function-name artifacttool <span style="color: #98be65;">\</span>
    --zip-file fileb://$<span style="color: #dcaeea;">ZipFileName</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org61177cb" class="outline-3">
<h3 id="org61177cb"><a href="#org61177cb">Container Image: Run Interactively</a></h3>
<div class="outline-text-3" id="text-org61177cb">
<div class="org-src-container">
<pre class="src src-sh">docker run -it --rm <span style="color: #98be65;">\</span>
       --entrypoint bash <span style="color: #98be65;">\</span>
       public.ecr.aws/lambda/python:3.8
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgdcc0535" class="outline-2">
<h2 id="orgdcc0535"><a href="#orgdcc0535">Organizations</a></h2>
<div class="outline-text-2" id="text-orgdcc0535">
<div class="org-src-container">
<pre class="src src-sh" id="org4b6b4fd">aws organizations list-roots <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.Roots[].Id'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org77afbd8" class="outline-2">
<h2 id="org77afbd8"><a href="#org77afbd8">Polly</a></h2>
<div class="outline-text-2" id="text-org77afbd8">
<div class="org-src-container">
<pre class="src src-sh">aws polly synthesize-speech <span style="color: #98be65;">\</span>
    --engine standard <span style="color: #98be65;">\</span>
    --output-format mp3 <span style="color: #98be65;">\</span>
    --voice-id Amy <span style="color: #98be65;">\</span>
    --text <span style="color: #98be65;">"All these cats wear hats."</span> <span style="color: #98be65;">\</span>
    /tmp/speech_standard.mp3 <span style="color: #98be65;">\</span>
    &amp;&amp; afplay /tmp/speech_standard.mp3
</pre>
</div>
</div>
</div>

<div id="outline-container-org4f417a6" class="outline-2">
<h2 id="org4f417a6"><a href="#org4f417a6">Reosurce Access Manager (RAM)</a></h2>
<div class="outline-text-2" id="text-org4f417a6">
<p>
This needs to be run against the AWS account that actually owns the shared
resources. E.g. in a LandingZone environment, probably the shared-services
account.
</p>

<div class="org-src-container">
<pre class="src src-sh">aws ram list-resources --resource-owner SELF
</pre>
</div>
</div>
</div>

<div id="outline-container-orged392ac" class="outline-2">
<h2 id="orged392ac"><a href="#orged392ac">RDS</a></h2>
<div class="outline-text-2" id="text-orged392ac">
</div>
<div id="outline-container-org7f886c4" class="outline-3">
<h3 id="org7f886c4"><a href="#org7f886c4">describe-db-instances</a></h3>
<div class="outline-text-3" id="text-org7f886c4">
<div class="org-src-container">
<pre class="src src-sh">aws rds describe-db-instances <span style="color: #98be65;">\</span>
    --db-instance-identifier <span style="color: #98be65;">"my-service-dev"</span> <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'DBInstances[]'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org8f4c0c1" class="outline-3">
<h3 id="org8f4c0c1"><a href="#org8f4c0c1">describe-db-engine-versions</a></h3>
<div class="outline-text-3" id="text-org8f4c0c1">
<div class="org-src-container">
<pre class="src src-sh">aws rds describe-db-engine-versions <span style="color: #98be65;">\</span>
    --engine <span style="color: #98be65;">"postgres"</span> <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.DBEngineVersions[].EngineVersion'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org9affadf" class="outline-3">
<h3 id="org9affadf"><a href="#org9affadf">pending maintenance actions for a DB</a></h3>
<div class="outline-text-3" id="text-org9affadf">
<div class="org-src-container">
<pre class="src src-sh">aws rds describe-pending-maintenance-actions <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.PendingMaintenanceActions[]</span>
<span style="color: #98be65;">          | select(.ResourceIdentifier=="$DB_ARN")'</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orga7f2e6b" class="outline-2">
<h2 id="orga7f2e6b"><a href="#orga7f2e6b">Route53</a></h2>
<div class="outline-text-2" id="text-orga7f2e6b">
</div>
<div id="outline-container-org9955e19" class="outline-3">
<h3 id="org9955e19"><a href="#org9955e19">Get HostedZoneId from domain name</a></h3>
<div class="outline-text-3" id="text-org9955e19">
<div class="org-src-container">
<pre class="src src-sh" id="orge74718d">aws route53 list-hosted-zones <span style="color: #98be65;">\</span>
    | jq -r --arg name $<span style="color: #dcaeea;">hostedZoneName</span> <span style="color: #98be65;">\</span>
         <span style="color: #98be65;">'.HostedZones[]</span>
<span style="color: #98be65;">          | select(.Name == $name + ".")</span>
<span style="color: #98be65;">          | select(.Config.PrivateZone == false)</span>
<span style="color: #98be65;">          | .Id'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd48bc48" class="outline-3">
<h3 id="orgd48bc48"><a href="#orgd48bc48">List Records for a HostedZone</a></h3>
<div class="outline-text-3" id="text-orgd48bc48">
<div class="org-src-container">
<pre class="src src-sh">aws route53 list-resource-record-sets <span style="color: #98be65;">\</span>
    --hosted-zone-id $<span style="color: #dcaeea;">hostedZoneId</span> <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.ResourceRecordSets[]'</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org3882600" class="outline-2">
<h2 id="org3882600"><a href="#org3882600">SecretsManager</a></h2>
<div class="outline-text-2" id="text-org3882600">
</div>
<div id="outline-container-org1d541b3" class="outline-3">
<h3 id="org1d541b3"><a href="#org1d541b3">List Secrets</a></h3>
<div class="outline-text-3" id="text-org1d541b3">
<div class="org-src-container">
<pre class="src src-sh">aws secretsmanager list-secrets <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.SecretList[].Name'</span>
</pre>
</div>

<p>
Filter:
</p>

<div class="org-src-container">
<pre class="src src-sh">aws secretsmanager list-secrets <span style="color: #98be65;">\</span>
    --filters <span style="color: #98be65;">'Key=name,Values=foo/bar'</span> <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.SecretList[].Name'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org0b68467" class="outline-3">
<h3 id="org0b68467"><a href="#org0b68467">Get Secret</a></h3>
<div class="outline-text-3" id="text-org0b68467">
<div class="org-src-container">
<pre class="src src-sh">aws secretsmanager get-secret-value <span style="color: #98be65;">\</span>
    --secret-id $<span style="color: #dcaeea;">SecretName</span> <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.SecretString'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org795edde" class="outline-3">
<h3 id="org795edde"><a href="#org795edde">Create Secret</a></h3>
<div class="outline-text-3" id="text-org795edde">
<div class="org-src-container">
<pre class="src src-sh">aws secretsmanager create-secret <span style="color: #98be65;">\</span>
    --name $<span style="color: #dcaeea;">SecretName</span> <span style="color: #98be65;">\</span>
    --secret-string $<span style="color: #dcaeea;">SecretValue</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org5f3f64c" class="outline-2">
<h2 id="org5f3f64c"><a href="#org5f3f64c">ServiceCatalog</a></h2>
<div class="outline-text-2" id="text-org5f3f64c">
</div>
<div id="outline-container-orgca6e0d5" class="outline-3">
<h3 id="orgca6e0d5"><a href="#orgca6e0d5">Get Product IDs</a></h3>
<div class="outline-text-3" id="text-orgca6e0d5">
<div class="org-src-container">
<pre class="src src-sh">aws --profile main servicecatalog search-products-as-admin
</pre>
</div>
</div>
</div>

<div id="outline-container-orgad610cf" class="outline-3">
<h3 id="orgad610cf"><a href="#orgad610cf">Launch Product</a></h3>
<div class="outline-text-3" id="text-orgad610cf">
<p>
Note that user, even Admin user, must be added to the Portfolio users/groups.
You can do this with <code>aws servicecatalog associate-principal-with-portfolio</code>
</p>
</div>
</div>
</div>

<div id="outline-container-orgd46de62" class="outline-2">
<h2 id="orgd46de62"><a href="#orgd46de62">Service Quotas</a></h2>
<div class="outline-text-2" id="text-orgd46de62">
</div>
<div id="outline-container-orga77bd22" class="outline-3">
<h3 id="orga77bd22"><a href="#orga77bd22">Get Quota</a></h3>
<div class="outline-text-3" id="text-orga77bd22">
<div class="org-src-container">
<pre class="src src-sh">aws service-quotas list-service-quotas <span style="color: #98be65;">\</span>
    --service-code firehose <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.Quotas[] | {QuotaName, Value}'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org158f895" class="outline-3">
<h3 id="org158f895"><a href="#org158f895">Get Default Quota</a></h3>
<div class="outline-text-3" id="text-org158f895">
<div class="org-src-container">
<pre class="src src-sh">aws service-quotas get-aws-default-service-quota <span style="color: #98be65;">\</span>
    --service-code firehose <span style="color: #98be65;">\</span>
    --quota-code $<span style="color: #dcaeea;">QuotaCode</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org8cb6e83" class="outline-2">
<h2 id="org8cb6e83"><a href="#org8cb6e83">S3</a></h2>
<div class="outline-text-2" id="text-org8cb6e83">
</div>
<div id="outline-container-orgd915749" class="outline-3">
<h3 id="orgd915749"><a href="#orgd915749">Canonical ID</a></h3>
<div class="outline-text-3" id="text-orgd915749">
<div class="org-src-container">
<pre class="src src-sh">aws s3api get-bucket-acl --bucket $<span style="color: #dcaeea;">BucketName</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb569f97" class="outline-3">
<h3 id="orgb569f97"><a href="#orgb569f97">Create Bucket</a></h3>
<div class="outline-text-3" id="text-orgb569f97">
<div class="org-src-container">
<pre class="src src-sh">aws s3api create-bucket <span style="color: #98be65;">\</span>
    --bucket $<span style="color: #dcaeea;">BUCKET_NAME</span> <span style="color: #98be65;">\</span>
    --create-bucket-configuration <span style="color: #dcaeea;">LocationConstraint</span>=$<span style="color: #dcaeea;">AWS_DEFAULT_REGION</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3598548" class="outline-3">
<h3 id="org3598548"><a href="#org3598548">List Objects</a></h3>
<div class="outline-text-3" id="text-org3598548">
<p>
All objects
</p>

<div class="org-src-container">
<pre class="src src-sh">aws s3api list-objects-v2 <span style="color: #98be65;">\</span>
    --bucket $<span style="color: #dcaeea;">BucketName</span> <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.Contents[]'</span>
</pre>
</div>

<p>
10 most recent objects. AWS has no way of doing this filtering server-side,
so you need to request all objects and then sort them.
</p>

<div class="org-src-container">
<pre class="src src-sh">aws s3api list-objects-v2 <span style="color: #98be65;">\</span>
    --bucket $<span style="color: #dcaeea;">BucketName</span> <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.Contents</span>
<span style="color: #98be65;">             | sort_by(.LastModified)</span>
<span style="color: #98be65;">             | reverse | first | .Key'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6660dfd" class="outline-3">
<h3 id="org6660dfd"><a href="#org6660dfd">Get object</a></h3>
<div class="outline-text-3" id="text-org6660dfd">
<div class="org-src-container">
<pre class="src src-sh">aws s3api get-object <span style="color: #98be65;">\</span>
    --bucket $<span style="color: #dcaeea;">BucketName</span> <span style="color: #98be65;">\</span>
    --key $<span style="color: #dcaeea;">Key</span> ./foo
</pre>
</div>
</div>
</div>

<div id="outline-container-org1fddda1" class="outline-3">
<h3 id="org1fddda1"><a href="#org1fddda1">Get multiple objects</a></h3>
<div class="outline-text-3" id="text-org1fddda1">
<div class="org-src-container">
<pre class="src src-sh">mkdir -p ~/Downloads/foo
aws s3 cp <span style="color: #98be65;">\</span>
    --recursive <span style="color: #98be65;">\</span>
    s3://$<span style="color: #dcaeea;">BucketName</span>/ <span style="color: #98be65;">\</span>
    ~/Downloads/foo/
</pre>
</div>
</div>
</div>

<div id="outline-container-org5dacec5" class="outline-3">
<h3 id="org5dacec5"><a href="#org5dacec5">Get Bucket Policy</a></h3>
<div class="outline-text-3" id="text-org5dacec5">
<div class="org-src-container">
<pre class="src src-sh">aws s3api get-bucket-policy --bucket $<span style="color: #dcaeea;">BucketName</span> <span style="color: #98be65;">\</span>
    | jq -r <span style="color: #98be65;">'.Policy'</span> | jq
</pre>
</div>
</div>
</div>

<div id="outline-container-org81dc8d9" class="outline-3">
<h3 id="org81dc8d9"><a href="#org81dc8d9">Delete Buckets</a></h3>
<div class="outline-text-3" id="text-org81dc8d9">
<p>
I have functions for this in <a href="https://github.com/cfclrk/dotfiles/blob/master/dotfiles/.functions.fish">dotfiles/.functions.fish</a>.
</p>
</div>
</div>
</div>

<div id="outline-container-org154e02e" class="outline-2">
<h2 id="org154e02e"><a href="#org154e02e">SNS</a></h2>
<div class="outline-text-2" id="text-org154e02e">
</div>
<div id="outline-container-org12b98d1" class="outline-3">
<h3 id="org12b98d1"><a href="#org12b98d1">SNS topics</a></h3>
<div class="outline-text-3" id="text-org12b98d1">
<div class="org-src-container">
<pre class="src src-sh">aws sns list-topics <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.Topics[] | .TopicArn'</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org09ca393" class="outline-2">
<h2 id="org09ca393"><a href="#org09ca393">SQS</a></h2>
<div class="outline-text-2" id="text-org09ca393">
</div>
<div id="outline-container-orgf6f0ddd" class="outline-3">
<h3 id="orgf6f0ddd"><a href="#orgf6f0ddd">List Queues</a></h3>
<div class="outline-text-3" id="text-orgf6f0ddd">
<div class="org-src-container">
<pre class="src src-sh">aws sqs list-queues <span style="color: #98be65;">\</span>
    | jq <span style="color: #98be65;">'.QueueUrls[]'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd684c4d" class="outline-3">
<h3 id="orgd684c4d"><a href="#orgd684c4d">Read Message</a></h3>
<div class="outline-text-3" id="text-orgd684c4d">
<div class="org-src-container">
<pre class="src src-sh" id="org967f7ac">aws --profile prod --region us-east-1 sqs receive-message <span style="color: #98be65;">\</span>
    --queue-url <span style="color: #98be65;">"$q_url"</span> <span style="color: #98be65;">\</span>
    --attribute-names All <span style="color: #98be65;">\</span>
    --message-attribute-names All <span style="color: #98be65;">\</span>
    --max-number-of-messages 2
</pre>
</div>
</div>
</div>

<div id="outline-container-org21bfe09" class="outline-3">
<h3 id="org21bfe09"><a href="#org21bfe09">Send Message</a></h3>
<div class="outline-text-3" id="text-org21bfe09">
<div class="org-src-container">
<pre class="src src-sh">aws sqs send-message <span style="color: #98be65;">\</span>
    --queue-url <span style="color: #98be65;">"$q_url"</span> <span style="color: #98be65;">\</span>
    --message-body <span style="color: #98be65;">'{"Message": "{\"foo\":\"bar\"}"}'</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf97ac30" class="outline-2">
<h2 id="orgf97ac30"><a href="#orgf97ac30">SSM</a></h2>
<div class="outline-text-2" id="text-orgf97ac30">
<div class="org-src-container">
<pre class="src src-sh">aws ssm get-parameter <span style="color: #98be65;">\</span>
    --with-decryption <span style="color: #98be65;">\</span>
    --name $<span style="color: #dcaeea;">name</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgeea0d28" class="outline-2">
<h2 id="orgeea0d28"><a href="#orgeea0d28">SSO</a></h2>
<div class="outline-text-2" id="text-orgeea0d28">
</div>
<div id="outline-container-org88165e1" class="outline-3">
<h3 id="org88165e1"><a href="#org88165e1">Register Client</a></h3>
<div class="outline-text-3" id="text-org88165e1">
<p>
This command <b>does not</b> require AWS credentials. You only need a region.
</p>

<div class="org-src-container">
<pre class="src src-sh">aws --region us-east-1 sso-oidc register-client <span style="color: #98be65;">\</span>
    --client-name foo <span style="color: #98be65;">\</span>
    --client-type public
</pre>
</div>

<p>
Returns an object like:
</p>

<pre class="example" id="orgb594d9f">
{
    "clientId": "abc1234",
    "clientSecret": "a JSON Web Token",
    "clientIdIssuedAt": 1659099242,
    "clientSecretExpiresAt": 1666875242
}
</pre>
</div>
</div>

<div id="outline-container-orgf5857a2" class="outline-3">
<h3 id="orgf5857a2"><a href="#orgf5857a2">Token</a></h3>
<div class="outline-text-3" id="text-orgf5857a2">
<p>
TODO: Need to run aws sso login. Requires block in <code>~/.aws/config</code> I think.
</p>

<p>
TODO: Look up token file programatically
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org2fd03f1"><span style="color: #dcaeea;">token_file</span>=~/.aws/sso/cache/$<span style="color: #dcaeea;">token_name</span>.json
cat $<span style="color: #dcaeea;">token_file</span> | jq -r <span style="color: #98be65;">'.accessToken'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge8f9e05" class="outline-3">
<h3 id="orge8f9e05"><a href="#orge8f9e05">List Accounts I Can Access</a></h3>
<div class="outline-text-3" id="text-orge8f9e05">
<p>
TODO: SsoToken has a trailing newline!
</p>

<div class="org-src-container">
<pre class="src src-sh">aws sso list-accounts <span style="color: #98be65;">\</span>
    --access-token $<span style="color: #dcaeea;">token</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">aws sso list-account-roles <span style="color: #98be65;">\</span>
    --access-token $<span style="color: #dcaeea;">token</span> <span style="color: #98be65;">\</span>
    --account-id 820416642700
</pre>
</div>
</div>
</div>
</div>
</div>
</body>
</html>
