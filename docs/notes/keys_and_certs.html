<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Keys and Certificates</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/static/main.css" />
</head>
<body>
<div id="preamble" class="status">
<nav id="navbar" class="cf">
  <ul class="cf">
    <li class="fl">
      <a href="/">cfclrk</a>
    </li>
    <li class="fr">
      <a href="/articles/home.html">Articles</a>
    </li>
    <li class="fr">
      <a href="/notes/home.html">Notes</a>
    </li>
	<li class="fr">
      <a href="/cloudformation/home.html">CloudFormation</a>
    </li>
  </ul>
</nav>
</div>
<div id="content" class="content">
<header>
<h1 class="title">Keys and Certificates</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orge4d4520">Discover Public Certificates</a></li>
<li><a href="#org8f00c33">Create an SSH Key Pair</a>
<ul>
<li><a href="#orge5992ce">No Passphrase</a></li>
<li><a href="#org4dc1fbe">With Passphrase</a></li>
</ul>
</li>
<li><a href="#org69cf9f2">Conversions</a></li>
<li><a href="#org397fa11">Eliptic Curve Keys and Certs</a>
<ul>
<li><a href="#org992cc99">List Curves</a></li>
</ul>
</li>
<li><a href="#orgc83207e">Creating Certificates</a>
<ul>
<li><a href="#orgc83e3b4">Create Keypair</a></li>
<li><a href="#org596fcf2">CA Certificates</a>
<ul>
<li><a href="#org07b9d33">Self-Issued Certificates</a></li>
<li><a href="#orgda44133">Self-Signed Certificates</a></li>
<li><a href="#org25ca3e1">Cross-Certificate</a></li>
</ul>
</li>
<li><a href="#org2dda993">Entity Certificates</a></li>
</ul>
</li>
<li><a href="#org095288e">cfssl</a></li>
<li><a href="#org113c521">Fingerprint</a></li>
<li><a href="#org9614322">Native Certs</a></li>
<li><a href="#org018a894">Checking and Viewing Certs</a>
<ul>
<li><a href="#orgc292de5">View a Server's Certificate</a></li>
<li><a href="#org88a4399">Check if a Private Key Matches a Certificate</a></li>
<li><a href="#org1e1b883">CSR</a></li>
<li><a href="#org79260d6">Verify Cert with CA</a></li>
</ul>
</li>
</ul>
</div>
</nav>

<div id="outline-container-orge4d4520" class="outline-2">
<h2 id="orge4d4520"><a href="#orge4d4520">Discover Public Certificates</a></h2>
<div class="outline-text-2" id="text-orge4d4520">
<p>
Use <a href="https://cert.sh">cert.sh</a>. For example, to see all certs issued for <code>cats.com</code>:
<a href="https://crt.sh/?q=%25.cats.com">https://crt.sh/?q=%25.cats.com</a>
</p>

<p>
Advanced search page: <a href="https://crt.sh/?a=1">https://crt.sh/?a=1</a>
</p>

<p>
The data is stored in a relational DB. Optionally show the SQL query a page
makes using <code>&amp;showSQL=Y</code>, or by selecting "Show SQL?" on the advanced search
page.
</p>
</div>
</div>

<div id="outline-container-org8f00c33" class="outline-2">
<h2 id="org8f00c33"><a href="#org8f00c33">Create an SSH Key Pair</a></h2>
<div class="outline-text-2" id="text-org8f00c33">
<p>
<code>ssh-keygen</code> creates two files: <code>$keyname</code> and <code>$keyname.pub</code>.
</p>
</div>

<div id="outline-container-orge5992ce" class="outline-3">
<h3 id="orge5992ce"><a href="#orge5992ce">No Passphrase</a></h3>
<div class="outline-text-3" id="text-orge5992ce">
<p>
For RSA: use <code>-t rsa -b 2048</code>.
</p>

<div class="org-src-container">
<pre class="src src-sh">ssh-keygen <span style="color: #98be65;">\</span>
    -t ed25519 <span style="color: #98be65;">\</span>
    -N <span style="color: #98be65;">""</span> <span style="color: #98be65;">\</span>
    -f ~/.ssh/$<span style="color: #dcaeea;">keyname</span> <span style="color: #98be65;">\</span>
    -C <span style="color: #98be65;">"$email"</span>
</pre>
</div>

<p>
The email address is optional:
</p>

<div class="org-src-container">
<pre class="src src-sh">ssh-keygen -t ed25519 -f ~/.ssh/$<span style="color: #dcaeea;">keyname</span> -N <span style="color: #98be65;">""</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4dc1fbe" class="outline-3">
<h3 id="org4dc1fbe"><a href="#org4dc1fbe">With Passphrase</a></h3>
<div class="outline-text-3" id="text-org4dc1fbe">
<div class="org-src-container">
<pre class="src src-sh">ssh-keygen -t ed25519 -f ~/.ssh/$<span style="color: #dcaeea;">keyname</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org69cf9f2" class="outline-2">
<h2 id="org69cf9f2"><a href="#org69cf9f2">Conversions</a></h2>
<div class="outline-text-2" id="text-org69cf9f2">
<p>
Generate a public key from a private key:
</p>

<div class="org-src-container">
<pre class="src src-sh">ssh-keygen -y <span style="color: #98be65;">\</span>
           -f ~/.ssh/${<span style="color: #dcaeea;">keyname</span>}.pem <span style="color: #98be65;">\</span>
           $<span style="color: #dcaeea;">HOME</span>/.ssh/${<span style="color: #dcaeea;">keyname</span>}.pub
</pre>
</div>
</div>
</div>

<div id="outline-container-org397fa11" class="outline-2">
<h2 id="org397fa11"><a href="#org397fa11">Eliptic Curve Keys and Certs</a></h2>
<div class="outline-text-2" id="text-org397fa11">
</div>
<div id="outline-container-org992cc99" class="outline-3">
<h3 id="org992cc99"><a href="#org992cc99">List Curves</a></h3>
<div class="outline-text-3" id="text-org992cc99">
<p>
<code>prime256v1</code> is suitable for JWT signing (<a href="https://www.scottbrady91.com/OpenSSL/Creating-Elliptical-Curve-Keys-using-OpenSSL">ref</a>).
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl ecparam -list_curves
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgc83207e" class="outline-2">
<h2 id="orgc83207e"><a href="#orgc83207e">Creating Certificates</a></h2>
<div class="outline-text-2" id="text-orgc83207e">
<p>
Note: there is a golang tool to create self-signed certs at <code>$(go env
  GOROOT)/src/crypto/tls/generate_cert.go</code>.
</p>
</div>

<div id="outline-container-orgc83e3b4" class="outline-3">
<h3 id="orgc83e3b4"><a href="#orgc83e3b4">Create Keypair</a></h3>
<div class="outline-text-3" id="text-orgc83e3b4">
<p>
The <code>openssl genrsa</code> command creates a private key that includes a public
key.
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org128345b">openssl genrsa 1024
</pre>
</div>

<p>
Extract the public key from the private key:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #c678dd;">echo</span> <span style="color: #98be65;">"$keypair"</span> | openssl rsa -outform PEM -pubout
</pre>
</div>
</div>
</div>

<div id="outline-container-org596fcf2" class="outline-3">
<h3 id="org596fcf2"><a href="#org596fcf2">CA Certificates</a></h3>
<div class="outline-text-3" id="text-org596fcf2">
<p>
From <a href="https://datatracker.ietf.org/doc/html/rfc5280#section-3.2">RFC 5280</a>:
</p>

<blockquote>
<p>
CA certificates may be further divided into three classes:
cross-certificates, self-issued certificates, and self-signed certificates.
</p>
</blockquote>

<p>
Every root CA certificate is a self-signed certificate. Intermediate CA
certificates are not self-signed; they are signed by their parent CA.
</p>

<p>
The following commands create a <code>ca.key</code> and a <code>ca.crt</code> file. Remember, the
<code>ca.key</code> actually contains both the public and private key. The certificate
has the public key, some metadata, and a signature (signed by some private
key).
</p>
</div>

<div id="outline-container-org07b9d33" class="outline-4">
<h4 id="org07b9d33"><a href="#org07b9d33">Self-Issued Certificates</a></h4>
<div class="outline-text-4" id="text-org07b9d33">
<p>
From <a href="https://datatracker.ietf.org/doc/html/rfc5280#section-3.2">RFC 5280</a>:
</p>

<blockquote>
<p>
Self-issued certificates are CA certificates in which the issuer and subject
are the same entity. Self-issued certificates are generated to support
changes in policy or operations.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-orgda44133" class="outline-4">
<h4 id="orgda44133"><a href="#orgda44133">Self-Signed Certificates</a></h4>
<div class="outline-text-4" id="text-orgda44133">
<p>
From <a href="https://datatracker.ietf.org/doc/html/rfc5280#section-3.2">RFC 5280</a>:
</p>

<blockquote>
<p>
Self-signed certificates are self-issued certificates where the digital
signature may be verified by the public key bound into the certificate.
Self-signed certificates are used to convey a public key for use to begin
certification paths.
</p>
</blockquote>

<p>
That is, self-signed certificates are either:
</p>

<ol class="org-ol">
<li>Root CA certifaces</li>
<li>You're a rogue renegade signing certs like a villian</li>
</ol>

<div class="org-src-container">
<pre class="src src-sh">openssl genrsa -out ca.key 2048
openssl req -x509 -new -nodes <span style="color: #98be65;">\</span>
        -key ca.key <span style="color: #98be65;">\</span>
        -subj <span style="color: #98be65;">"/CN=${CommonName}"</span> <span style="color: #98be65;">\</span>
        -days 3650 <span style="color: #98be65;">\</span>
        -out ca.crt
</pre>
</div>
</div>
</div>

<div id="outline-container-org25ca3e1" class="outline-4">
<h4 id="org25ca3e1"><a href="#org25ca3e1">Cross-Certificate</a></h4>
<div class="outline-text-4" id="text-org25ca3e1">
<p>
From <a href="https://datatracker.ietf.org/doc/html/rfc5280#section-3.2">RFC 5280</a>:
</p>

<blockquote>
<p>
Cross-certificates are CA certificates in which the issuer and subject are
different entities. Cross-certificates describe a trust relationship between
the two CAs.
</p>
</blockquote>
</div>
</div>
</div>

<div id="outline-container-org2dda993" class="outline-3">
<h3 id="org2dda993"><a href="#org2dda993">Entity Certificates</a></h3>
<div class="outline-text-3" id="text-org2dda993">
<blockquote>
<p>
End entity certificates are issued to subjects that are not authorized to
issue certificates.
</p>
</blockquote>

<p>
Create a new keypair. This creates two file: <code>client.key</code> (which actually has
both the public and private key in it).
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl genrsa -out client.key 2048
</pre>
</div>

<p>
Create a Certificate Signing Request (CSR), which is a document that
associates some metadata with the key. This creates one file: <code>client.csr</code>.
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl req -new <span style="color: #98be65;">\</span>
        -key client.key <span style="color: #98be65;">\</span>
        -subj <span style="color: #98be65;">"/CN=${CommonName}"</span> <span style="color: #98be65;">\</span>
        -out client.csr
</pre>
</div>

<p>
Create a client certificate by signing the CSR with the CA's private key. I
suppose the CA might first verify that the information in the CSR is
consistent (does the requester actually own the Common Name?), but in
practice I'm not sure of any examples where that actually happens.
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl x509 -req <span style="color: #98be65;">\</span>
        -in client.csr <span style="color: #98be65;">\</span>
        -CA $<span style="color: #dcaeea;">CACertFile</span> <span style="color: #98be65;">\</span>
        -CAkey $<span style="color: #dcaeea;">CAKeyFile</span> <span style="color: #98be65;">\</span>
        -CAcreateserial <span style="color: #98be65;">\</span>
        -out client.crt <span style="color: #98be65;">\</span>
        -days 3650 <span style="color: #98be65;">\</span>
        -sha256
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org095288e" class="outline-2">
<h2 id="org095288e"><a href="#org095288e">cfssl</a></h2>
<div class="outline-text-2" id="text-org095288e">
<div class="org-src-container">
<pre class="src src-sh">cfssl selfsign www.example.net acm-test.json <span style="color: #98be65;">\</span>
    | cfssljson -bare acm-test
</pre>
</div>
</div>
</div>

<div id="outline-container-org113c521" class="outline-2">
<h2 id="org113c521"><a href="#org113c521">Fingerprint</a></h2>
<div class="outline-text-2" id="text-org113c521">
<div class="org-src-container">
<pre class="src src-sh">openssl x509 -noout -fingerprint -sha256 <span style="color: #98be65;">\</span>
        -inform pem -in $<span style="color: #dcaeea;">file</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">ssh-keygen -lf $<span style="color: #dcaeea;">file</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">ssh-keygen -l -E md5 -f $<span style="color: #dcaeea;">file</span>
</pre>
</div>

<p>
AWS EC2 KeyPairs created by AWS are rather specific. This command is from the
docs <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html#verify-key-pair-fingerprints">here</a> about how to check their fingerprint.
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl pkcs8 -in $<span style="color: #dcaeea;">file</span> <span style="color: #98be65;">\</span>
        -inform PEM -outform DER -topk8 -nocrypt <span style="color: #98be65;">\</span>
    | openssl sha1 -c
</pre>
</div>
</div>
</div>

<div id="outline-container-org9614322" class="outline-2">
<h2 id="org9614322"><a href="#org9614322">Native Certs</a></h2>
<div class="outline-text-2" id="text-org9614322">
<p>
Sometimes certificates are bundled with applications; e.g. browsers bundle a
set of certificates curated by the browser's creators.
</p>

<p>
Other times, certificates are installed on, and managed by, the OS. These are
referred to as "native certificates".
</p>

<p>
<i>Properly</i> using native certificates is a headache, and requires knowledge of
how the OS handles certificates. See:
</p>

<ul class="org-ul">
<li><a href="https://github.com/rustls/rustls-native-certs/issues/25">This issue</a> for rustls-native-certs</li>
<li><a href="https://github.com/golang/go/issues/46287">This issue</a> for golang</li>
</ul>

<p>
However, if you're not trying to make the perfect system, you can just trust
whatever certs are in the MacOS Keychain or use the <code>update-ca-certificates</code>
program on Debian.
</p>
</div>
</div>

<div id="outline-container-org018a894" class="outline-2">
<h2 id="org018a894"><a href="#org018a894">Checking and Viewing Certs</a></h2>
<div class="outline-text-2" id="text-org018a894">
</div>
<div id="outline-container-orgc292de5" class="outline-3">
<h3 id="orgc292de5"><a href="#orgc292de5">View a Server's Certificate</a></h3>
<div class="outline-text-3" id="text-orgc292de5">
<p>
Show cert info for a website.
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl s_client -connect $<span style="color: #dcaeea;">domain</span>:443 -showcerts
</pre>
</div>

<p>
Show cert info for a local certificate file.
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl x509 -in $<span style="color: #dcaeea;">cert</span> -text -noout
</pre>
</div>
</div>
</div>

<div id="outline-container-org88a4399" class="outline-3">
<h3 id="org88a4399"><a href="#org88a4399">Check if a Private Key Matches a Certificate</a></h3>
<div class="outline-text-3" id="text-org88a4399">
<p>
On the private key:
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl rsa -modulus -noout -in $<span style="color: #dcaeea;">key</span>
</pre>
</div>

<p>
On the certificate:
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl x509 -modulus -noout -in $<span style="color: #dcaeea;">cert</span>
</pre>
</div>

<p>
If the output of those two are the same, then the keys go together. An easy
way to compare them is to pipe them both to <code>openssl md5</code>.
</p>
</div>
</div>

<div id="outline-container-org1e1b883" class="outline-3">
<h3 id="org1e1b883"><a href="#org1e1b883">CSR</a></h3>
<div class="outline-text-3" id="text-org1e1b883">
<div class="org-src-container">
<pre class="src src-sh">openssl req -text -noout -verify -in $<span style="color: #dcaeea;">file</span>.csr
</pre>
</div>
</div>
</div>

<div id="outline-container-org79260d6" class="outline-3">
<h3 id="org79260d6"><a href="#org79260d6">Verify Cert with CA</a></h3>
<div class="outline-text-3" id="text-org79260d6">
<div class="org-src-container">
<pre class="src src-sh">openssl verify -CAfile ca.crt entity.crt
</pre>
</div>
</div>
</div>
</div>
</div>
</body>
</html>
