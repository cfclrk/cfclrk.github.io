<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Docker</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/static/main.css" />
</head>
<body>
<div id="preamble" class="status">
<nav id="navbar" class="cf">
  <ul class="cf">
    <li class="fl">
      <a href="/">cfclrk</a>
    </li>
    <li class="fr">
      <a href="/articles/home.html">Articles</a>
    </li>
    <li class="fr">
      <a href="/notes/home.html">Notes</a>
    </li>
	<li class="fr">
      <a href="/cloudformation/home.html">CloudFormation</a>
    </li>
  </ul>
</nav>
</div>
<div id="content" class="content">
<header>
<h1 class="title">Docker</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org5856dfc">Clean Up</a>
<ul>
<li><a href="#orgcc07912">Remove Unused Images</a></li>
<li><a href="#org710d4b4">Remove All Images</a></li>
</ul>
</li>
<li><a href="#org4a34492">Start docker with SSH</a>
<ul>
<li><a href="#orga7590de">Run Docker with .ssh</a></li>
<li><a href="#org208e20a">In container, start ssh-agent</a></li>
<li><a href="#orgde662a3">Add your keys</a></li>
</ul>
</li>
<li><a href="#org6963499">Run Simple Images</a>
<ul>
<li><a href="#orge724dd6">Python</a></li>
<li><a href="#org4ddb3b7">Golang</a></li>
</ul>
</li>
<li><a href="#orgc9c330c">Rate Limiting</a></li>
</ul>
</div>
</nav>

<div id="outline-container-org5856dfc" class="outline-2">
<h2 id="org5856dfc"><a href="#org5856dfc">Clean Up</a></h2>
<div class="outline-text-2" id="text-org5856dfc">
</div>
<div id="outline-container-orgcc07912" class="outline-3">
<h3 id="orgcc07912"><a href="#orgcc07912">Remove Unused Images</a></h3>
<div class="outline-text-3" id="text-orgcc07912">
<div class="org-src-container">
<pre class="src src-sh">docker system prune
</pre>
</div>

<p>
This removes:
</p>

<ul class="org-ul">
<li>all stopped containers</li>
<li>all networks not used by at least one container</li>
<li>all dangling images</li>
<li>all dangling build cache</li>
</ul>
</div>
</div>

<div id="outline-container-org710d4b4" class="outline-3">
<h3 id="org710d4b4"><a href="#org710d4b4">Remove All Images</a></h3>
<div class="outline-text-3" id="text-org710d4b4">
<div class="org-src-container">
<pre class="src src-sh">docker image rm -f $(docker images -a -q)
</pre>
</div>

<p>
or
</p>

<div class="org-src-container">
<pre class="src src-sh">docker system prune --all
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org4a34492" class="outline-2">
<h2 id="org4a34492"><a href="#org4a34492">Start docker with SSH</a></h2>
<div class="outline-text-2" id="text-org4a34492">
<p>
On linux it should be possible to actually use SSH agent forwarding. See:
<a href="https://gist.github.com/d11wtq/8699521">https://gist.github.com/d11wtq/8699521</a>
</p>

<p>
However, this doesn't work on MacOS. See:
<a href="https://github.com/docker/for-mac/issues/410">https://github.com/docker/for-mac/issues/410</a>
<a href="https://github.com/docker/for-mac/issues/483">https://github.com/docker/for-mac/issues/483</a>
</p>

<p>
But, you can of course just share your .ssh folder and start ssh-agent in the
container.
</p>
</div>

<div id="outline-container-orga7590de" class="outline-3">
<h3 id="orga7590de"><a href="#orga7590de">Run Docker with .ssh</a></h3>
<div class="outline-text-3" id="text-orga7590de">
<p>
This uses a bind mount, which shares the files. Should probably use a volume
to copy the files.
</p>

<div class="org-src-container">
<pre class="src src-sh">docker run --rm -it <span style="color: #98be65;">\</span>
       --name sshtest <span style="color: #98be65;">\</span>
       --mount <span style="color: #dcaeea;">type</span>=bind,<span style="color: #dcaeea;">source</span>=/Users/chrisc/.ssh,<span style="color: #dcaeea;">target</span>=/root/.ssh <span style="color: #98be65;">\</span>
       $<span style="color: #dcaeea;">ImageName</span> <span style="color: #98be65;">\</span>
       /bin/bash
</pre>
</div>
</div>
</div>

<div id="outline-container-org208e20a" class="outline-3">
<h3 id="org208e20a"><a href="#org208e20a">In container, start ssh-agent</a></h3>
<div class="outline-text-3" id="text-org208e20a">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #c678dd;">eval</span> $(ssh-agent -s)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgde662a3" class="outline-3">
<h3 id="orgde662a3"><a href="#orgde662a3">Add your keys</a></h3>
<div class="outline-text-3" id="text-orgde662a3">
<div class="org-src-container">
<pre class="src src-sh">ssh-add ~/.ssh/id_rsa
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org6963499" class="outline-2">
<h2 id="org6963499"><a href="#org6963499">Run Simple Images</a></h2>
<div class="outline-text-2" id="text-org6963499">
<p>
Images I sometimes run for debugging etc.
</p>
</div>

<div id="outline-container-orge724dd6" class="outline-3">
<h3 id="orge724dd6"><a href="#orge724dd6">Python</a></h3>
<div class="outline-text-3" id="text-orge724dd6">
<p>
Run and mount current dir.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #dcaeea;">PROJECT_NAME</span>=$(basename $(<span style="color: #c678dd;">pwd</span>))

docker run --rm <span style="color: #98be65;">\</span>
       --name $<span style="color: #dcaeea;">PROJECT_NAME</span> <span style="color: #98be65;">\</span>
       --mount <span style="color: #dcaeea;">type</span>=bind,<span style="color: #dcaeea;">source</span>=$(<span style="color: #c678dd;">pwd</span>),<span style="color: #dcaeea;">target</span>=/$<span style="color: #dcaeea;">PROJECT_NAME</span> <span style="color: #98be65;">\</span>
       python:3.6.5-slim-stretch /bin/bash
</pre>
</div>
</div>
</div>

<div id="outline-container-org4ddb3b7" class="outline-3">
<h3 id="org4ddb3b7"><a href="#org4ddb3b7">Golang</a></h3>
<div class="outline-text-3" id="text-org4ddb3b7">
<p>
Run golang container for interactive use
</p>

<div class="org-src-container">
<pre class="src src-sh">docker run -it --rm golang:1.14
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgc9c330c" class="outline-2">
<h2 id="orgc9c330c"><a href="#orgc9c330c">Rate Limiting</a></h2>
<div class="outline-text-2" id="text-orgc9c330c">
<div class="org-src-container">
<pre class="src src-sh" id="orga92f321">curl <span style="color: #98be65;">"https://auth.docker.io/token?service=registry.docker.io&amp;scope=repository:ratelimitpreview/test:pull"</span> <span style="color: #98be65;">\</span>
    | jq -r .token
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">curl --head <span style="color: #98be65;">\</span>
     -H <span style="color: #98be65;">"Authorization: Bearer $TOKEN"</span> <span style="color: #98be65;">\</span>
     https://registry-1.docker.io/v2/ratelimitpreview/test/manifests/latest
</pre>
</div>

<pre class="example" id="org591aabd">
HTTP/1.1 200 OK
Content-Length: 2782
Content-Type: application/vnd.docker.distribution.manifest.v1+prettyjws
Docker-Content-Digest: sha256:767a3815c34823b355bed31760d5fa3daca0aec2ce15b217c9cd83229e0e2020
Docker-Distribution-Api-Version: registry/2.0
Etag: "sha256:767a3815c34823b355bed31760d5fa3daca0aec2ce15b217c9cd83229e0e2020"
Date: Mon, 07 Dec 2020 21:19:08 GMT
Strict-Transport-Security: max-age=31536000
RateLimit-Limit: 100;w=21600
RateLimit-Remaining: 100;w=21600

</pre>
</div>
</div>
</div>
</body>
</html>
