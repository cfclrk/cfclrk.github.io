<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Docker</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/static/main.css" />
</head>
<body>
<div id="preamble" class="status">
<nav id="navbar" class="cf">
  <ul class="cf">
    <li class="fl">
      <a href="/">cfclrk</a>
    </li>
    <li class="fr">
      <a href="/articles/home.html">Articles</a>
    </li>
    <li class="fr">
      <a href="/notes/home.html">Notes</a>
    </li>
	<li class="fr">
      <a href="/cloudformation/home.html">CloudFormation</a>
    </li>
  </ul>
</nav>
</div>
<div id="content" class="content">
<header>
<h1 class="title">Docker</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orga5ccccc">Clean Up</a>
<ul>
<li><a href="#orgcb1530f">Remove Unused Images</a></li>
<li><a href="#org4092332">Remove All Images</a></li>
</ul>
</li>
<li><a href="#org5c7dbfc">Start docker with SSH</a>
<ul>
<li><a href="#orge7c2a4d">Run Docker with .ssh</a></li>
<li><a href="#orgeef8f3b">In container, start ssh-agent</a></li>
<li><a href="#orgfbe4cb2">Add your keys</a></li>
</ul>
</li>
<li><a href="#org64d1aea">Run Simple Images</a>
<ul>
<li><a href="#orgb581997">Python</a></li>
<li><a href="#orgcce216d">Golang</a></li>
</ul>
</li>
<li><a href="#orgc6392bf">Rate Limiting</a></li>
</ul>
</div>
</nav>

<div id="outline-container-orga5ccccc" class="outline-2">
<h2 id="orga5ccccc"><a href="#orga5ccccc">Clean Up</a></h2>
<div class="outline-text-2" id="text-orga5ccccc">
</div>
<div id="outline-container-orgcb1530f" class="outline-3">
<h3 id="orgcb1530f"><a href="#orgcb1530f">Remove Unused Images</a></h3>
<div class="outline-text-3" id="text-orgcb1530f">
<div class="org-src-container">
<pre class="src src-sh">docker system prune
</pre>
</div>

<p>
This removes:
</p>

<ul class="org-ul">
<li>all stopped containers</li>
<li>all networks not used by at least one container</li>
<li>all dangling images</li>
<li>all dangling build cache</li>
</ul>
</div>
</div>

<div id="outline-container-org4092332" class="outline-3">
<h3 id="org4092332"><a href="#org4092332">Remove All Images</a></h3>
<div class="outline-text-3" id="text-org4092332">
<div class="org-src-container">
<pre class="src src-sh">docker image rm -f $(docker images -a -q)
</pre>
</div>

<p>
or
</p>

<div class="org-src-container">
<pre class="src src-sh">docker system prune --all
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org5c7dbfc" class="outline-2">
<h2 id="org5c7dbfc"><a href="#org5c7dbfc">Start docker with SSH</a></h2>
<div class="outline-text-2" id="text-org5c7dbfc">
<p>
On linux it should be possible to actually use SSH agent forwarding. See:
<a href="https://gist.github.com/d11wtq/8699521">https://gist.github.com/d11wtq/8699521</a>
</p>

<p>
However, this doesn't work on MacOS. See:
<a href="https://github.com/docker/for-mac/issues/410">https://github.com/docker/for-mac/issues/410</a>
<a href="https://github.com/docker/for-mac/issues/483">https://github.com/docker/for-mac/issues/483</a>
</p>

<p>
But, you can of course just share your .ssh folder and start ssh-agent in the
container.
</p>
</div>

<div id="outline-container-orge7c2a4d" class="outline-3">
<h3 id="orge7c2a4d"><a href="#orge7c2a4d">Run Docker with .ssh</a></h3>
<div class="outline-text-3" id="text-orge7c2a4d">
<p>
This uses a bind mount, which shares the files. Should probably use a volume
to copy the files.
</p>

<div class="org-src-container">
<pre class="src src-sh">docker run --rm -it <span style="color: #98be65;">\</span>
       --name sshtest <span style="color: #98be65;">\</span>
       --mount <span style="color: #dcaeea;">type</span>=bind,<span style="color: #dcaeea;">source</span>=/Users/chrisc/.ssh,<span style="color: #dcaeea;">target</span>=/root/.ssh <span style="color: #98be65;">\</span>
       $<span style="color: #dcaeea;">ImageName</span> <span style="color: #98be65;">\</span>
       /bin/bash
</pre>
</div>
</div>
</div>

<div id="outline-container-orgeef8f3b" class="outline-3">
<h3 id="orgeef8f3b"><a href="#orgeef8f3b">In container, start ssh-agent</a></h3>
<div class="outline-text-3" id="text-orgeef8f3b">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #c678dd;">eval</span> $(ssh-agent -s)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfbe4cb2" class="outline-3">
<h3 id="orgfbe4cb2"><a href="#orgfbe4cb2">Add your keys</a></h3>
<div class="outline-text-3" id="text-orgfbe4cb2">
<div class="org-src-container">
<pre class="src src-sh">ssh-add ~/.ssh/id_rsa
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org64d1aea" class="outline-2">
<h2 id="org64d1aea"><a href="#org64d1aea">Run Simple Images</a></h2>
<div class="outline-text-2" id="text-org64d1aea">
<p>
Images I sometimes run for debugging etc.
</p>
</div>

<div id="outline-container-orgb581997" class="outline-3">
<h3 id="orgb581997"><a href="#orgb581997">Python</a></h3>
<div class="outline-text-3" id="text-orgb581997">
<p>
Run and mount current dir.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #dcaeea;">PROJECT_NAME</span>=$(basename $(<span style="color: #c678dd;">pwd</span>))

docker run --rm <span style="color: #98be65;">\</span>
       --name $<span style="color: #dcaeea;">PROJECT_NAME</span> <span style="color: #98be65;">\</span>
       --mount <span style="color: #dcaeea;">type</span>=bind,<span style="color: #dcaeea;">source</span>=$(<span style="color: #c678dd;">pwd</span>),<span style="color: #dcaeea;">target</span>=/$<span style="color: #dcaeea;">PROJECT_NAME</span> <span style="color: #98be65;">\</span>
       python:3.6.5-slim-stretch /bin/bash
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcce216d" class="outline-3">
<h3 id="orgcce216d"><a href="#orgcce216d">Golang</a></h3>
<div class="outline-text-3" id="text-orgcce216d">
<p>
Run golang container for interactive use
</p>

<div class="org-src-container">
<pre class="src src-sh">docker run -it --rm golang:1.14
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgc6392bf" class="outline-2">
<h2 id="orgc6392bf"><a href="#orgc6392bf">Rate Limiting</a></h2>
<div class="outline-text-2" id="text-orgc6392bf">
<div class="org-src-container">
<pre class="src src-sh" id="orgdb3b80e">curl <span style="color: #98be65;">"https://auth.docker.io/token?service=registry.docker.io&amp;scope=repository:ratelimitpreview/test:pull"</span> <span style="color: #98be65;">\</span>
    | jq -r .token
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">curl --head <span style="color: #98be65;">\</span>
     -H <span style="color: #98be65;">"Authorization: Bearer $TOKEN"</span> <span style="color: #98be65;">\</span>
     https://registry-1.docker.io/v2/ratelimitpreview/test/manifests/latest
</pre>
</div>

<pre class="example" id="orgabcda43">
HTTP/1.1 200 OK
Content-Length: 2782
Content-Type: application/vnd.docker.distribution.manifest.v1+prettyjws
Docker-Content-Digest: sha256:767a3815c34823b355bed31760d5fa3daca0aec2ce15b217c9cd83229e0e2020
Docker-Distribution-Api-Version: registry/2.0
Etag: "sha256:767a3815c34823b355bed31760d5fa3daca0aec2ce15b217c9cd83229e0e2020"
Date: Mon, 07 Dec 2020 21:19:08 GMT
Strict-Transport-Security: max-age=31536000
RateLimit-Limit: 100;w=21600
RateLimit-Remaining: 100;w=21600

</pre>
</div>
</div>
</div>
</body>
</html>
