<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Emacs Projectile in a Monorepo</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/static/main.css" />
</head>
<body>
<div id="preamble" class="status">
<nav id="navbar" class="cf">
  <ul class="cf">
    <li class="fl">
      <a href="/">cfclrk</a>
    </li>
    <li class="fr">
      <a href="/articles/home.html">Articles</a>
    </li>
    <li class="fr">
      <a href="/notes/home.html">Notes</a>
    </li>
	<li class="fr">
      <a href="/cloudformation/home.html">CloudFormation</a>
    </li>
  </ul>
</nav>
</div>
<div id="content" class="content">
<header>
<h1 class="title">Emacs Projectile in a Monorepo</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgad67b2b">Two Kinds of Monorepos</a></li>
<li><a href="#org00c90ad">Example of the Problem</a></li>
<li><a href="#orgc84f9c5">About Projectile Project Detection</a></li>
<li><a href="#org8cc68d2">Updating <code>projectile-project-root-files-bottom-up</code></a></li>
<li><a href="#solution">Solution</a></li>
<li><a href="#orgc95fa59">Test</a>
<ul>
<li><a href="#org320ecfc">Go</a></li>
<li><a href="#org60dd335">Python</a></li>
<li><a href="#org1a4aece">Force Root Higher</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<p>
In monorepos, <a href="https://docs.projectile.mx/projectile/index.html">Projectile</a> determines the project root to be the <i>monorepo</i>, not
the subproject that you're in. In this article I update Projectile to instead
prioritize the most specific project it can find.
</p>

<p>
To jump to the solution, go to <a href="#solution">Solution</a>.
</p>

<div id="outline-container-orgad67b2b" class="outline-2">
<h2 id="orgad67b2b"><a href="#orgad67b2b">Two Kinds of Monorepos</a></h2>
<div class="outline-text-2" id="text-orgad67b2b">
<p>
I've seen two kinds of monorepos:
</p>

<ol class="org-ol">
<li><p>
A single git repository to hold several, self-contained projects.
</p>

<p>
In this case, the repo is basically a dumping ground for smaller projects.
The motivation here is to stave off an explosion of small repositories, and
to collect issues and PRs in one place where a team can review them.
</p></li>

<li><p>
A single git repository with common libraries and multiple independently
deployable services.
</p>

<p>
This is what the term "monorepo" is supposed to connote - a single commit
describes a working version of several services that may need to work
together and share code.
</p></li>
</ol>

<p>
Always in case 1, and sometimes in case 2, I would rather projectile consider
a subproject as a "project root". One could still use Projectile on the whole
monorepo by navigating to a file at the root of the monorepo.
</p>
</div>
</div>

<div id="outline-container-org00c90ad" class="outline-2">
<h2 id="org00c90ad"><a href="#org00c90ad">Example of the Problem</a></h2>
<div class="outline-text-2" id="text-org00c90ad">
<p>
Consider the following monorepo:
</p>

<div class="org-src-container">
<pre class="src src-sh">tree -F -a /tmp/repo
</pre>
</div>

<p>
Now when I open a file in <code>go/projectA</code>, Projectile says that the project root
is the monorepo:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(let ((default-directory "/tmp/repo/go/projectA"))
  (projectile-project-root))
</pre>
</div>

<p>
(Don't worry about the <code>/private/</code> &#x2013; it's because MacOS symlinks <code>/tmp</code> →
<code>/private/tmp</code>).
</p>

<p>
I <i>want</i> Projectile to say that the project root is the Go subject:
<code>/tmp/repo/go/projectA</code>. But alas, Projectile instead found the monorepo root:
<code>/tmp/repo/</code>.
</p>

<p>
How does projectile determine that project root?
</p>
</div>
</div>

<div id="outline-container-orgc84f9c5" class="outline-2">
<h2 id="orgc84f9c5"><a href="#orgc84f9c5">About Projectile Project Detection</a></h2>
<div class="outline-text-2" id="text-orgc84f9c5">
<p>
The relevant documentation is here: <a href="https://docs.projectile.mx/projectile/projects.html#customizing-project-detection">Customizing Project Detection</a>. Projectile
has a few strategies for finding a project root, and it tries each strategy
until one returns a result. The order is defined by this variable:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">projectile-project-root-functions
</pre>
</div>

<p>
In our example, the function <code>projectile-root-bottom-up</code> is the culprit. We
can try it out interactively:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(projectile-root-bottom-up "/tmp/repo/go/projectA")
</pre>
</div>

<p>
Yup &#x2013; it found the monorepo, not the subproject. To understand why this is,
let's look at <a href="https://github.com/bbatsov/projectile/blob/271007c6611fcb08ddd326d7de9727c2ad5ef265/projectile.el#L1242-L1251">the source</a>! Here it is:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(defun projectile-root-bottom-up (dir &amp;optional list)
  "Identify a project root in DIR by bottom-up search for files in LIST.
If LIST is nil, use `projectile-project-root-files-bottom-up' instead.
Return the first (bottommost) matched directory or nil if not found."
  (projectile-locate-dominating-file
   dir
   (lambda (directory)
     (let ((files (mapcar (lambda (file) (expand-file-name file directory))
                          (or list projectile-project-root-files-bottom-up))))
       (cl-some (lambda (file) (and file (file-exists-p file))) files)))))
</pre>
</div>

<p>
In regular words, this function starts at the current directory and looks for
any of the marker files in the variable
<code>projectile-project-root-files-bottom-up</code>. If none exist in the current
directory, go up one directory, etc.
</p>

<p>
And what are these "marker files"?
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">projectile-project-root-files-bottom-up
</pre>
</div>

<p>
So, assuming we're somewhere in our monorepo, Projectile starts by looking for
any of those files between the current directory and root.
</p>

<p>
To drive this point home, say we append <code>go.mod</code> to that list of marker files:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(setq projectile-project-root-files-bottom-up
      '(".git" ".hg" ".fslckout"
        "_FOSSIL_" ".bzr" "_darcs" "go.mod"))
</pre>
</div>

<p>
Projectile still won't find our Go subproject, because <code>.git</code> comes earlier in
the list of marker files.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(projectile-root-bottom-up "/tmp/repo/go/projectA")
</pre>
</div>

<p>
That works! So we just need to update
<code>projectile-project-root-files-bottom-up</code>.
</p>
</div>
</div>

<div id="outline-container-org8cc68d2" class="outline-2">
<h2 id="org8cc68d2"><a href="#org8cc68d2">Updating <code>projectile-project-root-files-bottom-up</code></a></h2>
<div class="outline-text-2" id="text-org8cc68d2">
<p>
The problem is:
</p>

<blockquote>
<p>
The variable <code>projectile-project-root-files-bottom-up</code> doesn't have <code>go.mod</code>
or <code>setup.py</code> in it.
</p>
</blockquote>

<p>
We just need to add <code>setup.py</code> and <code>go.mod</code> to the list of marker files.
While we're at it, let's add every other filename that indicates a project
root. Projectile already has a variable for this, documented in <a href="https://docs.projectile.mx/projectile/projects.html#file-markers">File markers</a>:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">projectile-project-root-files
</pre>
</div>

<p>
Decent start, but it doesn't have <code>go.mod</code>, so we should add that. Might as
well also add all the files in <code>projectile-project-root-files-bottom-up</code>
(which has <code>.git</code>, etc).
</p>

<p>
So the solution is&#x2026;
</p>
</div>
</div>

<div id="outline-container-solution" class="outline-2">
<h2 id="solution"><a href="#solution">Solution</a></h2>
<div class="outline-text-2" id="text-solution">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(setq projectile-project-root-files-bottom-up
  (-concat
   '("go.mod")
   projectile-project-root-files-bottom-up
   projectile-project-root-files))
</pre>
</div>

<p>
That creates a pretty complete list of marker files that can indicate project
roots.
</p>
</div>
</div>

<div id="outline-container-orgc95fa59" class="outline-2">
<h2 id="orgc95fa59"><a href="#orgc95fa59">Test</a></h2>
<div class="outline-text-2" id="text-orgc95fa59">
<p>
After setting the variable above, let's see what Projectile says the project
roots are for our monorepo.
</p>
</div>

<div id="outline-container-org320ecfc" class="outline-3">
<h3 id="org320ecfc"><a href="#org320ecfc">Go</a></h3>
<div class="outline-text-3" id="text-org320ecfc">
<p>
Can we correctly identify a Go project?
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(let ((default-directory "/tmp/repo/go/projectA"))
  (projectile-project-root))
</pre>
</div>

<p>
✔ Works!
</p>
</div>
</div>

<div id="outline-container-org60dd335" class="outline-3">
<h3 id="org60dd335"><a href="#org60dd335">Python</a></h3>
<div class="outline-text-3" id="text-org60dd335">
<p>
Can we correctly identify a Python project?
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(let ((default-directory "/tmp/repo/python/projectC"))
  (projectile-project-root))
</pre>
</div>

<p>
✔ Works!
</p>
</div>
</div>

<div id="outline-container-org1a4aece" class="outline-3">
<h3 id="org1a4aece"><a href="#org1a4aece">Force Root Higher</a></h3>
<div class="outline-text-3" id="text-org1a4aece">
<p>
Can we force the project root to a higher level by creating a <code>.projectile</code>
file?
</p>

<div class="org-src-container">
<pre class="src src-sh">touch /tmp/repo/.projectile
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(let ((default-directory "/tmp/repo/go/projectA"))
  (projectile-project-root))
</pre>
</div>

<p>
✔ Works!
</p>
</div>
</div>
</div>
</div>
</body>
</html>